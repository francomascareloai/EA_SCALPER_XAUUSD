//@version=5
indicator(title='RSI - Divergences - Stoch BY LEO', shorttitle='RSI Div Stoch by LEO', overlay=false)
len = input.int(14, minval=1, title='RSI Length')
ob = input.int(defval=70, title='Overbought', minval=0, maxval=100)
os = input.int(defval=30, title='Oversold', minval=0, maxval=100)
omid = input.int(defval=50, title='Midline value', minval=0, maxval=100)
omidh = input(defval=false, title='Hide midline')

// RSI code
rsi = ta.rsi(close, len)
band1 = hline(ob)
band0 = hline(os)
band3 = hline(omid, color=color.new(color.black, omidh ? 100 : 80))

// Niveles adicionales
level10 = hline(10, "Level 10", color=color.lime, linestyle=hline.style_dashed,linewidth = 2)
level15 = hline(15, "Level 15", color=color.lime, linestyle=hline.style_dashed,linewidth = 2)
level85 = hline(85, "Level 85", color=color.lime, linestyle=hline.style_dashed,linewidth = 2)
level90 = hline(90, "Level 90", color=color.lime, linestyle=hline.style_dashed,linewidth = 2)

plot(rsi, color=rsi > ob or rsi < os ? color.new(color.red, 0) : color.new(color.black, 0))
//fill(band3, band1, color=color.new(color.lime, 96))
//fill(band0, band3, color=color.new(color.red, 96))

// EMA de 5 periodos del precio
ema5 = ta.ema(close, 5)

// Normalizar la EMA al rango 0-100
min_val = ta.lowest(ema5, 100)
max_val = ta.highest(ema5, 100)
normalized_ema5 = (ema5 - min_val) / (max_val - min_val) * 100

// Plotear la EMA normalizada
plot(normalized_ema5, title="Normalized EMA 5", color=color.lime, linewidth=2)

// DIVS code
piv = input(false, 'Hide pivots?')
shrt = input(false, 'Shorter labels?')
hidel = input(false, 'Hide labels and color background')
xbars = input.int(defval=90, title='Div lookback period (bars)?', minval=1)
hb = math.abs(ta.highestbars(rsi, xbars))  // Finds bar with highest value in last X bars
lb = math.abs(ta.lowestbars(rsi, xbars))  // Finds bar with lowest value in last X bars

// Defining variable values, mandatory in Pine 3
max = float(na)
max_rsi = float(na)
min = float(na)
min_rsi = float(na)
pivoth = bool(na)
pivotl = bool(na)
divbear = bool(na)
divbull = bool(na)

// If bar with lowest / highest is current bar, use its value
max := hb == 0 ? close : na(max[1]) ? close : max[1]
max_rsi := hb == 0 ? rsi : na(max_rsi[1]) ? rsi : max_rsi[1]
min := lb == 0 ? close : na(min[1]) ? close : min[1]
min_rsi := lb == 0 ? rsi : na(min_rsi[1]) ? rsi : min_rsi[1]

// Compare high of current bar being examined with previous bar's high
// If curr bar high is higher than the max bar high in the lookback window range
if close > max  // we have a new high
    max := close  // change variable "max" to use current bar's high value
    max
if rsi > max_rsi  // we have a new high
    max_rsi := rsi  // change variable "max_rsi" to use current bar's RSI value
    max_rsi
if close < min  // we have a new low
    min := close  // change variable "min" to use current bar's low value
    min
if rsi < min_rsi  // we have a new low
    min_rsi := rsi  // change variable "min_rsi" to use current bar's RSI value
    min_rsi

// Finds pivot point with at least 2 right candles with lower value
pivoth := max_rsi == max_rsi[2] and max_rsi[2] != max_rsi[3] ? true : na
pivotl := min_rsi == min_rsi[2] and min_rsi[2] != min_rsi[3] ? true : na

// Detects divergences between price and indicator with 1 candle delay so it filters out repeating divergences
if max[1] > max[2] and rsi[1] < max_rsi and rsi <= rsi[1]
    divbear := true
    divbear
if min[1] < min[2] and rsi[1] > min_rsi and rsi >= rsi[1]
    divbull := true
    divbull

// Alerts
alertcondition(divbear, title='Bear div', message='Bear div')
alertcondition(divbull, title='Bull div', message='Bull div')
alertcondition(pivoth, title='Pivot high', message='Pivot high')
alertcondition(pivotl, title='Pivot low', message='Pivot low')

// Plots divergences and pivots with offset
l = divbear ? label.new(bar_index - 1, rsi[1] + 1, 'BEAR', color=color.red, textcolor=color.white, style=label.style_label_down, yloc=yloc.price, size=size.small) : divbull ? label.new(bar_index - 1, rsi[1] - 1, 'BULL', color=color.green, textcolor=color.white, style=label.style_label_up, yloc=yloc.price, size=size.small) : pivoth ? label.new(bar_index - 2, max_rsi + 1, 'PIVOT', color=color.blue, textcolor=color.white, style=label.style_label_down, yloc=yloc.price, size=size.small) : pivotl ? label.new(bar_index - 2, min_rsi - 1, 'PIVOT', color=color.blue, textcolor=color.white, style=label.style_label_up, yloc=yloc.price, size=size.small) : na

// Shorter labels
if shrt
    label.set_text(l, na)
// Hides pivots or labels
if piv and (pivoth or pivotl) or hidel
    label.delete(l)
// Colors indicator background
//bgcolor(hidel ? divbear ? color.new(color.red, 50) : divbull ? color.new(color.green, 50) : na : na, offset=-1, transp=90)
//bgcolor(hidel ? piv ? na : pivoth or pivotl ? color.new(color.blue, 50) : na : na, offset=-2, transp=90)

//////////////////////////////////
// Stochastic Oscillator by leo
//////////////////////////////////

// 1er Stochastic Oscillator
// Input parameters
K = input.int(15, minval=1, title="K Length")
D = input.int(3, minval=1, title="D Length")
smooth = input.int(5, minval=1, title="Smoothing")

// Calculate highest high and lowest low
hh = ta.highest(close, K)
ll = ta.lowest(close, K)

// Calculate %K
k = ta.sma(((close - ll) / (hh - ll)) * 100, smooth)

// Calculate %D
d = ta.sma(k, D)

// Plot %K and %D
plot(k, color=#21f3f3, title="%K")
plot(d, color=color.red, title="%D")

// 2do Stochastic Oscillator
// Input parameters
K2 = input.int(32, minval=1, title="K2 Length")
D2 = input.int(3, minval=1, title="D2 Length")
smooth2 = input.int(5, minval=1, title="Smoothing2")

// Calculate highest high and lowest low
hh2 = ta.highest(close, K2)
ll2 = ta.lowest(close, K2)

// Calculate %K
k2 = ta.sma(((close - ll2) / (hh - ll2)) * 100, smooth2)

// Calculate %D
d2 = ta.sma(k2, D2)

// Plot %K and %D
plot(k2, color=color.orange, title="%K2")
plot(d2, color=color.gray, title="%D2")

// 3er Stochastic Oscillator
// Input parameters
K3 = input.int(50, minval=1, title="K3 Length")
D3 = input.int(3, minval=1, title="D3 Length")
smooth3 = input.int(5, minval=1, title="Smoothing3")

// Calculate highest high and lowest low
hh3 = ta.highest(close, K3)
ll3 = ta.lowest(close, K3)

// Calculate %K
k3 = ta.sma(((close - ll3) / (hh - ll3)) * 100, smooth3)

// Calculate %D
d3 = ta.sma(k3, D3)

// Plot %K and %D
plot(k3, color=color.blue, title="%K3")
plot(d3, color=color.maroon, title="%D3")
