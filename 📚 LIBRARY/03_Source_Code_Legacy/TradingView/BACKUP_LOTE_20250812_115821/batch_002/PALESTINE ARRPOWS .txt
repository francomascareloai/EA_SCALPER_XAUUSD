//@version=6
indicator("Palestine Arrow - ALTERNATING SIGNALS", overlay=true)

// Input parameters
length = input.int(20, "Keltner Channel Length", minval=1)
mult = input.float(2.0, "Keltner Channel Multiplier", minval=0.1, step=0.1)
ema_period = input.int(20, "EMA Period", minval=1)
atr_period = input.int(14, "ATR Period", minval=1)

// Telegram channel toggle
show_telegram = input.bool(true, "ðŸ“± Show Telegram Channel Info", group="Contact Info")

basis = ta.sma(close, length)
range_sma = ta.sma(ta.tr, length)
upper = basis + range_sma * mult
lower = basis - range_sma * mult

ema = ta.ema(close, ema_period)
atr = ta.atr(atr_period)

// Basic signal detection
basic_buy = ta.crossover(close, lower)
basic_sell = ta.crossunder(close, upper)

// ALTERNATING SIGNAL LOGIC - No consecutive signals
var int last_signal = 0  // 0 = none, 1 = buy, -1 = sell

// Only allow buy if last signal was sell (or no signal)
buy_signal = basic_buy and last_signal != 1

// Only allow sell if last signal was buy (or no signal)
sell_signal = basic_sell and last_signal != -1

// Update last signal state
if buy_signal
    last_signal := 1
else if sell_signal
    last_signal := -1

// Plot channels
plot(upper, "Upper", color=color.blue)
plot(basis, "Basis", color=color.gray)
plot(lower, "Lower", color=color.blue)
plot(ema, "EMA", color=color.orange)

// MEDIUM-SIZED arrows that don't detach
plotchar(buy_signal, "Buy Arrow", "â–²", location.belowbar, color.lime, size=size.normal)
plotchar(sell_signal, "Sell Arrow", "â–¼", location.abovebar, color.red, size=size.normal)

// Medium emoji arrows for extra visibility
plotchar(buy_signal, "Buy Arrow 2", "ðŸ”º", location.belowbar, color.green, size=size.small)
plotchar(sell_signal, "Sell Arrow 2", "ðŸ”»", location.abovebar, color.red, size=size.small)

// Small text labels
plotchar(buy_signal, "Buy Text", "BUY", location.belowbar, color.white, size=size.tiny)
plotchar(sell_signal, "Sell Text", "SELL", location.abovebar, color.white, size=size.tiny)

// Background colors for extra confirmation
bgcolor(buy_signal ? color.new(color.lime, 80) : na)
bgcolor(sell_signal ? color.new(color.red, 80) : na)

// TP levels and Telegram info in table
var table tp_info = table.new(position.top_right, 2, show_telegram ? 8 : 6, bgcolor=color.white, border_width=1)

if barstate.islast
    table.cell(tp_info, 0, 0, "ðŸ‡µðŸ‡¸ Palestine Arrow", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    table.cell(tp_info, 1, 0, "ALTERNATING", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    
    // Show signal state
    signal_state = last_signal == 1 ? "LAST: BUY" : last_signal == -1 ? "LAST: SELL" : "NO SIGNAL"
    signal_color = last_signal == 1 ? color.lime : last_signal == -1 ? color.red : color.gray
    
    table.cell(tp_info, 0, 1, "STATUS", text_color=color.white, bgcolor=signal_color, text_size=size.small)
    table.cell(tp_info, 1, 1, signal_state, text_color=color.white, bgcolor=signal_color, text_size=size.small)
    
    if buy_signal
        table.cell(tp_info, 0, 2, "NEW SIGNAL â–²", text_color=color.white, bgcolor=color.lime, text_size=size.normal)
        table.cell(tp_info, 1, 2, "BUY", text_color=color.white, bgcolor=color.lime, text_size=size.normal)
        table.cell(tp_info, 0, 3, "Entry", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 3, str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)
        table.cell(tp_info, 0, 4, "TP1", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 4, str.tostring(close + atr * 1.5, "#.##"), text_color=color.black, text_size=size.small)
        table.cell(tp_info, 0, 5, "TP2", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 5, str.tostring(close + atr * 3.0, "#.##"), text_color=color.black, text_size=size.small)
    else if sell_signal
        table.cell(tp_info, 0, 2, "NEW SIGNAL â–¼", text_color=color.white, bgcolor=color.red, text_size=size.normal)
        table.cell(tp_info, 1, 2, "SELL", text_color=color.white, bgcolor=color.red, text_size=size.normal)
        table.cell(tp_info, 0, 3, "Entry", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 3, str.tostring(close, "#.##"), text_color=color.black, text_size=size.small)
        table.cell(tp_info, 0, 4, "TP1", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 4, str.tostring(close - atr * 1.5, "#.##"), text_color=color.black, text_size=size.small)
        table.cell(tp_info, 0, 5, "TP2", text_color=color.black, text_size=size.small)
        table.cell(tp_info, 1, 5, str.tostring(close - atr * 3.0, "#.##"), text_color=color.black, text_size=size.small)
    else
        table.cell(tp_info, 0, 2, "WAITING FOR", text_color=color.black, bgcolor=color.gray, text_size=size.normal)
        next_signal = last_signal == 1 ? "SELL SIGNAL" : last_signal == -1 ? "BUY SIGNAL" : "ANY SIGNAL"
        table.cell(tp_info, 1, 2, next_signal, text_color=color.black, bgcolor=color.gray, text_size=size.normal)
        for i = 3 to 5
            table.cell(tp_info, 0, i, "", text_color=color.black, text_size=size.small)
            table.cell(tp_info, 1, i, "", text_color=color.black, text_size=size.small)
    
    // Telegram channel info (if enabled)
    if show_telegram
        table.cell(tp_info, 0, 6, "ðŸ“± TELEGRAM", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(tp_info, 1, 6, "CHANNEL", text_color=color.white, bgcolor=color.blue, text_size=size.small)
        table.cell(tp_info, 0, 7, "Free Forex Tools", text_color=color.black, text_size=size.tiny)
        table.cell(tp_info, 1, 7, "@FreeForextools145", text_color=color.blue, text_size=size.tiny)

// Telegram info table (separate, always visible when enabled)
var table telegram_info = table.new(position.bottom_left, 2, 3, bgcolor=color.white, border_width=2)

if show_telegram and barstate.islast
    table.cell(telegram_info, 0, 0, "ðŸ“±", text_color=color.white, bgcolor=color.blue, text_size=size.large)
    table.cell(telegram_info, 1, 0, "TELEGRAM", text_color=color.white, bgcolor=color.blue, text_size=size.normal)
    table.cell(telegram_info, 0, 1, "Join our", text_color=color.black, text_size=size.small)
    table.cell(telegram_info, 1, 1, "FREE channel", text_color=color.black, text_size=size.small)
    table.cell(telegram_info, 0, 2, "t.me/", text_color=color.blue, text_size=size.tiny)
    table.cell(telegram_info, 1, 2, "FreeForextools145", text_color=color.blue, text_size=size.tiny)

alertcondition(buy_signal, title="Palestine Buy", message="ðŸ‡µðŸ‡¸ ALTERNATING BUY SIGNAL - Join: t.me/FreeForextools145")
alertcondition(sell_signal, title="Palestine Sell", message="ðŸ‡µðŸ‡¸ ALTERNATING SELL SIGNAL - Join: t.me/FreeForextools145")
