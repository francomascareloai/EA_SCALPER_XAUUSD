# Code Block for "Trailing Stop" based on current market price. (Ask / Bid) - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/49021

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Twitter](https://x.com/mql5com)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/49021) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Code Block for "Trailing Stop" based on current market price. (Ask / Bid) - expert for MetaTrader 5

[Hapu Arachchilage Tharindu Lakmal](/en/users/51241974)  |
[English](javascript:void(false);)

[Русский](/ru/code/49021) [中文](/zh/code/49021) [Español](/es/code/49021) [Deutsch](/de/code/49021) [日本語](/ja/code/49021) [Português](/pt/code/49021) [한국어](/ko/code/49021) [Français](/fr/code/49021) [Italiano](/it/code/49021) [Türkçe](/tr/code/49021)

Views:
:   6871

Rating:
:   (5)

Published:
:   4 April 2024, 22:09
:   [Traling Stop (when SL used and Not).mq5](/en/code/download/49021/traling_stop_vwhen_sl_used_and_noth.mq5 "Traling Stop (when SL used and Not).mq5")
    (5.87 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/49021.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

**This code block works if you use either a Stop Loss or Not.**

**Requirements**

* You need to include **"Trade.mqh "** to get access to the **CTrade** class which allows you to work with positions and orders.

```mql5
#include <Trade\Trade.mqh> // <<------------------------------------------ Include this "Trade.mqh" to access the CTrade Class 
```

* You need to set an **input parameter** to adjust the trailing distance as you want. This is not necessary, but for convenient.

```mql5
input double Traling_Step = 3.0;
```

* You need to define instance for **CTrade** class. the name can be any. It would be better to dine it after the **OnInt** event handler.

* Then you need to create an **if statement** to check if there any position has been running at the moment. This statement calls for **Check\_TrailingStop();**function for **every tick**. This important because the EA should trail it **sharp and smooth**. Keep mind to put this statement at the**top of the OnTick event handler** to work properly.

```mql5
//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {
//--- create timer
   EventSetTimer(60);

//---
   return(INIT_SUCCEEDED);
  }


CTrade trade; // <<------------------------------------------ Declare the "CTrade" calss. you can replace "trade" win any name you want
```

```mql5
void OnTick()
  {
   
   if(PositionsTotal() > 0) // calls to trailing stop function for every tick if there is / are positions runing. 
     {
      Check_TralingStop(); 
     } 
     
       
  }
```

* You need to declare a custom function called  **Check\_TrailingStop(); (**in this case**)** to do the rest. You can use any name you want.
* The custom function loops through **all the opened positions** and trail them as your required distance.

```mql5
void Check_TralingStop()
  {
   int totalPositions = PositionsTotal();
   for(int count =0; count < totalPositions; count++)
     {
      ulong TicketNo = PositionGetTicket(count); // Get Position Ticket number using the 'index' of the position.

      if(PositionSelectByTicket(TicketNo)) // Select a position using the ticket number (we already picked the tickt no.)
        {
         if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_BUY) // Check the position Type.
           {
            double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
            double stopLoss  = PositionGetDouble(POSITION_SL);       // <<-------------------Get Position Current Stop Loss
            double takeProfit = PositionGetDouble(POSITION_TP);
            double bidPrice  = SymbolInfoDouble(_Symbol,SYMBOL_BID);
            ulong ticket = PositionGetTicket(count);
            double trailingLevel = NormalizeDouble(bidPrice - (Traling_Step * Point()),_Digits);

            if(stopLoss < openPrice) // No stop loss is true.
              {
               if(bidPrice > openPrice && trailingLevel > openPrice) // Runs only once per position. Sets the first SL.

                  trade.PositionModify(ticket,trailingLevel,takeProfit); // Modify trailing Stop using "CTrade.trade"
              }


            if(bidPrice > openPrice && trailingLevel > stopLoss) // check trailing level is above the previos level.
              {
               trade.PositionModify(ticket,trailingLevel,takeProfit); // Modify trailing Stop using "CTrade.trade"
              }

           }
         if(PositionGetInteger(POSITION_TYPE) == POSITION_TYPE_SELL)
           {
            double openPrice = PositionGetDouble(POSITION_PRICE_OPEN);
            double stopLoss  = PositionGetDouble(POSITION_SL);
            double takeProfit = PositionGetDouble(POSITION_TP);
            double bidPrice  = SymbolInfoDouble(_Symbol,SYMBOL_BID);
            double askPrice  = SymbolInfoDouble(_Symbol,SYMBOL_ASK);
            ulong ticket = PositionGetTicket(count);
            double trailingLevel = NormalizeDouble(askPrice + (Traling_Step * Point()),_Digits);

            if(stopLoss < openPrice) // No stop loss is true.
              {
               if(askPrice < openPrice && trailingLevel < openPrice) // Runs only once per position. Sets the first SL.

                  trade.PositionModify(ticket,trailingLevel,takeProfit); // Modify trailing Stop using "CTrade.trade"
              }

            if(askPrice < openPrice && trailingLevel < stopLoss) // check trailing level is above the previos level.
              {
               trade.PositionModify(ticket,trailingLevel,takeProfit); // Modify trailing Stop using "CTrade.trade"
              }
           }

        }
     }
  }
```

**Last comments |
[Go to discussion](/en/forum/465175)**
(2)

![linfo2](https://c.mql5.com/avatar/2023/4/6438c14d-e2f0.png "linfo2")

**[linfo2](/en/users/neilhazelwood)**
|
9 Apr 2024 at 21:30

Thanks, appears to work on all orders , It may be necessary to add a magic filter ( or not depending on your purpose)

![Christian Edward Bannard](https://c.mql5.com/avatar/2021/4/6078E99A-355C.jpg "Christian Edward Bannard")

**[Christian Edward Bannard](/en/users/traderd)**
|
4 Jun 2024 at 13:55

Your code doesn't work. It triggers the commencement of a trailing SL, though the SL then moves with the price, and doesn't "stop" anything.

Please don't post code snippets like this unless it actually works. Seriously frustrating when newcomers are looking for code examples and find untested code.

[![]()](https://c.mql5.com/3/437/2024-06-04_19-51-22.gif "https://c.mql5.com/3/437/2024-06-04_19-51-22.gif")

![Simple Code for Detect  A  "New Bar or New Candle " Received](https://c.mql5.com/i/code/expert.png)
[Simple Code for Detect A "New Bar or New Candle " Received](/en/code/49018)

This code block detects a New Bar or a New Candle when it has received.

![Logarithmic Moving Average](https://c.mql5.com/i/code/indicator.png)
[Logarithmic Moving Average](/en/code/49019)

Logarithmic Moving Average continuously calculates the logarithmic mean of highest price and lowest price within a period.

![Dominant Candle](https://c.mql5.com/i/code/indicator.png)
[Dominant Candle](/en/code/49126)

Dominant Candle is a a two candlestick set where the wicks intersect each other but body of the candles are either gapped up, gapped down or equal

![Counter Attack Candlestick](https://c.mql5.com/i/code/indicator.png)
[Counter Attack Candlestick](/en/code/49142)

Counter attack candlestick pattern