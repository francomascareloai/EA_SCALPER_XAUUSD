# TimeServerDaylightSavings - script for MetaTrader 5

Source: https://www.mql5.com/en/code/52557

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/52557) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Scripts](https://c.mql5.com/i/code/script.png)

# TimeServerDaylightSavings - script for MetaTrader 5

[Stanislav Korotky](/en/users/marketeer)  |
[English](javascript:void(false);)

[Русский](/ru/code/52557) [中文](/zh/code/52557) [Español](/es/code/52557) [Deutsch](/de/code/52557) [日本語](/ja/code/52557) [Português](/pt/code/52557) [한국어](/ko/code/52557) [Français](/fr/code/52557) [Italiano](/it/code/52557) [Türkçe](/tr/code/52557)

Views:
:   5645

Rating:
:   (7)

Published:
:   5 October 2024, 19:04

Updated:
:   20 November 2024, 15:31
:   \MQL5\Include\MQL5Book\

    [PRTF.mqh](/en/code/download/52557/prtf.mqh "PRTF.mqh")
    (1.49 KB)
    [view](# "view")

    [MqlError.mqh](/en/code/download/52557/mqlerror.mqh "MqlError.mqh")
    (8.53 KB)
    [view](# "view")

    [DateTime.mqh](/en/code/download/52557/datetime.mqh "DateTime.mqh")
    (2.56 KB)
    [view](# "view")

    [TimeServerDST.mqh](/en/code/download/52557/timeserverdst.mqh "TimeServerDST.mqh")
    (15.66 KB)
    [view](# "view")

    [TimeZoneFmt.mqh](/en/code/download/52557/timezonefmt.mqh "TimeZoneFmt.mqh")
    (3.35 KB)
    [view](# "view")

    [TimeZonesHistory.mq5](/en/code/download/52557/timezoneshistory.mq5 "TimeZonesHistory.mq5")
    (4.56 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/52557.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

This script introduces the function *TimeServerDaylightSavings()* that is missing among the built-in ones, which provide only *TimeDaylightSavings()* for local computer. In addition the attached header mqh-file includes some other helpful server-bound time-related functions, in particular allowing you to know if your broker uses DST switches in general.

All this is based on empirical analysis of history of quotes from your broker. The whole idea is described in the algotrading book in the section about [Daylight saving time](/en/book/common/timing/timing_daylight_saving) (DST). In brief, the method analyzes statistics of week opening hours and deduce GMT offsets of your broker. Two distinct maximums in the statistics of the offsets, if they map into adjacent hours, most likely correspond to standard ("winter") and daylight-saving ("summer") time.

Actually this script is a refined and extended version of the script presented in the book. Specifically, the versions since October 2024 include an important bug fix: the opening hours of weekly trading are detected by the US market, which itself is affected by DST switches according to US time zone (EST, UTC-5, standard winter time <--> EDT, UTC-4, daylight saving summer time), this is why it's important to eliminate the effect of US DST to obtain a continuous natural time flow all year round - this is what has been done in the fix. All the credit goes to [amrali](/en/users/amrali).

![Example of week opening hour changes in quotes due to DST switch](https://c.mql5.com/18/156/eurusddst.png "Example of week opening hour changes in quotes due to DST switch")

Please, note that in the Northern and Southern Hemispheres, time zones are adjusted in the opposite direction: in the Northern Hemisphere, 1 hour is added in the "spring" (March or April) and subtracted in the "fall" (October or November), while in the Southern Hemisphere it is the other way around (because they have all the seasons swapped).

Due to specificity of the analysis it's recommended to run the code for the most liquid Forex ticker, which is usually EURUSD.

Here is the API:

```mql5
// Server time zone and DST current information
struct ServerTimeZone  // according to history analysis of week opening hours
{
   int offsetGMT;      // time zone offset in seconds against UTC/GMT for current week
   int offsetDST;      // DST correction in seconds (included in offsetGMT, as per MQL5)
   bool supportDST;    // DST changes are detected in the quotes
};

// Estimate server time zone and DST mode from H1 quotes history
ServerTimeZone TimeServerZone(
  const datetime srvtime = 0,     // by default, current time, but can specify a moment in the past
  const int threshold = THRESHOLD,
  const double lookupYears = 0.0, // by default, all available bars, otherwise 3 year seems enough
  const string symbol = NULL)     // by default, symbol of current chart

// Estimate server time DST mode correction (in seconds)
int TimeServerDaylightSavings(const datetime srvtime = 0,
  const int threshold = THRESHOLD, const double lookupYears = 0.0, const string symbol = NULL);

// Estimate server time zone offset (in seconds)
int TimeServerGMTOffsetHistory(const datetime srvtime = 0,
  const int threshold = THRESHOLD, const double lookupYears = 0.0, const string symbol = NULL);

// Estimate if server is DST-enabled (true/false)
bool TimeServerDaylightSavingsSupported(const datetime srvtime = 0,
  const int threshold = THRESHOLD, const double lookupYears = 0.0, const string symbol = NULL);

// Analogue of TimeGMTOffset() function for trade server, difference in seconds
int TimeServerGMTOffset(); // TimeGMT() - TimeTradeServer()
```

The functions *TimeServerDaylightSavings()*, *TimeServerGMTOffsetHistory()*, *TimeServerDaylightSavingsSupported()* are just wrappers for *TimeServerZone()*, so if you need more than one characteristic it's preferable to use the later one and read values from the struct *ServerTimeZone*.

All these functions take a server time as 1-st argument at which you want to get correspopnding characteristic (in present or in the past). If the server time is left 0 (by default), the result is returned for current moment.

The 2-nd argument threshold allows you to adjust algorithms' sensitivity. By default, it's 52/4  that is a quarter of year of required stats for making decision (detecting time zone without a possible interference of short weeks before/after holidays). On the other hand, this settings prevent prompt detection of ad hoc time zone changes (should your broker decide to do so at some point). You may want to set the threshold to 0 to let  the algorithms detect any changes as soon as possible.

The function *TimeServerGMTOffset()* does not use history analysis but rather calculate offset directly via MQL5 functions (as *TimeGMT() - TimeTradeServer()*).

Please note, that this function uses the same offset notation as MQL5's built-in *TimeGMTOffset()* function, that is positive time zones, such as GMT+3, are denoted by negative offsets, such as -10800, and vice versa. This notation is used by some other programming languages, like JaveScript, but there is also other languages, which denote positive time zones by positive offsets, and negative time zones by negative offsets. Check your algorithms carefully.

The test script outputs all acquired data into the log, for example:

```mql5
1 ~ Built-in functions ~
TimeLocal()=2024.10.05 00:39:01 / ok
TimeCurrent()=2024.10.05 00:38:59 / ok
TimeTradeServer()=2024.10.05 00:39:01 / ok
TimeGMT()=2024.10.04 21:39:01 / ok
TimeGMTOffset()=-10800 / ok
TimeDaylightSavings()=0 / ok
2 ~ Add-on over built-in functions ~
TimeServerGMTOffset()=-10800 / ok
3 ~ Estimation of server TZ with DST based on week opening hours in history ~
TimeServerDaylightSavings()=-3600 / ok
    [offsetGMT] [offsetDST] [supportDST]
[0]      -10800       -3600         true
```

In this case it's detected that the server is currently in DST mode, whereas the local computer is not.

Please, remember that system clocks of the local computer and the server can normally show slightly different times (seconds and even minutes), even if they are in the same time zone. Also note that built-in *TimeTradeServer()* function returns a synthetic ***datetime***: it's the server's time with hourly accuracy, but it inherits intra-hour fractions from the local clock. This is done so in MQL5 to simplify conversions between time zones - *TimeLocal()*, *TimeGMT()* returned in the "local format" as well, and the trade server time.

You can enable detailed print out of the data being analyzed by preprocessor directive:

```mql5
#define PRINT_DST_DETAILS
```

which should be placed in your code before include:

```mql5
#include "TimeServerDST.mqh"
```

Here is an example of details in the log:

```mql5
Got 20023 H1 bars, ~834 days
Week opening hours stats:
30  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0  0 83 54  0
Time Zone changes (UTC±X before/after weekstart):
            [weekstart]    [before] [DSTb] [after] [DSTa]
[0] 2021.07.25 00:00:00 -2147483648  false      -1  false
[1] 2021.11.08 00:00:00           0   true       0  false
[2] 2022.03.14 00:00:00           0  false       0   true
[3] 2022.11.07 00:00:00           0   true       0  false
[4] 2023.03.13 00:00:00           0  false       0   true
[5] 2023.11.06 00:00:00           0   true       0  false
[6] 2024.03.11 00:00:00           0  false       2  false
3 different timezones detected in quotes, 1 DST candidates
Server time offset: UTC+2 STD
TimeServerDaylightSavings()=-3600 / ok
```

Please, feel free to run the script in your environments and post resulting logs in the discussion.

**Updates**

2024.10.10 - bug fix: US DST switches (that interfered into opening hours stats) are eliminated from timeline before main analysis.

2024.10.27 - server time of interest and minimal weekly stats threshold are added as arguments for all functions; *TimeServerGMTOffsetEmpiric()* is renamed to *TimeServerGMTOffsetHistory()*.

2024.10.29 - small bugfix to include requested time into lookup period.

2024.10.30 - fixed DST in TimeZoneChange array; lookup is now performed from srvtime parameter, if it's specified.

2024.11.01 - added an autoadjustement of calculations when applied on precious metals, which can provide more reliable results on weeks during US DST and EU DST schedules are out of sync.

2024.11.04 - refined online detection of DST switch on/off.

2024.11.07 - added caching of time-zone/DST changes for bulk requests on history for indicators or economic events backtesting.

2024.11.08 - caching performance optimized by small code refactoring.

2024.11.16 - 1 hour adjustment for timestamps deduced from metals by amrali.

2024.11.17 - refactoring and fixes by amrali: eliminated cache rebuilds for online requests during weekends, 48h lookahead is added for detection of TZ changes during weekends (with possible DST transition), Sunday 00:00 is used as a boundary for timezones (instead of 1-st bar of a week).

2024.11.20 - default threshold changed to 1 (a balance between prompt detection of time zone changes and elimination of false positives on non-standard weeks such as after holidays); new set of functions added for time formatting, including time zone offsets and DST (look at TimeZoneFmt.mqh); other small refinements.

**Last comments |
[Go to discussion](/en/forum/474213)**
(9)

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
8 Oct 2024 at 01:00

To get correct results with your algo, I think you have to isolate the effect of DST switch in New York (during summer) from the  [server time](/en/docs/dateandtime/timetradeserver "MQL5 documentation: TimeTradeServer function").

So, any discrepancy found in the times of H1 bars of forex weeks on the server will be solely an indication of a DST switch on that server.

I tested that idea by modifying your coder, and it seemed to work nicely.

original code at line 136 in 'TimeServerDST.mqh' file:

```mql5
        // lets analyze the first H1 bar of the trading week
        // find out an hour for the first bar after weekend
        previous = current;
        current = _TimeHour();
        if(previous != current) // keep track of TZ changes
        {
```

modified code:

```mql5
        // lets analyze the first H1 bar of the trading week
        // find out an hour for the first bar after weekend
        previous = current;
        current = _TimeHour();
        //---------------------------------------------------------------------
        if(_TimeMonth() >= 3 && _TimeMonth() <= 11)
        {
          int iYear = _TimeYear();
          MqlDateTime dt1 = {iYear, 03, (14 - (1 + 5*iYear/4) % 7)};  // the second Sunday of March for the US switch
          MqlDateTime dt2 = {iYear, 11, (07 - (1 + 5*iYear/4) % 7)};  // the first Sunday of November for the US switch

          datetime dst_begin = StructToTime(dt1);
          datetime dst_end   = StructToTime(dt2);

          if (array[i] >= dst_begin && array[i] < dst_end)
          {
            current += 1; // isolate (add) the effect of us switch on our server time.
          }
        }
        //---------------------------------------------------------------------
        if(previous != current) // keep track of TZ changes
        {
```

original code at line 220 in 'TimeServerDST.mqh' file:

```mql5
     int utc = HourToUTC(current, DST);
```

modified code:

```mql5
     int utc = HourToUTC(current);
```

Here are the expert logs of running the above modified code on ICMarkets:

```mql5
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    Raw Trading Ltd ⁞ ICMarketsSC-Demo
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    ¹ ⁞ Built-in functions ⁞
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeLocal()=2024.10.08 01:42:31 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeCurrent()=2024.10.08 01:42:31 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeTradeServer()=2024.10.08 01:42:31 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeGMT()=2024.10.07 22:42:31 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeGMTOffset()=-10800 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeDaylightSavings()=0 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    ² ⁞ Add-on over built-in functions ⁞
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    TimeServerGMTOffset()=-10800 / ok
2024.10.08 01:42:31.844 TimeZonesHistory (EURUSD,H1)    ³ ⁞ Estimation of server TZ with DST based on week opening hours in history ⁞
2024.10.08 01:42:31.845 TimeZonesHistory (EURUSD,H1)    TimeServerDaylightSavings()=-3600 / ok
2024.10.08 01:42:31.845 TimeZonesHistory (EURUSD,H1)        [offsetGMT] [offsetDST] [supportDST]
2024.10.08 01:42:31.845 TimeZonesHistory (EURUSD,H1)    [0]      -10800       -3600         true
```

the modified header is in the attachments.

Best regards,

![Stanislav Korotky](https://c.mql5.com/avatar/2010/10/4CA7CFA0-1F0C.jpg "Stanislav Korotky")

**[Stanislav Korotky](/en/users/marketeer)**
|
8 Oct 2024 at 16:52

**amrali [#](/en/forum/474213#comment_54774842):**

Here are the expert logs of running the above modified code on ICMarkets:

the modified header is in the attachments.

Cool, thank you. I'll check it.

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
9 Oct 2024 at 21:41

a minor correction to avoid "[array out of range](https://www.mql5.com/en/articles/2555 "Article: The checks a trading robot must pass before publication in the Market ")" error in "TimeServerDST\_amr":

```mql5
          if (array[i] >= dst_begin && array[i] < dst_end)
          {
            //current += 1; // isolate (add) the effect of us switch on our server time.
            current = WRAP24(current + 1);
          }
```

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
13 Oct 2024 at 08:23

Thanks for the updated script. It works well with my brokers.

![Stanislav Korotky](https://c.mql5.com/avatar/2010/10/4CA7CFA0-1F0C.jpg "Stanislav Korotky")

**[Stanislav Korotky](/en/users/marketeer)**
|
10 Nov 2024 at 19:56

This library is now used in [CalendarCSVForDates.mq5](/en/code/52977) and [CalendarMonitorCachedTZ.mq5](/en/code/53393).

![Custom crosshair cursor with synchronization](https://c.mql5.com/i/code/indicator.png)
[Custom crosshair cursor with synchronization](/en/code/52538)

Synchronized custom crosshair indicator showing price and (server/local) time.

![Perfect Seconds Chart](https://c.mql5.com/i/code/indicator.png)
[Perfect Seconds Chart](/en/code/52527)

Perfect Seconds chart indicator allows you to convert minute candles of live data into seconds.
1. Choose any number of seconds to close a bar with accurate time.
2. This is Live OHLC rates based data, It works even if ticks are not available.
3. No external DLL required, it works smoothly on VPS
4. Fast and optimized code
5. Supports Crypto Pairs such as BInance, Kucoin and all other exchanges where Futures live chart can be converted into seconds easily.
6. Support all type of symbols such as Gold and Forex pairs.
7. Options to delete symbol and rates.

![Simplest Logger class for MetaTrader 5](https://c.mql5.com/i/code/library.png)
[Simplest Logger class for MetaTrader 5](/en/code/52741)

The simplest class for logging in MetaTrader 5 with support for levels, message format, include and exclude filters on substrings.

![Script to extract Candlesticks data from all time frames to CSV.](https://c.mql5.com/i/code/script.png)
[Script to extract Candlesticks data from all time frames to CSV.](/en/code/52766)

This MQL5 script exports candlestick data for various timeframes into a CSV file, capturing essential market information like open, high, low, and close prices. It analyzes each candlestick's characteristics, including body and wick sizes, while calculating additional metrics such as candle gaps. After processing the latest 21 bars, it notifies the user upon successful data export.