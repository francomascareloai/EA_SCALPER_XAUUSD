# Sequence - библиотека для MetaTrader 5

Source: https://www.mql5.com/en/code/31446

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/ru/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Советники](/ru/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Индикаторы](/ru/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Скрипты](/ru/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Библиотеки](/ru/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/ru/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Советники](/ru/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Индикаторы](/ru/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Скрипты](/ru/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Библиотеки](/ru/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Хранилище](/ru/code/storage)

Смотри, [как бесплатно скачать](https://youtu.be/vlobaVbugzQ?list=PLltlMLQ7OLeJtk0k1TFjU6eHAwqfQpcFs) роботов

Ищи нас в [Facebook](https://www.facebook.com/mql5.community/)!  
 Ставь лайки и следи за новостями

Интересный скрипт?  
Поставь на него [ссылку](/ru/code/31446) - пусть другие тоже оценят

Понравился скрипт?  
Оцени его работу в терминале [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download)

[в карман](#pocket "Через Карман вы можете вставить полное описание этого содержимого в редактор сообщений")

![Библиотеки](https://c.mql5.com/i/code/library.png)

# Sequence - библиотека для MetaTrader 5

[fxsaber](/ru/users/fxsaber)

Просмотров:
:   2404

Рейтинг:
:   (13)

Опубликован:
:   12 октября 2020, 20:06

Обновлен:
:   12 ноября 2022, 12:38
:   \MQL5\Experts\

    [Sequence\_Example.mq5](/ru/code/download/31446/sequence_example.mq5 "Sequence_Example.mq5")
    (0.89 KB)
    [просмотр](# "просмотр")

    \MQL5\Include\fxsaber\

    [Sequence.mqh](/ru/code/download/31446/sequence.mqh "Sequence.mqh")
    (3.03 KB)
    [просмотр](# "просмотр")

    [Загрузить ZIP](/ru/code/download/31446.zip "Загрузить все вложения в одном ZIP-архиве") [Как загрузить код из редактора MetaEditor](https://www.metatrader5.com/ru/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Язык торговых стратегий для клиентского терминала MetaTrader 5](https://c.mql5.com/i/registerlandings/logo-2.png)

    Вы упускаете торговые возможности:

    * Бесплатные приложения для трейдинга
    * 8 000+ сигналов для копирования
    * Экономические новости для анализа финансовых рынков

    Регистрация
    Вход

    латиницей и без пробелов

    пароль придет на email

    Произошла ошибка

    * [Войти через Google](https://www.mql5.com/ru/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    Вы принимаете [политику сайта](/ru/about/privacy) и [условия использования](/ru/about/terms)

    Если у вас нет учетной записи, [зарегистрируйтесь](https://www.mql5.com/ru/auth_register)

    Для авторизации и пользования сайтом MQL5.com необходимо разрешить использование файлов Сookie.

    Пожалуйста, включите в вашем браузере данную настройку, иначе вы не сможете авторизоваться.

     

    [Забыли логин/пароль?](https://www.mql5.com/ru/auth_forgotten?return=popup)

    * [Войти через Google](https://www.mql5.com/ru/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Фриланс](https://c.mql5.com/i/code/icon_freelance.svg)
    Нужен робот или индикатор на основе этого кода? Закажите его на бирже фрилансеров
    [Перейти на биржу](/ru/job/new "Перейти на биржу")

При одновременной работе нескольких советников бывает полезно некоторые расчеты производить не параллельно, а последовательно. Данная библиотека реализует такую возможность в удобном для использования виде.

### Пример.

```mql5
#include <fxsaber\Sequence.mqh> // Последовательный запуск расчетов в параллельно-выполняющихся программах

int OnInit()
{
  SEQUENCE Sequence; // Последовательный запуск расчетов
  
  if (Sequence.Init()) // Дожидаемся освобождения вычислительных ресурсов.
  {
    Sleep(1000); // Тяжелые расчеты.
    Print((string)ChartID() + " - " + __FUNCTION__);
  }
  
  return(!EventSetMillisecondTimer(100));
}

void OnTimer()
{
  static datetime PrevCalcTime = 0;
  static int Amount = 0; // Количество расчетов

  SEQUENCE Sequence; // Последовательный запуск расчетов
    
  if ((TimeLocal() - PrevCalcTime >= 10) && // Если пришло время делать расчеты
      Sequence.IsFree())                    // и вычислительные ресурсы свободны
  {
    PrevCalcTime = TimeLocal();
    
    Sleep(1000); // Тяжелые расчеты.
    Print((string)ChartID() + " - " + __FUNCTION__ + ": " + (string)Amount++);
  }
}
```

Запустив этот советник на нескольких чартах, можно будет видеть (в Журнале), что все они выполняются последовательно.

### Сценарии использования.

* Автооптимизация в нескольких запущенных советниках.
* Одновременный запуск нескольких советников (например, при запуске Терминала).
* Снижение нагрузки VPS при работе нескольких советников.

### Особенности.

> Библиотека использует графики, на которых работают соответствующие программы. Поэтому не будет работать с Индикаторами без чартов и Сервисами.

**Последние комментарии |
[Перейти к обсуждению на форуме трейдеров](/ru/forum/353249)**
(12)

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
13 окт. 2020 в 16:27

**Stanislav Korotky:**  

Когда экспертов будет много и все эти временные задержки сложатся непредсказуемым образом, гарантировать захват ресурса в конкретном экземпляре будет невозможно.

Понимаю, о чем речь. Похоже, описание неоднозначное. Нужен был механизм определения наличия свободного ресурса с запретом использования его другим. С этим библа справляется на ура. А вот последовательность все же ложится на плечи автора советника. Универсального решения либо нет, либо оно очень громоздкое: когда на решение уходит больше времени, чем требуется всем частным применениям.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
14 окт. 2020 в 14:42

Совмещение с FileSelectDialog, чтобы при запуске Терминала не возникала каша из диалоговых окон.

```mql5
#include <fxsaber\Sequence.mqh> // https://www.mql5.com/ru/code/31446

void OnInit()
{
  SEQUENCE Sequence; // Последовательный запуск расчетов
  
  if (Sequence.Init()) // Дожидаемся освобождения вычислительных ресурсов.
  {
    string FileNames[];

    ChartSetInteger(0, CHART_BRING_TO_TOP, 0, true);
    ChartGetInteger(0, CHART_WINDOW_HANDLE); // Сдвинули очередь.
    
    FileSelectDialog(MQLInfoString(MQL_PROGRAM_NAME) + " " + _Symbol + " " + EnumToString(_Period),
                     NULL, NULL, FSD_ALLOW_MULTISELECT | FSD_FILE_MUST_EXIST, FileNames, NULL);
    ArrayPrint(FileNames);
  }
}
```

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
25 июл. 2021 в 11:48

Иногда требуется провести тяжелый расчеты сразу на нескольких запущенных советниках. Такой параллельный расчет способен убить торговлю не только на своем терминале, но и на параллельно работающих. Причина - критическая нагрузка CPU.

Чтобы этого не происходило, желательно делать подобные расчеты последовательно. Ниже схема, как это можно сделать.

```mql5
// Пример последовательных тяжелых расчетов без прерывания остальных действий советника.

#include <fxsaber\Sequence.mqh> // https://www.mql5.com/ru/code/31446

// Тяжелый расчет.
void Calculate()
{
  Print((string)ChartID() + " - Run.");
  Sleep(1000);
  Print((string)ChartID() + " - Done.");
}

void OnChartEvent( const int id, const long& lparam, const double& dparam, const string& sparam )
{
  switch (id)
  {
    case CHARTEVENT_KEYDOWN: // Если нажали на клавишу - отдаем приказы на расчет.
      Print(lparam);
      Print("Calculate All!");
      
      for (long Chart = ::ChartFirst(); Chart != -1; Chart = ::ChartNext(Chart))      
        EventChartCustom(Chart, 0, 0, 0, NULL);
      
      break;
    
    case CHARTEVENT_CUSTOM: // Если пришел приказ на расчет.
    {
      SEQUENCE Sequence; // Последовательный запуск расчетов
      
      if (Sequence.IsFree()) // Вычислительные ресурсы свободны
        Calculate();         // Считаем
      else
      {
        Sleep(0); // https://www.mql5.com/ru/forum/170952/page207#comment_23627280
        
        EventChartCustom(0, (ushort)(id - CHARTEVENT_CUSTOM), lparam, dparam, sparam); // Повторяем приказ себе же на расчет.
      }
    }    
  }
}
```

Результат параллельного запуска пяти таких советников.

```mql5
2021.07.25 12:34:48.823 Calculate All!
2021.07.25 12:34:48.825 132503570123939383 - Run.
2021.07.25 12:34:49.844 132503570123939383 - Done.
2021.07.25 12:34:49.844 132503570123939385 - Run.
2021.07.25 12:34:50.857 132503570123939385 - Done.
2021.07.25 12:34:50.858 132503570123939382 - Run.
2021.07.25 12:34:51.872 132503570123939382 - Done.
2021.07.25 12:34:51.872 132503570123939384 - Run.
2021.07.25 12:34:52.891 132503570123939384 - Done.
2021.07.25 12:34:52.892 132503570123939381 - Run.
2021.07.25 12:34:53.907 132503570123939381 - Done.
```

Такое решение хорошо тем, что не прерывается выполнение других функций советника.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
14 сент. 2021 в 16:17

[Форум по трейдингу, автоматическим торговым системам и тестированию торговых стратегий](/ru/forum)

[Библиотеки: Sequence](/ru/forum/353249#comment_23627425)

[fxsaber](/ru/users/fxsaber), 2021.07.25 11:48

```mql5
EventChartCustom(0, (ushort)(id - CHARTEVENT_CUSTOM), lparam, dparam, sparam); // Повторяем приказ себе же на расчет.
```

Вместо нуля лучше -1.

[Форум по трейдингу, автоматическим торговым системам и тестированию торговых стратегий](/ru/forum)

[MT5 и скорость в боевом исполнении](/ru/forum/342090/page50#comment_18648029)

[Anton](/ru/users/antt), 2020.10.08 11:00

Разный смысл и разный механизм выполнения. 0 - событие в очередь "своего" чарта. -1 - событие в собственную очередь.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
12 нояб. 2022 в 12:39

Обновление из-за [нововведения языка](/ru/forum/434546/page2#comment_42698124).

![iWPR EA](https://c.mql5.com/i/code/expert.png)
[iWPR EA](/ru/code/31436)

Стратегия по индикатору iWPR (Williams’ Percent Range, %R)

![iADXWilder Two Positions Light](https://c.mql5.com/i/code/expert.png)
[iADXWilder Two Positions Light](/ru/code/31411)

Упрощенная стратегия по индикатору iADXWilder (Average Directional Movement Index Wilder, ADX Wilder)

![Position Close Partial](https://c.mql5.com/i/code/expert.png)
[Position Close Partial](/ru/code/31548)

Советник - утилита: производится частичное закрытие позиций по текущему символу

![Yuraz_CH_moex](https://c.mql5.com/i/code/indicator.png)
[Yuraz\_CH\_moex](/ru/code/31547)

Достаточно простой индикатор , который рассчитывает процент CH% изменения за день , для инструментов из MarketWatch.
Индикатор аналогичен Yuraz\_CH но разработан с учетом работы на биржевом рынке.