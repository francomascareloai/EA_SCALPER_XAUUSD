# Opposite trade - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/18904

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/18904) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Opposite trade - expert for MetaTrader 5

[Vladimir Karputov](/en/users/barabashkakvn)  |
[English](javascript:void(false);)

[Русский](/ru/code/18904) [中文](/zh/code/18904) [Español](/es/code/18904) [Deutsch](/de/code/18904) [日本語](/ja/code/18904) [Português](/pt/code/18904)

Views:
:   5278

Rating:
:   (20)

Published:
:   3 November 2017, 12:25
:   [Opposite trade.mq5](/en/code/download/18904/opposite_trade.mq5 "Opposite trade.mq5")
    (6.19 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/18904.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

Opening a position opposite to the closed one, with the same volume. It works for any symbol and any magic number.

For example, we have an open AUDUSD BUY 0.01 position. Once this position is closed (e.g. we close it manually) the **Opposite trade** Expert Advisor will immediately open a new AUDUSD positions, this now a SELL position.

The entire code is contained in the OnTradeTransaction function:

```mql5
//+------------------------------------------------------------------+
//| TradeTransaction function                                        |
//+------------------------------------------------------------------+
void OnTradeTransaction(const MqlTradeTransaction &trans,
                        const MqlTradeRequest &request,
                        const MqlTradeResult &result)
  {
//--- get transaction type as enumeration value 
   ENUM_TRADE_TRANSACTION_TYPE type=trans.type;
//--- if transaction is result of addition of the transaction in history
   if(type==TRADE_TRANSACTION_DEAL_ADD)
     {
      long     deal_type         =-1;
      long     deal_entry        =-1;
      double   deal_volume       =0.0;
      string   deal_symbol       ="";
      if(HistoryDealSelect(trans.deal))
        {
         deal_type         =HistoryDealGetInteger(trans.deal,DEAL_TYPE);
         deal_entry        =HistoryDealGetInteger(trans.deal,DEAL_ENTRY);
         deal_volume       =HistoryDealGetDouble(trans.deal,DEAL_VOLUME);
         deal_symbol       =HistoryDealGetString(trans.deal,DEAL_SYMBOL);
        }
      else
         return;
      if(deal_entry==DEAL_ENTRY_OUT)
        {
         switch((int)deal_type)
           {
            case  DEAL_TYPE_BUY:
               m_trade.Buy(deal_volume,deal_symbol);
               break;
            case  DEAL_TYPE_SELL:
               m_trade.Sell(deal_volume,deal_symbol);
               break;
            default:
               break;
           }
        }
     }
  }
```

Here we wait for the position closing deal (DEAL\_ENTRY\_OUT). Once this deal appears, we check the deal position (if we close a BUY, this will be a Sell deal, and vice versa) and we open a new position.

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/18904](/ru/code/18904)

**Last comments |
[Go to discussion](/en/forum/218702)**
(9)

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
19 Sep 2017 at 17:15

**AngryBirds:**  

Trailing\_Profit does not match with Trailing\_Profit Expert Advisor, Trailing\_Profit when reaching its "profit" repeatedly tries to close all positions, including "oppositional" positions just opened, which accordingly all go into a small minus. Exp\_GStop behaves similarly with Opposite trade. How could these "auto-closers" in the moments of closing with Oppositom be reconciled?

  

Another option: writing ONE EA, which will combine the logic and algorithms of THREE EAs.

![AngryBirds](https://c.mql5.com/avatar/avatar_na2.png "AngryBirds")

**[AngryBirds](/en/users/angrybirds)**
|
19 Sep 2017 at 17:27

ideally similar 3 in 1 I was looking for on the internet but so far without success, only here is a composite version found, but that turns out to work only in semi-manual mode, unfortunately I am not a programmer.

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
19 Sep 2017 at 17:32

**AngryBirds:**  

Ideally, I was looking for such a 3 in 1 on the Internet, but so far without success, only the composite version found, but that is working only in semi-manual mode, unfortunately I am not a programmer.

  

The first thing to do is to write a list: and what should do such a composite EA? Approximate list:

* Should it work on all symbols?
* Should it copy magics and volumes of positions?
* ...

After making this list there will be two ways:

* search for a suitable functionality
* order code writing in [Freelance](/ru/job) service

![Carlos Henrique Luciano Duvanel Junior](https://c.mql5.com/avatar/2020/3/5E6683C1-CFBB.jpg "Carlos Henrique Luciano Duvanel Junior")

**[Carlos Henrique Luciano Duvanel Junior](/en/users/sztusz1)**
|
2 Jun 2018 at 08:42

**Automated-Trading:**  

[Opposite trade](/en/code/18904):

Author: [Vladimir Karputov](https://www.mql5.com/en/users/barabashkakvn "barabashkakvn")

Can you add stop loss and trailing profit to this ea? It would be perfect

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
2 Jun 2018 at 09:14

**sztusz1 :**   
 Can you add stop loss and trailing profit to enhance this ea ? It would be perfect

See the input parameters. The [Expert Advisor](https://www.mql5.com/en/docs/constants/tradingconstants/orderproperties#enum_order_property_integer "MQL5 documentation: Order properties") is based on the input parameters.

![up3x1 Investor](https://c.mql5.com/i/code/expert.png)
[up3x1 Investor](/en/code/18893)

Candlestick size analysis. The idea of the trading system: candlestick parameters matter after news releases.

![New Random](https://c.mql5.com/i/code/expert.png)
[New Random](/en/code/18886)

Trading based on a random number generator or in one of the following sequences: BUY - SELL - BUY or SELL - BUY - SELL.

![HTML file converter for the economic calendar](https://c.mql5.com/i/code/script.png)
[HTML file converter for the economic calendar](/en/code/18918)

HTML file converter for the economic calendar. The script parses a page downloaded from http://www.investing.com/economic-calendar, and forms a CSV file with the list of news.

![Psychological](https://c.mql5.com/i/code/indicator.png)
[Psychological](/en/code/18921)

A classic oscillator imported from the FXAccuCharts platform.