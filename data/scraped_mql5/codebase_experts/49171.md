# A Code block to detect A "New Candle/Bar" using bars history (very effective way) - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/49171

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/49171) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# A Code block to detect A "New Candle/Bar" using bars history (very effective way) - expert for MetaTrader 5

[Hapu Arachchilage Tharindu Lakmal](/en/users/51241974)  |
[English](javascript:void(false);)

[Русский](/ru/code/49171) [中文](/zh/code/49171) [Español](/es/code/49171) [Deutsch](/de/code/49171) [日本語](/ja/code/49171) [Português](/pt/code/49171) [한국어](/ko/code/49171) [Français](/fr/code/49171) [Italiano](/it/code/49171) [Türkçe](/tr/code/49171)

Views:
:   3972

Rating:
:   (5)

Published:
:   11 April 2024, 12:05

Updated:
:   11 April 2024, 12:12
:   [NEW BAR CHECK.mq5](/en/code/download/49171/new_bar_check.mq5 "NEW BAR CHECK.mq5")
    (0.81 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/49171.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

In previous code I used the **time** to detect a new bar. This time let's use the **bars count** to detect a new bar. it's way **lighter and faster** than using the time method.

* Declare the variables in **integer** data type to store the bar counts.
* Assign the bars count for the ***"BarsTotal\_OnInt"*** at the initialization.
* Use **iBars();** function to assign the bars count for the ***"BarsTotal\_OnTick"*** variable at live chart. This variable is updated on **every tick.**
* Use **comments** and **alerts** to check the code accuracy.

[![](https://c.mql5.com/18/155/4491929582288__1.png)](https://c.mql5.com/18/155/4491929582288.png "https://c.mql5.com/18/155/4491929582288.png")

```mql5
int BarsTotal_OnInt; 
int BarsTotal_OnTick;
//+------------------------------------------------------------------+
//| Expert initialization function                                   |
//+------------------------------------------------------------------+
int OnInit()
  {  
   BarsTotal_OnInt = iBars(NULL,PERIOD_CURRENT); // Asign the total bars at initialization
   return(INIT_SUCCEEDED);
  }
  
void OnTick() // OnTick Function
  {   
   BarsTotal_OnTick = iBars(NULL,PERIOD_CURRENT); // Stores the latest amount
   
   if(BarsTotal_OnTick > BarsTotal_OnInt) // New bar has arrived
   {
    BarsTotal_OnInt = BarsTotal_OnTick; // Updates the history.
    Alert("New Bar has arrived");
    Comment("Bars Count in history -: ", BarsTotal_OnInt, "\n", "Bars Count in Live -: ", BarsTotal_OnTick);

     // Your Code goes here. --------------------------
    
    // You can update a "flag" / variable to use it on later too. 

   }
  }
```

**Last comments |
[Go to discussion](/en/forum/465473)**
(1)

![William Roeder](https://c.mql5.com/avatar/2016/12/584F20BE-8336.png "William Roeder")

**[William Roeder](/en/users/whroeder1)**
|
11 Apr 2024 at 15:43

Assign the bars count for the ***"BarsTotal\_OnInt"*** at the initialization.   
Use **iBars();** function to assign the bars count for the ***"BarsTotal\_OnTick"*** variable at live chart. This variable is updated on **every tick.**

1. 1. Don't try to use any price (or indicator) or server related functions in *OnInit* (or on load or in *OnTimer* before you've received a tick), as there may be no connection/chart yet:
      1. Terminal starts.
      2. Indicators/EAs are loaded. Static and globally declared variables are initialized. (Do not depend on a specific order.)
      3. *OnInit* is called.
      4. For indicators *OnCalculate* is called with any existing history.
      5. Human may have to enter password, connection to server begins.
      6. New history is received, *OnCalculate* called again.
      7. A new tick is received, *OnCalculate*/*OnTick* is called. Now *TickValue*, *TimeCurrent*, account information and prices are valid.
   2. Unlike indicators, EAs are not reloaded on chart change, so **you** must reinitialize them, if necessary.   
                [external static variable - MQL4 programming forum #2](/en/forum/143435#comment_3626488) (20**13**)
2. You can't know when a candle closes. Only when a new tick arrives that starts a new bar is the old bar closed, and that tick could arrive almost at the end of a bar's duration.

   For a new bar test, *Bars* is unreliable (a refresh/reconnect can change number of bars on chart), volume is unreliable (miss ticks), Price is unreliable (duplicate prices and [The == operand. - MQL4 programming forum](/en/forum/145258#comment_3661719).) Always use **time**.   
             MT4: [New candle - MQL4 programming forum #3](/en/forum/150885#comment_3766801) (20**14**)   
             MT5: [Accessing variables - MQL4 programming forum #3](/en/forum/389128#comment_27802627) (20**22**)

   I disagree with making a new bar function, because it can only be called once per tick (second call returns false). A variable can be tested multiple times.   
             [Running EA once at the start of each bar - MQL4 programming forum](/en/forum/133366#comment_3391132) (20**11**)

![Candle Analysis Report](https://c.mql5.com/i/code/script.png)
[Candle Analysis Report](/en/code/49152)

This script helps traders understand the distribution and range of candles in a specific period, which can be useful for making trading decisions such as determining which historical values to use for Take Profit or Stop Loss.

![Counter Attack Candlestick](https://c.mql5.com/i/code/indicator.png)
[Counter Attack Candlestick](/en/code/49142)

Counter attack candlestick pattern

![Basic GridManager Library](https://c.mql5.com/i/code/library.png)
[Basic GridManager Library](/en/code/49186)

This is a basic library to create and manage grids.

![Code blocks for "Counters" like Count "X" time and pass](https://c.mql5.com/i/code/expert.png)
[Code blocks for "Counters" like Count "X" time and pass](/en/code/49213)

Here are some examples of codes for set counters based on "Count"