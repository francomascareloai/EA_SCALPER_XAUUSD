# Virtual - library for MetaTrader 5

Source: https://www.mql5.com/en/code/22577

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/22577) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Libraries](https://c.mql5.com/i/code/library.png)

# Virtual - library for MetaTrader 5

[fxsaber](/en/users/fxsaber)  |
[English](javascript:void(false);)

[Русский](/ru/code/22577) [中文](/zh/code/22577) [Español](/es/code/22577) [Deutsch](/de/code/22577) [日本語](/ja/code/22577) [Português](/pt/code/22577)

Views:
:   10832

Rating:
:   (62)

Published:
:   18 December 2018, 19:12
:   \MQL5\Include\fxsaber\Virtual\

    [String.mqh](/en/code/download/22577/string.mqh "String.mqh")
    (0.59 KB)
    [view](# "view")

    [Sync.mqh](/en/code/download/22577/sync.mqh "Sync.mqh")
    (5.42 KB)
    [view](# "view")

    [Order.mqh](/en/code/download/22577/order.mqh "Order.mqh")
    (15.78 KB)
    [view](# "view")

    [Orders.mqh](/en/code/download/22577/orders.mqh "Orders.mqh")
    (13.93 KB)
    [view](# "view")

    [Virtual.mqh](/en/code/download/22577/virtual.mqh "Virtual.mqh")
    (23.14 KB)
    [view](# "view")

    \MQL5\Experts\fxsaber\

    [Virtual\_Example.mq5](/en/code/download/22577/virtual_example.mq5 "Virtual_Example.mq5")
    (1.92 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/22577.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

This cross-platform allows working with a virtual trading environment in one of the easiest ways.

### Scenarios for using a virtual trading environment

1. **Real time tester.** This means, you can observe what would be if the EA traded on the most recent prices in the tester in real time. This allows you to identify the causes of discrepancies between the real market and the Tester. There is no need to wait for a new day (MT5 tester limitation) or create special tools for the Tester, so that it can pick up recent data. Accordingly, it is not necessary to run the Tester repeatedly to get updates. In fact, the virtual trading environment is a real-time Tester.
2. Auto optimization. The virtual trading environment assumes that you define what data it should work with. Therefore, an array of historical data allows you to run any TS on them inside a virtual trading environment. Thus, you can implement auto optimization into programs - a program regularly optimizes itself, just like the conventional Tester.
3. **Turning real trading into virtual one (and vice versa).** For example, temporarily disabling a TS in case of losses. The time to re-enable the TS can be analyzed via the Tester or by trading a minimum lot. In turn, the virtual environment allows users to stop trading in real time, while continuing trading in the virtual trading environment. This provides much convenience when analyzing if it is time to re-enable the TS and the ability to easily re-enable real trading.
4. **Simplifying a trading logic on a working account.** The market creates situations not present in the Tester. These include rejects and partial execution. The greatest issue is making real trading as similar to the one performed by the TS in the Tester as possible. Generally, TS developers spend considerable efforts to overcome market nuances that are extremely difficult to foresee. In fact, they learn from their own mistakes and pay real money for that, since demo accounts are unable to emulate many things of the real market. The virtual environment, in turn, allows us to see the perfect execution picture. Thus, in order to bypass the pitfalls of the real market, we need access to this perfect picture and a high-quality synchronizer (copying service) from the virtual environment to the real one. Therefore, virtual trading environments are of great help when dealing with difficult situations on real market.
5. **Tester acceleration.** The built-in Tester is a universal tool. This means that it has to emulate the trading environment as fully as possible. This entails high costs in the form of operation speed limitations. When developing and analyzing a TS, such high accuracy is exhaustive. There are various ways to accelerate the Tester, including custom symbols (up to hundreds of percent) and virtual trading environments (tens and hundreds of percent), which can afford to not take something into account for the sake of speed. The Tester acceleration is an essential advantage of virtual trading environments, since it saves computing resources and, most importantly, time.
6. **TS reversal.** A virtual trading environment allows reversing any TS easily.
7. **Using multiple TS on a netting account.** A virtual trading environment considerably simplifies launching any number of TS on a netting account. TS do not interfere with each other.
8. **Unidirectional positions on a netting account.** You can open several positions in one direction. Each of them will have its own Magic, OpenTime, OpenPrice, Comment, etc. This, for example, allows creating grid TS on a netting account, where each TP of a unidirectional position is different.
9. **Hiding Limit/Stop/SL/TP levels.** If there is a task to hide significant trading levels, it can be quickly solved using a virtual trading environment.
10. **Launching Hedge TS on a netting account.** All TS are launched in a hedge virtual environment. Netting real environment synchronizes with a virtual one.
11. **Resuming the TS operation after (abnormal) stop.** The logic of many TS depends on what it did before. This is why even if you disable a TS and restart it immediately, you may not obtain the result that would have been received if the TS had worked without a shutdown. A virtual trading environment allows you to solve this task. When launching, the TS temporarily runs in virtual environment on a price history up to the current moment. Then it is moved to the real trading environment permanently. For example, that may solve many abnormal situations involving TS shutdowns and restarts.

### Implementation

The library allows creating a virtual trading environment and trade as if it is a real trading environment. The library functionality is not new, although provided cross-platform library features one property that may be important at times: you do not need to study anything to use. Knowing MT4 (not MT5) trading logic is sufficient.

MT4-style trading logic was selected for virtual trading since it is more convenient and allows developing cross-platform EAs with ease.

### Example

The library functionality can traditionally be demonstrated by an example prepared in advance.

```mql5
// Launching TS in real and virtual trading environments

#include <MT4Orders.mqh> // https://www.mql5.com/en/code/16006
#include <fxsaber\Virtual\Virtual.mqh> // Virtual trading environment

input double Lots = 1;
input int Interval = 100;  // Position lifetime
input bool Example = true; // What code example to select

// Reversal TS
void System()
{
  if (!OrderSelect(OrdersTotal() - 1, SELECT_BY_POS))
    OrderSend(_Symbol, OP_BUY, Lots, SymbolInfoDouble(_Symbol, SYMBOL_ASK), 100, 0, 0); // If there is no position, open one
  else if (TimeCurrent() - OrderOpenTime() > Interval) // If the position lifetime exceeds the specified time
  {
    // Reverse the position
    OrderClose(OrderTicket(), OrderLots(), OrderClosePrice(), 100);
    OrderSend(_Symbol, 1 - OrderType(), Lots, OrderClosePrice(), 100, 0, 0);
  }
}

void OnTick()
{
  static const int handle = VIRTUAL::Create(); // Virtual trading environment handle created. 0 - real trading environment

  if (Example)
  {
    if (VIRTUAL::SelectByHandle()) // Real trading environment selected
      System();                    // Launching TS on a selected trading environment (real)

    if (VIRTUAL::SelectByHandle(handle)) // Virtual trading environment selected
    {
      VIRTUAL::NewTick();      // Added tick to the virtual trading environment
      System();                // Launching TS on a selected trading environment (virtual)
    }
  }
  else // Alternative fixation of the same actions.
    // Move along all existing trading environments
    for (int i = 0; i <= VIRTUAL::Total(); i++)
      if (VIRTUAL::SelectByIndex(i)) // Selected appropriate trading environment
      {
        VIRTUAL::NewTick(); // Added tick to a selected trading environment

        System(); // Launching TS on a selected trading environment
      }

  Comment(VIRTUAL::ToString()); // Display the status of the virtual trading environment on the chart
}
```

This is a cross-platform reversal EA. Its trading logic can be described in just a few strings (**System** function) thanks to MT4 style. The EA launches TS in real and virtual trading environments simultaneously. This can be well seen in the MT4 or MT5 Tester (CTRL+F5)

![](https://c.mql5.com/18/75/Virtual.png)

The screenshot shows that trading in real and virtual environments is identical.

Note that **TS code remains the same**. Only a trading environment is selected: a real one or any number of virtual ones.

The code displayed here is redundant - the two versions simply show the logic of working with the library.

### Tester acceleration

Since the **Tester acceleration** scenario (see p. 5 above) may be required more often than others, we have added the ability to switch any TS to a virtual environment and back by adding two strings at the beginning of the code.

```mql5
#define VIRTUAL_TESTER // Launch in the virtual trading environment
#include <fxsaber\Virtual\Virtual.mqh> // Virtual trading environment
```

The highlighted string allows users not to interfere with the TS original code.

![](https://c.mql5.com/18/75/Virtual2.png)

This mode has been made specifically for the Tester. It is assumed that a long-term Optimization is started with the enabled (**VirtualTester = true**) virtual environment instead of a real one. This provides a significant gain in Optimization speed (time). The obtained results (OnTester criterion - Balance) can then be used for standard single runs in real trading environment (**VirtualTester = false**).

### TS reversal

The same two strings intended to accelerate the Tester allows solving another common problem - TS reversal.

![](https://c.mql5.com/18/75/Virtual3.png)

**ReverseDeals = true** mode enables reversal of deals. The internal algorithm is as follows:

* The original EA trades inside the virtual environment as if in the real one.
* In real environment, there are positions that are inverse to the appropriate positions in the virtual one.

Thus, the EA logic is not violated in any way. At the same, we can see what the TS reversal provides. This mode is also meant for the Tester.

### Features

* Not everything is implemented in this virtual trading environment, compared with the built-in Tester.
* Both Hedge/Netting modes are supported. For example, you can create netting and hedging virtual environments simultaneously in MT4/5.
* No limitations on the number of virtual environments.
* No execution by last prices, as it sometimes happens in the MT5 Tester, since the last price is not relevant for any point in time.
* Limit orders and TakeProfit levels are always executed at the specified prices without a slippage. This removes an impression of a grail nature of some TS made by the MT5 tester.
* Stop orders and StopLoss levels are always executed at the first accept price (negative slippages) in order to avoid tester grails.
* Setting pending orders and SL/TP levels at the current prices launches their accept at once, unlike some MT5 tester operation modes. Such a behavior corresponds to market realities.

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/22577](/ru/code/22577)

**Last comments |
[Go to discussion](/en/forum/295363)**
(77)

![Forester](https://c.mql5.com/avatar/2013/10/52601B64-7C6E.jpg "Forester")

**[Forester](/en/users/elibrarius)**
|
3 Nov 2025 at 06:14

**fxsaber [#](/ru/forum/356959/page8#comment_58418087):**  

In fact, this formula works all the time.

It's easier for you, you're always on top of things. I don't do it all the time. For the first time since July, I decided to test something again....   
  
 About

```mql5
OrderClosePrice
```

- there are probably some brokerage centres that take commission only at opening - for them it is better not to take it into account. For pipsing the difference will be small, but for big targets it will be noticeable.

![Forester](https://c.mql5.com/avatar/2013/10/52601B64-7C6E.jpg "Forester")

**[Forester](/en/users/elibrarius)**
|
3 Nov 2025 at 06:50

**fxsaber [#](/ru/forum/356959/page8#comment_58418087):** Totally agree that the edit is useful and should be made. It is necessary to check for partial closing (OrderClose not for the whole lot) and CloseBy. To check it, it is enough to write a script where two differently directed positions are opened on the same tick and a partial and CloseBy-close are made at once. I am not ready to do it myself yet. If you send me such a script with a correct result, I will make your corrections faster.

I tested what is commented out there and I left it as a working version. But now I've forgotten everything. CloseBy - I don't use it, I usually have simpler ideas. I don't have time for it either. As long as there is enthusiasm, I will do strategy.

![Forester](https://c.mql5.com/avatar/2013/10/52601B64-7C6E.jpg "Forester")

**[Forester](/en/users/elibrarius)**
|
25 Nov 2025 at 14:48

Virtual adds a commission to non-performing limits:

[![](https://c.mql5.com/3/480/Screenshot-2025-11-25-at-17__1.png)](https://c.mql5.com/3/480/Screenshot-2025-11-25-at-17.png "https://c.mql5.com/3/480/Screenshot-2025-11-25-at-17.png")

Apparently we need to do a type check

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/en/users/fxsaber)**
|
25 Nov 2025 at 17:25

**Forester [#](/ru/forum/356959/page8#comment_58593836):**  

Virtual adds a commission to unexecuted limits:

Apparently we need to do a type check

```mql5
#define ORDER_COMMISSION -5 // OrderCommission() = OrderLots() * (ORDER_COMMISSION)), including the dynamic option.
#include <fxsaber\Virtual\Virtual.mqh> // https://www.mql5.com/en/code/22577

void OnStart()
{
  if (VIRTUAL::SelectByHandle(VIRTUAL::Create()))
  {
    VIRTUAL::NewTick();
    
    OrderDelete(OrderSend(_Symbol, OP_BUYLIMIT, 1, 0.01, 0, 0, 0));
    
    Print(VIRTUAL::ToString(1));
  }
}
```

Result.

```mql5
#2 2025.11.25 19:23:11.105 buy limit 1.00 EURGBP.pro 0.01000 0.00000 0.00000 2025.11.25 19:23:11.105 0.87715 0.00 0.00 0.00 0 - 00:00:00
```

It works correctly. Apparently, [these edits](/ru/forum/356959/page8#comment_58417402) require additional checking.

![Forester](https://c.mql5.com/avatar/2013/10/52601B64-7C6E.jpg "Forester")

**[Forester](/en/users/elibrarius)**
|
26 Nov 2025 at 06:46

**fxsaber [#](/ru/forum/356959/page8#comment_58595063):**  
  

It works correctly. Apparently, [these edits](/ru/forum/356959/page8#comment_58417402) require additional verification.

You are right.

In ToClose() I added calculation of commissions outside if (this.IsPosition()){

Fixed it, attached the file

![MAMy Expert](https://c.mql5.com/i/code/expert.png)
[MAMy Expert](/en/code/22578)

MAMy v.3 indicator-based EA

![TrendLineAlert_V2](https://c.mql5.com/i/code/indicator.png)
[TrendLineAlert\_V2](/en/code/22583)

The indicator displays a sloping trend line. Its parameters are set when the indicator is launched by a trader. The trend line defines the signal trigger level. The trend line breakthrough activates signals accompanied by emails and push notifications.

![MAMy v3](https://c.mql5.com/i/code/indicator.png)
[MAMy v3](/en/code/22574)

The indicator based on three moving averages

![RNN](https://c.mql5.com/i/code/expert.png)
[RNN](/en/code/22573)

The Expert Advisor based on iRSI (Relative Strength Index, RSI) indicator and a small neural network