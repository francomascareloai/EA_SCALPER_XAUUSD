# Economic Calendar Monitor and Cache for Backtesting on History - indicator for MetaTrader 5

Source: https://www.mql5.com/en/code/53393

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/53393) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Indicators](https://c.mql5.com/i/code/indicator.png)

# Economic Calendar Monitor and Cache for Backtesting on History - indicator for MetaTrader 5

[Stanislav Korotky](/en/users/marketeer)  |
[English](javascript:void(false);)

[Русский](/ru/code/53393) [中文](/zh/code/53393) [Español](/es/code/53393) [Deutsch](/de/code/53393) [日本語](/ja/code/53393) [Português](/pt/code/53393) [한국어](/ko/code/53393) [Français](/fr/code/53393) [Italiano](/it/code/53393) [Türkçe](/tr/code/53393)

Views:
:   8805

Rating:
:   (9)

Published:
:   10 November 2024, 19:33

Updated:
:   22 November 2024, 20:25
:   \MQL5\Include\MQL5Book\

    [AutoPtr.mqh](/en/code/download/53393/autoptr.mqh "AutoPtr.mqh")
    (1.86 KB)
    [view](# "view")

    [CalendarDefines.mqh](/en/code/download/53393/calendardefines.mqh "CalendarDefines.mqh")
    (4.66 KB)
    [view](# "view")

    [CalendarFilterCached.mqh](/en/code/download/53393/calendarfiltercached.mqh "CalendarFilterCached.mqh")
    (2.38 KB)
    [view](# "view")

    [DateTime.mqh](/en/code/download/53393/datetime.mqh "DateTime.mqh")
    (2.56 KB)
    [view](# "view")

    [Defines.mqh](/en/code/download/53393/defines.mqh "Defines.mqh")
    (0.71 KB)
    [view](# "view")

    [IS.mqh](/en/code/download/53393/is.mqh "IS.mqh")
    (0.98 KB)
    [view](# "view")

    [MqlError.mqh](/en/code/download/53393/mqlerror.mqh "MqlError.mqh")
    (8.53 KB)
    [view](# "view")

    [QuickSortStructTRef.mqh](/en/code/download/53393/quicksortstructtref.mqh "QuickSortStructTRef.mqh")
    (7.86 KB)
    [view](# "view")

    [StringUtils.mqh](/en/code/download/53393/stringutils.mqh "StringUtils.mqh")
    (1.91 KB)
    [view](# "view")

    [Tableau.mqh](/en/code/download/53393/tableau.mqh "Tableau.mqh")
    (8.79 KB)
    [view](# "view")

    [PRTF.mqh](/en/code/download/53393/prtf.mqh "PRTF.mqh")
    (1.49 KB)
    [view](# "view")

    [CalendarFilter.mqh](/en/code/download/53393/calendarfilter.mqh "CalendarFilter.mqh")
    (28.8 KB)
    [view](# "view")

    [TimeServerDST.mqh](/en/code/download/53393/timeserverdst.mqh "TimeServerDST.mqh")
    (16.98 KB)
    [view](# "view")

    [CalendarCache.mqh](/en/code/download/53393/calendarcache.mqh "CalendarCache.mqh")
    (28.54 KB)
    [view](# "view")

    [CalendarMonitorCachedTZ.mq5](/en/code/download/53393/calendarmonitorcachedtz.mq5 "CalendarMonitorCachedTZ.mq5")
    (8.41 KB)
    [view](# "view")

    [Expand (15)](javascript:void(false))
    [Collapse (15)](javascript:void(false))

    [Download as ZIP](/en/code/download/53393.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

To make a long story short: the built-in economic calendar of MetaTrader 5 is not (completely) synchronized with historical quotes.

Quotes are marked with timestamps in accordance with the time zones that were in effect on the server at the moment of formation of each corresponding bar.

Once the bars are formed they remain unchanged, including their timestamps. On the other hand, the economic calendar provides information about events (past, present, and future) tied to the current time zone of the server. Since many brokers adhere to a specific time zone schedule, including turning daylight saving mode on and off, the timestamps of the historical events may be shifted by 1 hour relative to associated bars, for about half of each year.

Moreother, brokers sometimes change time zones more radically than just switching DST. Historical quotes may then appear to be shifted several hours to the left or right relative to the time of the economic events that originally occurred on them, but are now reported by the calendar in the server's updated time zone.

Taking into account that news come from different countries with their own DST schedules and your server can be located in a region with other schedule, time of news releases can  visually "jump" back and forth on charts even in more peculiar manner (for example, for several weeks in spring and in autumn).

All this doesn't seem so important online, but what if we want to test a news-based strategy?

Yes, you can say that the calendar is not supported in MetaTrader tester natively, but many traders like to trade news and everyone else who doesn't should follow the news to simply step aside from the market before it'll go wild during news. So backtesting with the calendar is important. That's why it's very logical to export the calendar to an external storage (file, database) and then import it to the tester. One of such archiving tools for calendar-in-tester experience was presented in [the algotrading book](/en/book/advanced/calendar/calendar_cache_tester).

And here we run into the problem of desynchronization of historical quotes with historical events. For the sake of simplicity, this problem has been left unresolved in the book.

Now it's solved thanks to the extended version of *CalendarCache.mqh* and the showcasing indicator *CalendarMonitorCachedTZ.mq5*. This is just a slightly changed version of *CalendarMonitorCached.mq5* from the book.

The indicator monitors news events and dynamically updates an on-chart table with several past and forthcoming events.

All the job related to time correction is done behind the scenes - in the other public library [TimeServerDST.mqh](/en/code/52557).  For better understanding how the time correction works one can use the script [CalendarCSVForDates.mq5](/en/code/52977) and compare CSV-files with and without correction side by side.

And here is how the lib is embedded into the source codes of both programs - the script and this indicator.

```mql5
#include <TimeServerDST.mqh> // including before Calendar cache enables timezone fix-up support
#include <MQL5Book/CalendarFilterCached.mqh>
#include <MQL5Book/CalendarCache.mqh>
```

As in the original indicator, there is the string input **CalendarCacheFile**, where you can provide a name of cal-file for writing or reading.

When the indicator is attached to an online chart with empty **CalendarCacheFile**, it works with the built-in calendar on-the-fly.

When the indicator is executed with specific name in **CalendarCacheFile** and the file doesn't exist, the indicator exports the calendar records into the cache file (creates the file) and exits. This is the stage when the timestamps should/can be corrected (see **FixCachedTimesBySymbolHistory** below).

When the indicator is executed with a name of existing cache-file in **CalendarCacheFile**, it loads the cache and works with this copy in the same way as with built-in calendar. This is specifically useful for the tester.

![Calendar Monitor in the tester reads events from the cache](https://c.mql5.com/18/157/caltest_600x400.png "Calendar Monitor in the tester reads events from the cache")

Please, don't forget that the tester requires to specify additional files, in our case - the prepared online cal-file, in the directive *#property tester\_file* OR you should place the cal-file into the common folder C:/Users/<User>/AppData/Roaming/MetaQuotes/Terminal/Common/.

Of course, the cache can be also loaded into an EA during backtests and optimizations.

The input string **FixCachedTimesBySymbolHistory** is processed in the following way.

If it's empty, the indicator saves the cache without time corrections.

To enable time corrections during export you should specify a symbol, which will be used for empirical detection of historical time zones of the server. It works based on history of H1 quotes, preferably "XAUUSD" or "EURUSD".

With the help of this input, only a couple of lines are added into the new version of the indicator:

```mql5
         if(StringLen(FixCachedTimesBySymbolHistory))
            cache[].adjustTZonHistory(FixCachedTimesBySymbolHistory, true);
```

The method *adjustTZonHistory* was specifically introduced into *CalendarCache* class for timestamps adjustments and its implementation uses internals of *TimeServerDST.mqh*.

The method should be called online only (not in the tester).

Normally the method should be called on cache objects filled from the built-in calendar, right after the filling. Otherwise, if the cache is loaded from a cal-file, or if the method was already called before, the cache contents could be already adjusted. Then you'll apply fix on fix and get wrong timestamps.

The second parameter (*true*) instructs the method to write boundaries of applied changes into the log. Something like this:

```mql5
Time fix-up started at 2021.07.19 00:30:00
2021.07.19 00:30:00: 148786 -10800 diff=-3600
2021.11.08 01:50:00: 135918 -7200 OK
2022.03.14 04:30:00: 161085 -10800 diff=-3600
2022.11.07 04:00:00: 165962 -7200 OK
2023.03.13 01:50:00: 168500 -10800 diff=-3600
2023.11.06 01:50:00: 169270 -7200 OK
2024.03.11 01:50:00: 181258 -10800 diff=-3600
2024.11.04 02:30:00: 208469 -7200 OK
```

Each line contains a time and ID of an event where new discrepancy was detected, server time offset at the event, and what difference must be applied to all subsequent timestamps in order to eliminate the bias in server time at the moment of calendar caching.

The attached mqh-files (CalendarFilter.mqh, CalendarCache.mqh, QuickSortStructT(Ref).mqh) contain bugfixes and improvements compared to their original versions from the book.

**Updates**

11.11.2024 - small bugfix and updates in CalendarFilter.mqh, CalendarCache.mqh;

22.11.2024 - small bugfixes and improvements in CalendarCache.mqh.

**Last comments |
[Go to discussion](/en/forum/476219)**
(20)

![disaster123](https://c.mql5.com/avatar/avatar_na2.png "disaster123")

**[disaster123](/en/users/disaster123)**
|
16 Jan 2025 at 11:08

**Stanislav Korotky [#](/en/forum/476219/page2#comment_55590927):**  

Online you don't need a cache - read calendar directly (the lib can do it transparently just to keep the source code unified).

A single cache per PC is enough, or you can prefer to have separate caches for each terminal instance.

Create new cache just before you are going to do tests/optimizations up to current date.

I'm currently always create a new cache in case an EA starts not in tester. But this seems to result in the following errors:

```mql5
a few thousand lines of:

Can't read quotes for 2025.01.16 10:50:52, error: 4003 INVALID_PARAMETER

as well as sometimes:

array out of range in 'CalendarCache.mqh' (694,22)

```

![Stanislav Korotky](https://c.mql5.com/avatar/2010/10/4CA7CFA0-1F0C.jpg "Stanislav Korotky")

**[Stanislav Korotky](/en/users/marketeer)**
|
16 Jan 2025 at 17:14

**disaster123 [#](/en/forum/476219/page2#comment_55651314):**  

I'm currently always create a new cache in case an EA starts not in tester. But this seems to result in the following errors:

Can you send a short source code to reproduce the problem?

The error "Can't read quotes for" comes from TimeServerDST.mqh and means that you, most likely, call it with somewhat incorrect parameters, for example which asks for future quotes. Also make sure the terminal is connected and the work symbol is synchronized when you call the lib.

In the CalendarCache.mqh try to edit the line 159:

```mql5
if(!n) return -1;false;
```

![disaster123](https://c.mql5.com/avatar/avatar_na2.png "disaster123")

**[disaster123](/en/users/disaster123)**
|
16 Jan 2025 at 19:17

**Stanislav Korotky [#](/en/forum/476219/page2#comment_55655343):**  

Can you send a short source code to reproduce the problem?

The error "Can't read quotes for" comes from TimeServerDST.mqh and means that you, most likely, call it with somewhat incorrect parameters, for example which asks for future quotes. Also make sure the terminal is connected and the work symbol is synchronized when you call the lib.

In the CalendarCache.mqh try to edit the line 159:

yes sure no problem. The no quotes error happens also for very old dates and it happens between FixCachedTimesBySymbolHistory and Newsfilter: using online mode - i've a feeling that there are too many requests tot the online calendar to broker.

Code is this:

```mql5
   if(MQLInfoInteger(MQL_TESTER))
     {
      newsfilter_cache = new CalendarCache("calendar_cache.cal", true);

      if(newsfilter_cache[].isLoaded())
        {
         Print("Newsfilter: using cache...");
         newsfilter_filter = new CalendarFilterCached(newsfilter_cache[]);

         int tzoffset = newsfilter_cache[].getTZOffset();
         PrintFormat("Current server TZ offset: %+d; calendar cached TZ offset: %+d",
                     MQLInfoInteger(MQL_TESTER) ? TimeServerGMTOffset() : TimeServerGMTOffsetHistory(), tzoffset);

        }
      else
        {
         Alert("Can't run in the tester without calendar cache file");
         Print("Can't run in the tester without calendar cache file");
         return false;
        }
     }
   else
     {

      newsfilter_cache = new CalendarCache();

      Print("FixCachedTimesBySymbolHistory");
      newsfilter_cache[].adjustTZonHistory("XAUUSD", true);

      if(!newsfilter_cache[].save("calendar_cache.cal"))
        {
         Print("newsfilter_cache save failed. Error: ", _LastError);
         return false;
        }

      Print("Newsfilter: using online mode");
      newsfilter_filter = new CalendarFilter();
     }

   CalendarFilter *f = newsfilter_filter[];

   if(!f.isLoaded())
     {
      Print("ERROR Cal Filter not loaded!");
      return false;
     }
```

![Stanislav Korotky](https://c.mql5.com/avatar/2010/10/4CA7CFA0-1F0C.jpg "Stanislav Korotky")

**[Stanislav Korotky](/en/users/marketeer)**
|
17 Jan 2025 at 13:06

**disaster123 [#](/en/forum/476219/page2#comment_55656615):**  

yes sure no problem. The no quotes error happens also for very old dates and it happens between FixCachedTimesBySymbolHistory and Newsfilter: using online mode - i've a feeling that there are too many requests tot the online calendar to broker.

Code is this:

Without a context (how the fragment is called), settings, and logs, it's hard to deduce what can be wrong, apart from the fact that CopyTime function can really fail - it does not mean that the lib violates something. According to your current report, this completely legitimate line fails:

```mql5
CopyTime(symbol, PERIOD_H1, 0, Bars(symbol, PERIOD_H1), array)
```

I meant that you could provide a complete test EA to reproduce the problem.

Alternatively, since you have the source codes, you can set the breakpoint at the line in TimeServerDST.mqh, where the message is printed out, and then run your program under debugger. When/if the problem appears, your code will fall into debugger, and you can check what's wrong.

Probably, there is something special in your environment (work instrument, temporary connection loss, etc.).

![disaster123](https://c.mql5.com/avatar/avatar_na2.png "disaster123")

**[disaster123](/en/users/disaster123)**
|
17 Jan 2025 at 19:41

argh - i got it! XAUUSD is not a valid symbol at OX - you need to [use XAUUSD](https://www.mql5.com/en/quotes/metals/XAUUSD "XAUUSD chart: technical analysis").PRO for timezone adjustment.... bad...

![Extreme highs and lows with tick prices](https://c.mql5.com/i/code/indicator.png)
[Extreme highs and lows with tick prices](/en/code/53354)

Marking the extreme highs and lows (OHLC) together with the extreme bid and ask prices

![Hammer Indicator](https://c.mql5.com/i/code/indicator.png)
[Hammer Indicator](/en/code/53154)

The code above is a "Hammer" indicator that detects candlestick hammer formations (bullish and bearish) and inverted hammer formations (bullish and bearish) on a MetaTrader 5 chart. This indicator identifies price reversal patterns by calculating the size and ratio of the candlestick wicks based on adjustable parameters: MaxRatioShortWick, MinRatioLongWick, and MinCandleSize. When a pattern is detected, the indicator displays a colored arrow near the candle’s lowest or highest price according to the pattern’s direction. The code also includes functions to create and delete objects automatically when the indicator is initialized or stopped.

![simple mt5 trade copier](https://c.mql5.com/i/code/expert.png)
[simple mt5 trade copier](/en/code/53406)

this is a copier template

![Volume weighted line chart with smoothing](https://c.mql5.com/i/code/indicator.png)
[Volume weighted line chart with smoothing](/en/code/53468)

A smoother line chart which cuts out a lot of the market noise and uses volume in the formula