# Fractured Fractals - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/20127

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/20127) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Fractured Fractals - expert for MetaTrader 5

Scriptor  |
[English](javascript:void(false);)

[Русский](/ru/code/20127) [中文](/zh/code/20127) [Español](/es/code/20127) [Deutsch](/de/code/20127) [日本語](/ja/code/20127) [Português](/pt/code/20127)

Published by:
:   [Vladimir Karputov](/en/users/barabashkakvn)

Views:
:   8076

Rating:
:   (21)

Published:
:   18 April 2018, 17:06
:   [Fractured Fractals.mq5](/en/code/download/20127/fractured_fractals.mq5 "Fractured Fractals.mq5")
    (34.88 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/20127.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

**The author of the idea**: [Scriptor](/en/users/scriptor "Scriptor (Scriptor)"), **the author of the MQL5 code**: [barabashkakvn](/en/users/barabashkakvn).

The Expert Advisor uses the iFractals indicator signals to place pending Buy Stop and Sell Stop orders and trail the Stop Loss levels of positions. A condition to place a Buy Stop order occurs when there are two upper fractals, of which the last formed one ("Up youngest") is higher than the previous fractal ("Up middle").

Stop Loss of a Buy Stop order is set at the latest lower fractal ("Down youngest"). Then, Stop Loss of a Buy position is trailed based on that "Down youngest" fractal.

![Fractured Fractals Buy Stop](https://c.mql5.com/18/66/Fractured_Fractals_BUY_STOP.png "Fractured Fractals Buy Stop")

Fig. 1. Conditions for Buy Stop

Conditions are opposite for Sell orders and Sell positions.

### Input Parameters

* **Maximum Risk in percentage** - maximum allowable risk;
* **Decrease factor** - lot reduction factor in case of losing trades;
* **Life time of the pending order (in hours)** - pending order life time in hours;
* **magic number** - unique identifier for the EA.

Testing results on M30 and H2:

![](https://c.mql5.com/18/66/2018-03-01_19h21_53.png)

![](https://c.mql5.com/18/66/2018-03-01_19h23_17.png)

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/20127](/ru/code/20127)

**Last comments |
[Go to discussion](/en/forum/238275)**
(11)

![Miguel Angel Perez](https://c.mql5.com/avatar/avatar_na2.png "Miguel Angel Perez")

**[Miguel Angel Perez](/en/users/miguelperez)**
|
19 Aug 2020 at 17:39

Really cool strategy, thanks for sharing the code.  I'm going to make some alterations and get some code ideas from it see if I can make it hugely profitable :)

MT5 is the way forward for EAs, the [strategy tester](https://www.mql5.com/en/articles/239 "Article \"The Fundamentals of Testing in MetaTrader 5\"") is far superior.

![Krisma Freddy](https://c.mql5.com/avatar/2018/9/5B987E66-60BB.jpg "Krisma Freddy")

**[Krisma Freddy](/en/users/yekaefteem)**
|
12 Mar 2021 at 03:54

can we add some filter indicators here such as MA or Aligator or Ichimoku Cloud to determine the trend? thanks

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
12 Mar 2021 at 04:10

**Krisma Freddy :**  
 can we add some filter indicators here such as MA or Aligator or Ichimoku Cloud to determine the trend? thanks

Yes, you can do that.

![Daniele Valeri](https://c.mql5.com/avatar/2022/10/634DB207-FF8D.png "Daniele Valeri")

**[Daniele Valeri](/en/users/danielevaleri)**
|
10 Oct 2023 at 01:18

Hi Vladimir Karputov, I'm new to mt5...I really like this strategy, congratulations for your ideas and the passion you show...it would be possible to add the possibility of having a fixed take profit to the N pips strategy, I have seen that many times to follow the trend the profit is canceled, because perhaps a new fractal cannot be created and the stop is pierced...unfortunately I tried to understand how to insert it but I was unable. More than having the good strategy and ready I would like to understand where and how to insert it. Thank you[@Daniele Valeri](/en/users/danielevaleri)

![MayaxatL](https://c.mql5.com/avatar/2019/10/5D95AA59-3FB8.png "MayaxatL")

**[MayaxatL](/en/users/cezarylato)**
|
22 Feb 2025 at 19:40

/\*
Fractured Fractals (barabashkakvn's edition) EA Explanation: General Purpose:
- This EA, created in 2005 by tageiger, uses the classic iFractals indicator to identify potential reversal points in the market.
- It makes trading decisions based on fractal values by placing pending orders (BuyStop/SellStop) or modifying existing positions (e.g., adjusting Stop Loss levels).
- The EA incorporates risk management by calculating an optimal trade size based on account margin and a user-defined maximum risk percentage. Key Components:
- Libraries: The code includes several MQL5 trading libraries (CTrade, CPositionInfo, CSymbolInfo, CAccountInfo, CDealInfo, COrderInfo) to handle trade operations, manage positions, and retrieve symbol/account details.
- Input Parameters: • MaximumRisk: The maximum risk per trade as a percentage of account equity. • DecreaseFactor: A factor used to reduce the trade size after consecutive losses. • Expiration: The lifespan (in hours) of pending orders. • m\_magic: A unique identifier (magic number) to differentiate trades executed by this EA from others. Initialization (OnInit):
- The EA sets up the trading symbol and refreshes market data.
- It configures the trading object with the [specified magic number](https://www.mql5.com/en/articles/125 "Article: The Optimal Method for Calculation of Total Position Volume by Specified Magic Number ") and selects an appropriate order filling type (FOK, IOC, or a default method) based on what the broker supports.
- A handle for the iFractals indicator is created using the current symbol and timeframe. If this fails, an error is logged and initialization is stopped.
- Various fractal-related variables are initialized to EMPTY\_VALUE, and the time of the last profitable deal is stored. OnTick Function:
- The OnTick function is triggered on each new bar. It first checks if a new bar has formed by comparing the current bar’s time with a stored timestamp.
- It retrieves the upper and lower fractal values using the iFractals indicator.
- The EA updates a history of fractal values by shifting older values and saving the newest ones.
- It displays current fractal values on the chart through comments for easy monitoring.
- The EA counts current open positions and pending orders. If conditions are met (e.g., a rising sequence for Buy orders or a falling sequence for Sell orders), it calculates an optimized trade size and places a pending order (BuyStop or SellStop).
- Additionally, it adjusts Stop Loss levels for open positions based on the new fractal levels and removes outdated pending orders if market conditions have changed. Risk and Trade Size Management:
- The TradeSizeOptimized function calculates the ideal lot size based on the account’s free margin, the defined maximum risk percentage, and the margin requirement per lot.
- If a series of losses is detected, the EA reduces the trade size further based on the DecreaseFactor.
- The LotCheck function ensures the computed lot size respects the broker’s minimum, maximum, and lot step limits. Additional Utility Functions:
- RefreshRates: Refreshes market data for the symbol to ensure current rates.
- IsFillingTypeAllowed: Checks if a particular order filling type (e.g., FOK, IOC) is allowed by the broker.
- iTime: Retrieves the time of a specified bar, ensuring the EA operates on new bars.
- LastProfitDeal: Scans the trading history to find the time of the last profitable deal, which is used in risk management calculations.
- iFractalsGet: Retrieves fractal values from the indicator’s buffers, with error logging if the data cannot be copied.
- CompareDoubles: Compares two double values to a specified precision to determine if they are effectively equal.
- PrintComments: Updates on-chart comments with the current fractal values and time for monitoring purposes. Summary:
- The EA leverages the iFractals indicator to detect market reversals.
- It automatically places pending orders when certain fractal conditions are met.
- Open positions are dynamically managed by adjusting Stop Loss levels.
- It employs comprehensive risk management to optimize trade size based on current account conditions and recent performance. This well-structured code demonstrates the use of object-oriented programming in MQL5 to efficiently manage trading operations and risk.
\*/

![AD](https://c.mql5.com/i/code/indicator.png)
[AD](/en/code/20124)

The AD (Accumulation Distribution) indicator with three calculation methods.

![SSS](https://c.mql5.com/i/code/indicator.png)
[SSS](/en/code/20123)

SSS (Special Slow Stochastic) has an additional smoothed (slow) line based on the Stochastic signal line.

![MathCeilRoundFloor](https://c.mql5.com/i/code/script.png)
[MathCeilRoundFloor](/en/code/20131)

Example of functions MathCeil, MathRound and MathFloor.

![BHS system](https://c.mql5.com/i/code/expert.png)
[BHS system](/en/code/20132)

The EA trades using pending Buy Stop and Sell Stop orders, applying the iAMA (Adaptive Moving Average, AMA) indicator based on a "round price". Position trailing.