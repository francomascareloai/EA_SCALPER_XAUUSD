# Close At Time - expert for MetaTrader 4

Source: https://www.mql5.com/en/code/14303

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/14303) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Close At Time - expert for MetaTrader 4

Algofxsolution.com  |
[English](javascript:void(false);)

[Русский](/ru/code/14303) [Deutsch](/de/code/14303) [日本語](/ja/code/14303)

Published by:
:   [Algofxsolution](/en/users/algofxsolution)

Views:
:   18513

Rating:
:   (20)

Published:
:   2 December 2015, 12:48

Updated:
:   22 November 2016, 07:32
:   [closeattime.mq4](/en/code/download/14303/closeattime.mq4 "closeattime.mq4")
    (14.69 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/14303.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

Close At Time is an Expert Advisor for MetaTrader 4 trading platform, that closes open positions or deletes pending orders or both. You can also specify how it should be closed — by symbol, magic number or ticket number. And the last one is time when Expert Advisor will close selected orders. Time is meant local time of computer. Expert Advisor has also integrated error description for cases when there is some problem while closing individual orders.

EA is built on idea that it has to be done. It means that if there is an error while closing order or position, EA will try it again on next tick. It has also small problem when this idea is applied. Other trades, opened after selected time and satisfying selected conditions, are closed (EA is not stopped). But it doesn't violate basic idea.

**Input parameters:**

Close settings:

```mql5
extern bool bAllClose = false; //Close All
extern bool bSymClose = false; //Close by Symbol
extern bool bMNClose = false; //Close by Magic Number
extern bool bTNClose = false; //Close by Ticket Number
extern bool PO = false; //Close Pending Orders
extern bool MO = false; //Close Market Orders
extern string TimeToClose="YYYY.MM.DD HH:MI"; //Local time to close
```

Close parameters:

```mql5
extern string SymClose=""; //Symbol to close
extern int MNClose = 0; //Magic Number to close
extern int TNClose = 0; //Ticket Number to close
```

**Last comments |
[Go to discussion](/en/forum/68086)**
(9)

![Algofxsolution](https://c.mql5.com/avatar/2016/1/568C1350-49FF.png "Algofxsolution")

**[Algofxsolution](/en/users/algofxsolution)**
|
16 Dec 2015 at 11:17

**Alain Verleyen:**  

This code is of very poor quality.

Never use it on a [real account](/en/docs/constants/environment_state/accountinformation#enum_account_trade_mode "MQL5 documentation: Account Properties") as you are risking very bad surprise.

Hi Alain, what do you exactly mean? Because we use Close at Time for months without any fails. Two different brokers, live and demo account too. Thanks for your comments

![Alain Verleyen](https://c.mql5.com/avatar/2024/5/663a6cdf-e866.jpg "Alain Verleyen")

**[Alain Verleyen](/en/users/angevoyageur)**
|
16 Dec 2015 at 12:56

**Algofxsolution:**  
 Hi Alain, what do you exactly mean? Because we use Close at Time for months without any fails. Two different brokers, live and demo account too. Thanks for your comments

My previous message was not very constructive, should not post so late ;-)

It all depends on the context...but sooner or later someone will have problems.

The main issue is you ALWAYS need to count down when processing orders :

```mql5
      for(int i=OrdersTotal()-1; i>=0; i--)
```

.And when you try 3 times in a row to close, you need to refresh your price :

```mql5
         if(OrderClose(OrderTicket(),OrderLots(),AskOrBid,MaxSlippage)==false)
           {
            // Your AskOrBid could be obsolete : need RefreshRates()
            ...

            //Retries 2//
            if(OrderClose(OrderTicket(),OrderLots(),AskOrBid,MaxSlippage)==false)
              {
               // Your AskOrBid could be obsolete : need RefreshRates()
               ...

               //Retries 3//
               if(OrderClose(OrderTicket(),OrderLots(),AskOrBid,MaxSlippage)==false)
                 {
                  error=GetLastError();
                  Print("Error closing order for ticket:"+StringConcatenate(OrderTicket())+" Error: "+StringConcatenate(error)+" : "+ErrorDescription(error));
                 }
              }
           }
```

You don't process errors you just report it and retry. Believe my on a live [trading environment](https://www.mql5.com/en/articles/994 "Article: How to Prepare a Trading Account for Migration to Virtual Hosting ") that **could** lead to problems. Other points are minor.

![Algofxsolution](https://c.mql5.com/avatar/2016/1/568C1350-49FF.png "Algofxsolution")

**[Algofxsolution](/en/users/algofxsolution)**
|
16 Dec 2015 at 14:55

**Alain Verleyen:**  

My previous message was not very constructive, should not post so late ;-)

It all depends on the context...but sooner or later someone will have problems.

The main issue is you ALWAYS need to count down when processing orders :

.And when you try 3 times in a row to close, you need to refresh your price :

You don't process errors you just report it and retry. Believe my on a live trading environment that **could** lead to problems. Other points are minor.

Thank you Alain, good point. It could lead in problems in some specific situations. New version is waiting for approve.

![Alain Verleyen](https://c.mql5.com/avatar/2024/5/663a6cdf-e866.jpg "Alain Verleyen")

**[Alain Verleyen](/en/users/angevoyageur)**
|
16 Dec 2015 at 15:28

**Algofxsolution:**  
 Thank you Alain, good point. It could lead in problems in some specific situations. New version is waiting for approve.

You are welcome. Good reaction.

![Antonello74](https://c.mql5.com/avatar/avatar_na2.png "Antonello74")

**[Antonello74](/en/users/antonello74)**
|
17 Jul 2018 at 14:39

Hello guys you can change EA, I'll explain better, I would like to close the open order, at the closing of the bar, is it possible?

![Cidomo_v.1](https://c.mql5.com/i/code/expert.png)
[Cidomo\_v.1](/en/code/14264)

The strategy of this EA is daily breakout which is compare previous high or low previous day candle then place a pending order for breakout.

![Millenium Code](https://c.mql5.com/i/code/expert.png)
[Millenium Code](/en/code/13995)

This program is a basic version of the original code of relatively simple system Millenium.

![Levels with Revolve](https://c.mql5.com/i/code/expert.png)
[Levels with Revolve](/en/code/14205)

EA opens trades from support and resistance levels, which were set by a trader, and revolves them at another levels.

![ZigZag Dual Buffer](https://c.mql5.com/i/code/indicator.png)
[ZigZag Dual Buffer](/en/code/14331)

This ZigZag indicator uses dual buffers to store high and low points.