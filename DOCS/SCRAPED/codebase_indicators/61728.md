# CBitBuffer Class - Data Serialization in MQL5 - library for MetaTrader 5

Source: https://www.mql5.com/en/code/61728

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/61728) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Libraries](https://c.mql5.com/i/code/library.png)

# CBitBuffer Class - Data Serialization in MQL5 - library for MetaTrader 5

[amrali](/en/users/amrali)  |
[English](javascript:void(false);)

[Ğ ÑƒÑÑĞºĞ¸Ğ¹](/ru/code/61728) [ä¸­æ–‡](/zh/code/61728) [EspaÃ±ol](/es/code/61728) [Deutsch](/de/code/61728) [æ—¥æœ¬èª](/ja/code/61728) [PortuguÃªs](/pt/code/61728) [í•œêµ­ì–´](/ko/code/61728) [FranÃ§ais](/fr/code/61728) [Italiano](/it/code/61728) [TÃ¼rkÃ§e](/tr/code/61728)

Views:
:   6153

Rating:
:   (8)

Published:
:   20 July 2025, 22:32

Updated:
:   19 November 2025, 19:33
:   \MQL5\Scripts\CBitBuffer\

    [CBitBuffer.mqh](/en/code/download/61728/CBitBuffer.mqh "CBitBuffer.mqh")
    (95.3 KB)
    [view](# "view")

    [CBitBuffer\_Test.mq5](/en/code/download/61728/CBitBuffer_Test.mq5 "CBitBuffer_Test.mq5")
    (39.12 KB)
    [view](# "view")

    \MQL5\Scripts\CBitBuffer\TicksShort\_VLQ\

    [TicksShort.mqh](/en/code/download/61728/TicksShort.mqh "TicksShort.mqh")
    (14.12 KB)
    [view](# "view")

    [TicksShort\_SaveLoad.mq5](/en/code/download/61728/TicksShort_SaveLoad.mq5 "TicksShort_SaveLoad.mq5")
    (2 KB)
    [view](# "view")

    [TicksShort\_Performance.mq5](/en/code/download/61728/TicksShort_Performance.mq5 "TicksShort_Performance.mq5")
    (4.69 KB)
    [view](# "view")

    [TicksShortLite.mqh](/en/code/download/61728/TicksShortLite.mqh "TicksShortLite.mqh")
    (17.16 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/61728.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

### 

### CBitBuffer Class - Bit-Level Data Serialization in MQL5

The CBitBuffer class provides a robust foundation for bit-level data serialization in MQL5, offering fine-grained control over data storage and retrieval. The class includes support for various data types, including variable-length integers (VLQ with ZigZag encoding), and serialization of strings and structures, which are excellent for optimizing space. The class employs optimizations like internal buffering and exponential array growth to enhance performance and provides a comprehensive error handling system. It's particularly useful for network communication or file storage where minimizing data size is crucial (e.g., compression of tick data).

![](https://c.mql5.com/18/169/ser.png)

**Key Features:**

* **Bit-level Operations**: Allows writing and reading data bit by bit, or in specified bit lengths up to 64 bits.
* **Data Type Support**: Includes methods for bool, char, uchar, short, ushort, int, uint, long, ulong, datetime, float, double, string, and struct.
* **Variable-Length Integers (VLQ)**: Implements VLQ encoding for int, uint, long, and ulong values, which can significantly save space for frequently small integer values.
* **Error Handling**: Provides an ENUM\_BIT\_BUFFER\_ERROR enum and GetLastError()/GetLastErrorString() methods for robust error management.
* **Buffer Management**: Offers functions to clear, finalize, set raw buffer content, save to file, and load from file.
* **Internal Buffering**: Uses internal 64-bit buffers (m\_writeBufferInternal, m\_readBufferInternal) to optimize bit-level operations by accumulating bits before writing to or reading from the main ulong[] array.

```mql5
//+------------------------------------------------------------------+
//| CBitBuffer ClassÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  |
//| Reads/writes individual bits or bit sequences to ulong[] buffer. |
//| Supports efficient bit manipulation and mixed read/write ops.Â Â Â Â |
//+------------------------------------------------------------------+
class CBitBuffer
Â Â {
public: // Core bit operations
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteBit(bool bit);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Writes a single bit
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteBits(ulong value, int numberOfBits); // Writes N bits from a ulong
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadBit();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Reads a single bit
Â Â  ulongÂ Â Â Â Â Â Â Â Â Â Â Â  ReadBits(int numberOfBits);Â Â Â Â Â Â Â Â Â Â  // Reads N bits as a ulong
Â Â  ulongÂ Â Â Â Â Â Â Â Â Â Â Â  PeekBits(int numberOfBits);Â Â Â Â Â Â Â Â Â Â  // Reads N bits without advancing position

public: // Position and size management
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â SetReadPosition(long bitPosition);Â Â Â Â // Sets read position in bits
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetReadPosition();
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ResetReadPosition();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Resets read position to 0
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â SkipBits(long bitsToSkip);Â Â Â Â Â Â Â Â Â Â Â Â // Skips N bits from current read position
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetTotalWrittenBits();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Total bits written
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetTotalBytesWritten();Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Total bytes written
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetTotalBytesAllocated();Â Â Â Â Â Â Â Â Â Â Â Â  // Total allocated bytes
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetRemainingReadBits();Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Remaining bits to read

public: // Data type specific read/write operations
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteBool(bool value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteChar(char value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteUChar(uchar value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteShort(short value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteUShort(ushort value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteInt(int value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteUInt(uint value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteLong(long value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteULong(ulong value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteDatetime(datetime value);
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteFloat(float value);Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Writes a 32-bit float
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteDouble(double value);Â Â Â Â Â Â Â Â Â Â Â Â // Writes a 64-bit double
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteString(string value);Â Â Â Â Â Â Â Â Â Â Â Â // Writes string with length prefix
Â Â  template<typename T>
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteStruct(T &struct_object);Â Â Â Â Â Â Â Â // Writes struct with length prefix

Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadBool();
Â Â  charÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadChar();
Â Â  ucharÂ Â Â Â Â Â Â Â Â Â Â Â  ReadUChar();
Â Â  shortÂ Â Â Â Â Â Â Â Â Â Â Â  ReadShort();
Â Â  ushortÂ Â Â Â Â Â Â Â Â Â Â Â ReadUShort();
Â Â  intÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  ReadInt();
Â Â  uintÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadUInt();
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadLong();
Â Â  ulongÂ Â Â Â Â Â Â Â Â Â Â Â  ReadULong();
Â Â  datetimeÂ Â Â Â Â Â Â Â Â Â ReadDatetime();
Â Â  floatÂ Â Â Â Â Â Â Â Â Â Â Â  ReadFloat();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Reads a 32-bit float
Â Â  doubleÂ Â Â Â Â Â Â Â Â Â Â Â ReadDouble();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Reads a 64-bit double
Â Â  stringÂ Â Â Â Â Â Â Â Â Â Â Â ReadString();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Reads string with length prefix
Â Â  template<typename T>
Â Â  TÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  ReadStruct();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Reads struct with length prefix

public: // Variable-length encoding for integers (VLQ)
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteVarInt(int value);Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Writes signed int using ZigZag + VLQ
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteVarUInt(uint value);Â Â Â Â Â Â Â Â Â Â Â Â  // Writes unsigned int using VLQ
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteVarLong(long value);Â Â Â Â Â Â Â Â Â Â Â Â  // Writes signed long using ZigZag + VLQ
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â WriteVarULong(ulong value);Â Â Â Â Â Â Â Â Â Â  // Writes unsigned long using VLQ
Â Â  intÂ Â Â Â Â Â Â Â Â Â Â Â Â Â  ReadVarInt();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Reads signed int using ZigZag + VLQ
Â Â  uintÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadVarUInt();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Reads unsigned int using VLQ
Â Â  longÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ReadVarLong();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Reads signed long using ZigZag + VLQ
Â Â  ulongÂ Â Â Â Â Â Â Â Â Â Â Â  ReadVarULong();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Reads unsigned long using VLQ

public: // Buffer management
Â Â  voidÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Clear();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Clears buffer content and resets state
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â GetFinalizedBuffer(ulong &destinationArray[]); // Copies buffer content to array
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â SetRawBuffer(const ulong &sourceBuffer[]);Â Â Â Â  // Sets buffer content from array
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Save(string filename);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Saves buffer to file
Â Â  boolÂ Â Â Â Â Â Â Â Â Â Â Â Â Â Load(string filename);Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Loads buffer from file

public: // Error handling
Â Â  ENUM_BIT_BUFFER_ERROR GetLastError();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Returns last error code
Â Â  stringÂ Â Â Â Â Â Â Â Â Â Â Â GetLastErrorString();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Returns error description string
Â Â  voidÂ Â Â Â Â Â Â Â Â Â Â Â Â Â ClearLastError() ;Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â // Clears last error

Â Â  voidÂ Â Â Â Â Â Â Â Â Â Â Â Â Â PrintHex();Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â Â  // Prints main buffer in hex (debugging)
Â Â };
```

The complete test exampleÂ "**CBitBuffer\_Test.mq5"**Â provided above is the best way to detect errors and verify the class's capabilities.

The header file "**TicksShort.mqh**" provides an alternative implementation of '[TicksShort](/ru/code/61126)' tick compression library by fxsaber, utilizing VLQ encoding from 'CBitBuffer' class.

Updates:

2025.07.21 - v.1.01 :

* The CBitBuffer class actively prevents illegal attempts to write after a read operation has begun, which helps in maintaining data integrity.
* Users receive a specific error (BIT\_BUFFER\_MIXED\_OPERATION\_ERROR) when they attempt to mix operations.

2025.07.22 - v.1.02 :

* Changed design of the class to allow the mixed read/write operations, by correct handling of partialÂ flushes/refills, which helps in maintaining data integrity when switching between read and write modes.
* Removed the variable (m\_operationMode) and the error code (BIT\_BUFFER\_MIXED\_OPERATION\_ERROR).
* Cleaned the code comments for better clarity of intent.
* Updated examples in "CBitBuffer\_Test.mq5" to cover more test cases.

**Last comments |
[Go to discussion](/en/forum/491472)**
(19)

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
10 Oct 2025 at 07:19

To implement faster range queries (from time, to\_time) in TIICKS\_STREAM, the encoding scheme has to be changed so that instead of encoding into a single block:

1. we encode ticks into chunks of certain size (eg 5000-10000 ticks/chunk) or time range (one week or month) and write a small header containing: [numer of ticks in chunk, start time, end time, chunk size in bytes].

2. Build an index of those headers, where each [entry in](/en/docs/constants/tradingconstants/dealproperties#enum_deal_entry "MQL5 documentation: Deal Properties") the index has the same header information + byte offset into the compressed buffer.

3. Write the index as a single stream of bytes at the end of the compressed data buffer or into a separate index file.

For time range queries (decoding):

1. we use linear or better binary search on the headers' index to get the start and end block indices for the from\_time and to\_time.

2. Decompress only ticks spanning these blocks with some filtering of the excess ticks from start and end blocks.

3. Additionally: an LRU (least recently used) cache can be built in memory to cache for example the last 10 used blocks in decompressed form.

So at the end we can build our version of CopyTicksRange() on the compressed buffer.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/en/users/fxsaber)**
|
11 Oct 2025 at 06:55

**amrali [#](/en/forum/491472/page2#comment_58228491):**  

Â  Allows reading ticks sequentially (tick-by-tick) from compressed memory or file without full decompression

You can do the same thing by recording tick by tick.

Is a zigzag necessary for a time delta?

```mql5
//Â Â Â Â Â Â Â Â  VLQWrite(buf, pos, ZigZagEncode(t - prev_time)); // ZigZag + VLQ encode each delta
Â Â Â Â Â Â Â Â  VLQWrite(buf, pos, t - prev_time);
```

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
11 Oct 2025 at 07:50

**fxsaber [#](/en/forum/491472/page2#comment_58243817):**  

You can do the same thing by recording tick by tick.

I showed you how it can be done with VLQ. Feel free to modify the code if you're planning to use it. I know how to do it myself. I don't have plans to extend the demo example on the codebase.

Thanks ğŸ˜Š.

![hini](https://c.mql5.com/avatar/2024/3/65e98921-0708.jpg "hini")

**[hini](/en/users/hini)**
|
11 Oct 2025 at 09:03

**fxsaber [#](/en/forum/491472/page2#comment_58243817):**  
 Is a zigzag necessary for a time delta?

For time differences that are guaranteed to be non-negative, using VLQ encoding directly is the optimal choice, as it is both simple and efficient. ZigZag encoding is only an necessary extra step when you need to handle integers that can be both positive and negative. I suppose the author used ZigZag to ensure the data could still be used correctly in the occasional exceptional case where a time difference is negative?

![amrali](https://c.mql5.com/avatar/2021/7/60EB6C17-183F.jpg "amrali")

**[amrali](/en/users/amrali)**
|
11 Oct 2025 at 10:22

**fxsaber [#](/en/forum/491472/page2#comment_58243817):**

Is a zigzag necessary for a time delta?

Not strictly necessary, but acts as a guard against bad programming:

```mql5
Â Â  MqlTick ticks[];
Â Â  ArraySetAsSeries(ticks, true);
Â Â  CopyTicks(Symbol(), ticks);
```

Zigzag can be removed for time delta to gain extra performance. However, the gain is negligible.

![Crash Spike Trade Pattern](https://c.mql5.com/i/code/indicator.png)
[Crash Spike Trade Pattern](/en/code/61729)

This indicator detects a specific bearish spike formation over 3 candles

![Creat Button Close BuySell On Chart](https://c.mql5.com/i/code/script.png)
[Creat Button Close BuySell On Chart](/en/code/61708)

MQL5 script for MetaTrader 5 that adds two buttons to close all buy or sell positions for the current symbol.

![Boom Index Spike Pattern](https://c.mql5.com/i/code/indicator.png)
[Boom Index Spike Pattern](/en/code/61749)

This MetaTrader 5 (MT5) custom indicator, boomSpikeBoxMitigationFinal.mq5, detects a specific bullish spike pattern on the chart and marks entry zones using rectangles and horizontal lines. Once the price returns to ("mitigates") the entry level, the entry line is shortened to the mitigation point.

![Seven strategies in One expert](https://c.mql5.com/i/code/expert.png)
[Seven strategies in One expert](/en/code/61921)

Name of expert is 'MultiStrategyEA'