# N Candles v4 - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/18609

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Twitter](https://x.com/mql5com)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/18609) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# N Candles v4 - expert for MetaTrader 5

[Vladimir Karputov](/en/users/barabashkakvn)  |
[English](javascript:void(false);)

[Русский](/ru/code/18609) [中文](/zh/code/18609) [Español](/es/code/18609) [Deutsch](/de/code/18609) [日本語](/ja/code/18609) [Português](/pt/code/18609)

Views:
:   5345

Rating:
:   (31)

Published:
:   10 August 2017, 12:47

Updated:
:   27 June 2018, 14:39
:   [N Candles v4.mq5](/en/code/download/18609/n_candles_v4.mq5 "N Candles v4.mq5")
    (33.28 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/18609.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

The Expert Advisor searches for N identical candlesticks in a row. It buys on bullish candlesticks and sells on bearish ones. The account type is taken into account, i.e. whether it is netting or hedging. The CPositionInfo, CTrade and CSymbolInfo classes are used in the code.

Version 1: [N Candles](/en/code/18023 "N Сandles - expert for MetaTrader 5").

Version 2: [N Candles v2](/en/code/18219 "N Candles v2 - expert for MetaTrader 5").

Version 3: [N Candles v3](/en/code/18575 "N Candles v3 - expert for MetaTrader 5").

New in version 4: on netting accounts, the "maximum position volume" parameter is used instead of "maximum number of items".

### Inputs

* N identical candles in a row.
* Lot.
* Take Profit (pips).
* Stop Loss (pips).
* Trailing Stop ("0" -> not used).
* Trailing Step (if trailing stop >0).
* Max positions certain direction (only for the hedging mode).
* Max position volume (only for the netting mode).
* Magic.
* Slippage.

An example of EA operation on a netting account:

![N-_Candles_v4 Si-9.17](https://c.mql5.com/18/60/N-_Candles_v4_Si-9.17.png "N-_Candles_v4 Si-9.17")

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/18609](/ru/code/18609)

**Last comments |
[Go to discussion](/en/forum/213153)**
(16)

![issah5](https://c.mql5.com/avatar/avatar_na2.png "issah5")

**[issah5](/en/users/issah5)**
|
11 Feb 2018 at 16:33

Good day! If possible, please make the following improvements in version 5:

- additional function - closing an order not by TP and SL (let's say EA checks N [number of bars](/en/docs/series/bars "MQL5 documentation: Bars function"), opens BUY, checks if N+1 bar is better, then waits for N+2 bar, etc.... if the last bar is worse than the previous one - closes the order. SELL

- dynamic lot

- time trading

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
11 Feb 2018 at 16:35

**issah5:**  

\*\*\*

- additional function - order closing not TP and SL (let's say EA checks N [number of bars](/en/docs/series/bars "MQL5 documentation: Bars function"), opens BUY, checks if N+1 bar is better, then waits for N+2 bar, etc.... if the last bar is worse than the previous one - closes the order. Also SELL

\*\*\*

I don't get it at all. Could you please elaborate?

![issah5](https://c.mql5.com/avatar/avatar_na2.png "issah5")

**[issah5](/en/users/issah5)**
|
11 Feb 2018 at 16:51

**Vladimir Karputov:**  

I don't get it at all. Could you elaborate?

Figuratively. The [Expert Advisor](https://www.mql5.com/en/market/mt5/ "A Market of Applications for the MetaTrader 5 and MetaTrader 4") checks 5 identical candles in a row. If all of them are the same, it opens SELL or BUY accordingly. When the next candle (the sixth candle) is formed, it checks it. If it is the same as when it was opened - we wait for the next candle, etc. If the candle is "bad" )) - forcibly close it. TP and SL are not needed in this case.

![Vladimir Karputov](https://c.mql5.com/avatar/2024/2/65d8b5a2-f9d9.jpg "Vladimir Karputov")

**[Vladimir Karputov](/en/users/barabashkakvn)**
|
12 Feb 2018 at 09:48

**issah5:**  

Figuratively. The Expert Advisor checks 5 identical candles in a row. If all of them are the same, it opens SELL or BUY accordingly. When the next candle (sixth candle) is formed, it checks it. If it is the same as when it was opened - we wait for the next candle, etc. If the candle is "bad" )) - forcibly close. TP and SL are not needed in this case.

Now it is clear. The Expert Advisor itself initially does not take into account the [type of candle](/en/articles/101 "Article: Research of Japanese candlestick patterns (patterns)") (more precisely, there is no such input parameter, just if N candles are bearish, we open BUY, if N candles are bearish, we open SELL) - it counts only the number of identical candles. You propose to introduce a setting, let's call it "lousy sheep", which will take into account the type of these identical candles and as soon as a "bad" candle is encountered - automatically closes all positions.

Added.

I suggest such types of closing at meeting of "lousy sheep":

* closing all positions
* closing positions that are opposite to the "lousy sheep"
* closing positions that have the same direction as the "lousy sheep"

![issah5](https://c.mql5.com/avatar/avatar_na2.png "issah5")

**[issah5](/en/users/issah5)**
|
12 Feb 2018 at 13:56

**Vladimir Karputov:**  

Now it is clear. The Expert Advisor itself initially does not take into account the [type of candle](/en/articles/101 "Article: Research of Japanese candlestick patterns (patterns)") (or rather there is no such input parameter, just if N candles are bearish, we open BUY, if N candles are bearish, we open SELL) - it counts only the number of identical candles. You suggest introducing a setting, let's call it "lousy sheep", which will take into account the type of these identical candlesticks and as soon as a "bad" candlestick is encountered, it will automatically close all positions.

Added.

I propose such types of closing at meeting "lousy sheep":

* closing all positions
* closing positions that are opposite to the "lousy sheep"
* closing positions that have the same direction as the "lousy sheep"

Yes... that's exactly right. Thank you!

![Boa_ZigZag_Arrows](https://c.mql5.com/i/code/indicator.png)
[Boa\_ZigZag\_Arrows](/en/code/18604)

The Boa\_ZigZag zigzag, with values displayed as fractal labels.

![Boa_ZigZag_Price](https://c.mql5.com/i/code/indicator.png)
[Boa\_ZigZag\_Price](/en/code/18603)

The Boa\_ZigZag indicator with price labels of the ZigZag peak values.

![Color_QEMA_Envelopes_Digit](https://c.mql5.com/i/code/indicator.png)
[Color\_QEMA\_Envelopes\_Digit](/en/code/18615)

Envelopes using the Color\_QEMA\_Digit MA, with an indication of trend direction and display of the last values of channel borders.

![Color_PEMA_Envelopes_Digit](https://c.mql5.com/i/code/indicator.png)
[Color\_PEMA\_Envelopes\_Digit](/en/code/18616)

Envelopes using the Color\_PEMA\_Digit MA, with an indication of trend direction and display of the last values of channel borders.