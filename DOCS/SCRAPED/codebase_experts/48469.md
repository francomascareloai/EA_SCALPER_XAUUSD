# Take Profit based on current profit - library for MetaTrader 4

Source: https://www.mql5.com/en/code/48469

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/48469) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Libraries](https://c.mql5.com/i/code/library.png)

# Take Profit based on current profit - library for MetaTrader 4

[Luca Cerquatelli](/en/users/lucacerquatelli-gmail)

Views:
:   6037

Rating:
:   (6)

Published:
:   3 March 2024, 10:44

Updated:
:   27 June 2024, 12:38
:   \MQL4\Include\

    [Current\_profit\_take\_profit.mqh](/en/code/download/48469/current_profit_take_profit.mqh "Current_profit_take_profit.mqh")
    (4.28 KB)
    [view](# "view")

    [Current\_profit\_take\_profit.mq4](/en/code/download/48469/current_profit_take_profit.mq4 "Current_profit_take_profit.mq4")
    (2.39 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/48469.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

### Introduction

Many Expert Advisors (EAs) tend to close orders at the take profit level, considering the pip distance from the purchase price. However, the code used by [EA Grid Girl](/en/market/product/115850) is based mainly on the current profit . This approach allows you to easily manage the take profit with multiple open positions, monitoring the total current profit based on the magic number, in case you use multiple bot instances or different EAs simultaneously . **[Add me to your friends](/en/users/lucacerquatelli-gmail)** and follow my feed to be updated on the news!

Using this code can also have a positive impact on some problems that may occur when using a take profit based on pips. For example, a pip-based take profit could change depending on the slippage of your broker, limiting profits . By using a code based on current profit, you can avoid this issue and have more control over your trades.

If you want to learn more about how to set up a take profit based on current profit, you can use the code of EA SwingBot as a reference.

…

### Total orders

Let's start with the code that calculates the total number of open orders with the same magic number.

The magic number is a unique identifier assigned to an order by the trader or an EA (Expert Advisor).

The code initializes a variable **total\_orders** to zero. It then loops through all the open orders using a for loop and selects each order using the **OrderSelect()** function. If an order is successfully selected, it increments the**total\_orders** variable by one.

```mql5
//----------------- 
   int total_orders = 0;
   for(int i = 0; i < OrdersTotal(); i++)
     {
      if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
        {
         if(OrderMagicNumber() == MagicNumber)
         {
         total_orders++;
        }
        }
     }
```

…

  

### Calculating Current Profit

The code initializes two variables: **ProfittoMinimo** and **Profit**. The variable **ProfittoMinimo** is used to activate the take profit at this level, the value is expressed in the currency of the account. The variable **Profit** is used to accumulate the current profit of all open positions that have the same magic number. The variable **StopLoss** is used for the stop loss.

The code uses a for loop to iterate through all open positions using the **OrdersTotal()** function. For each open position, the corresponding order is selected using the **OrderSelect()** function. If the order is successfully selected and has the same magic number, the profit of the order is added to the **Profit** variable.

```mql5
      double ProfittoMinimo = 3; // target profit
      double Profit = 0; // current profit
      


      for(int i=0; i<OrdersTotal(); i++)
        {
         if(OrderSelect(i, SELECT_BY_POS, MODE_TRADES))
           {
            if(OrderMagicNumber() == MagicNumber) // In case of multiple EAs, you can remove the MagicNumber filter to maintain the function on the total orders
              {
               Profit += OrderProfit();
              }
           }
        }
```

The minimum profit can be set as an external variable and configured in the EA options:

![Minimum Profit](https://c.mql5.com/18/154/Cattura1.JPG "Minimum Profit")

…

  

### Closing positions if the Profit is reached

The code uses a for loop to iterate through all open orders using the **OrdersTotal()** function. The loop starts from the last order and goes up to the first order. For each order, the corresponding trade is selected using the **OrderSelect()** function.

If the selected trade has the same symbol as the current chart, is of type **OP\_BUY**, and has the same magic number as specified in the code, it checks if the **Profit** of the trade is greater than or equal to **ProfittoMinimo**. If it is, it closes the trade at the bid price using the **OrderClose()**function and prints a message indicating that the buy order has been closed.

Similarly, if the selected trade has the same symbol as the current chart, is of type **OP\_SELL**, and has the same magic number as specified in the code, it checks if the **Profit** of the trade is greater than or equal to **ProfittoMinimo**. If it is, it closes the trade at the ask price using the **OrderClose()** function and prints a message indicating that the sell order has been closed.

```mql5
      for(int e = OrdersTotal() - 1; e >= 0; e--)
        {
         if(OrderSelect(e, SELECT_BY_POS, MODE_TRADES))
           {
            if(OrderSymbol() == Symbol() && OrderType() == OP_BUY && OrderMagicNumber() == MagicNumber) // l’ordine viene modificato solo se il MagicNumber corrisponde a quello dell’ordine in corso.
              {
               if(Profit >= ProfittoMinimo)
                 {
                  OrderClose(OrderTicket(), OrderLots(), ND(OrderClosePrice()), 3); // Bid price
                  Print("Buy order closed", Profit, " - Stoploss minimo: ",MarketInfo(Symbol(), MODE_STOPLEVEL));
                 }
              }

            if(OrderSymbol() == Symbol() && OrderType() == OP_SELL && OrderMagicNumber() == MagicNumber)
              {
               if(Profit >= ProfittoMinimo)
                 {
                  OrderClose(OrderTicket(), OrderLots(), ND(OrderClosePrice()), 3); // Ask price
                  Print("Sell order closed", Profit, " - Stoploss minimo: ",MarketInfo(Symbol(), MODE_STOPLEVEL));
                 }
              }
           }
        }
```

…

### Conclusion

This code could be useful for all those position-closing strategies based on take profit, but it could also be combined with a trailing stop based on the increase in current profit. The system is also useful in case of multiple Expert Advisors. If you exclude the **if** condition on the MagicNumber, you can set general take profit levels to simultaneously control all open positions from all active EAs

**[Go to discussion](/en/forum/463452)**

![Buy Sell Close Manual trading EA for trading newbies](https://c.mql5.com/i/code/expert.png)
[Buy Sell Close Manual trading EA for trading newbies](/en/code/48412)

[@Buy\_Sell\_Close] Manual trading EA for trading newbies, EA can be used in backtesting visual mode, EA can also be used in live trading.
You can practice your own trading system in backtesting.

![Adaptive Volatility Analysis](https://c.mql5.com/i/code/indicator.png)
[Adaptive Volatility Analysis](/en/code/48169)

AVA adapts its analysis based on current market dynamics. This adaptability makes it invaluable for predicting shifts towards higher volatility or calmer periods.

![Divergences Template Indicator](https://c.mql5.com/i/code/indicator.png)
[Divergences Template Indicator](/en/code/48583)

This is a indicator to plot hidden and regular divergences on chart.

![Moving Averages-14 different types](https://c.mql5.com/i/code/indicator.png)
[Moving Averages-14 different types](/en/code/48621)

This is an indicator to calculate 14 types of moving averages based on close price.