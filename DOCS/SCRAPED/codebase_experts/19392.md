# Self Optimizing RSI or MFI Trader - expert for MetaTrader 4

Source: https://www.mql5.com/en/code/19392

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/19392) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Self Optimizing RSI or MFI Trader - expert for MetaTrader 4

[John Davis](/en/users/johnthe)

Views:
:   74519

Rating:
:   (81)

Published:
:   16 November 2017, 06:56

Updated:
:   26 February 2019, 20:40
:   [SelfOptimizingRSIorMFITrader\_v3.mq4](/en/code/download/19392/selfoptimizingrsiormfitrader_v3.mq4 "SelfOptimizingRSIorMFITrader_v3.mq4")
    (21.19 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/19392.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

It is a dream of mine to have a robot that optimized itself, that way I would know that it was always working with the best values. This is my humble attempt to bring a piece of my dream into reality. The attached expert advisor optimizes the overbought and oversold levels that it uses to make trades. It is my wish that others could take this concept and expand on it to create something even greater if you do, please let me know about it. Also, don't forget to rate my robot using the stars above. This strategy is applicable to any currency pair using any time frame with of course the correct settings.

There are quite a few inputs listed for this robot. I've included some extra features, that I like to play around with, enjoy.

### Inputs

* **magic = 4376** - Unique number for this EA.
* **optomizingPeriods = 144** - Optimization periods (bars). This is the number of bars you would like the optimization to run on. For example, if you are using an hourly chart and you choose 144, the robot will look back 144 hours which equates to six days.
* **inAggressive = false** - Make expert aggressive? Risky. Aggressive mode will cause the expert advisor to take trades in a more aggressive manner. Instead of waiting for a cross of the overbought or oversold level in the aggressive mode the robot will take a buy trade simply if the buys have been more profitable than the sells lately and vice versa.
* **inTradeReverse = false** - Reverse trading. Reverse trading will switch the direction of your trades.
* **inOneOrderAtATime = true** - Only one order open at a time?. If true the robot will only have one order at a time, if false it will open unlimited amounts of order according to entry conditions.

* **Lot\_sizing\_dynamic\_invalidates\_static** - Simply a spacer to separate Lot sizing mechanics from the other inputs.
* **Lots = 0.01** - Static Lot size of orders. Specify the lot size for your orders using a static number.
* **inUseDynamicLotSize = true** - Use Dynamic lot sizing. Turns on dynamic lot sizing which would be used instead of static lot sizing, However, if the dynamic lots size proves to be invalid the robot will default to the static lot size.
* **inPercentageOfRisk = 2** - Balance % to risk on each trade (2 = 2%). When using dynamic lot sizing you specify your lot size as a percentage of your balance. 2 is equal to 2 percent. No need to enter 0.02 if you do enter it in that way the percentage used would be very small indeed. The maximum percentage that can be used is 10 percent.

* **Index\_Indicator\_Values** - Simply a spacer to separate index indicator parameters from other inputs.
* **indicator index = \_RSI\_** - Choose which index indicator to use. Allow you to choose which indicator you would like to use current choices are Relative Strength Index (RSI) or Money Flow Index (MFI).
* **IndicatorTopValue = 100** - Top most value you would trade at. This the uppermost value you would place a trade at using your indicator. Leave it at 100 to consider all the index indicator values.
* **IndicatorBottomValue = 0** - Bottom most value you would trade at. This is the bottom-most value you would place a trade at using your indicator. Leave it at 0 to consider all the index indicator values.
* **IndyTimeframe = PERIOD\_CURRENT** - Timeframe for index. Select which time frame you would like to use for the indicator during optimization and trading. PERIOD\_CURRENT simply means that it would use the time frame of the chart that you attach the expert advisor to. You could theoretically use a time frame for your calculations that is different from the chart you attach the robot to if you wish to do so here is where you would change that setting.
* **inIndyPeriods = 14** - Averaging period for index and ATR calculations. Average True Range (ATR) is used in setting a dynamic stop-loss or take-profit in further input options below.
* **IndyAppPrice = PRICE\_CLOSE** - Applied price for index if needed.

* **SL\_TP\_Dynamic\_invalidates\_static\_values** - Simply a spacer to separate stop loss and take profit parameters from other inputs.
* **iStoploss = 1000** - Static Stoploss value in points. Stop loss values are in points which is the smallest unit of movement in your terminal.
* **iTakeprofit = 2000** - Static Takeprofit value in points. Take profit values are in powhich is the smallest unit of movement in your terminal.
* **input inDynamic = true** - Use Dynamic sp & tp based on ATR multiple? If you turn on the dynamic stop loss and take profit they will be used instead of the static stop loss or take profit. Dynamic settings can be attractive because they have the ability to adjust according to market behavior. Since the ATR is larger when there is more movement, using dynamic would result in larger stop losses and take profits when the market is moving fast and closer settings when the market has slowed down.
* **inStoplossMultiple = 2** - Dynamic SL = X \* ATR (Averaging Period). The stop loss will be the value you place here multiplied by the Average True Range (ATR) using the periods specified in the **inIndyPeriods** - input setting.
* **inTakeProfitMultiple = 7** - Dynamic TP = X \* ATR (Averaging Period). The take profit will be the value you place here multiplied by the Average True Range (ATR) using the periods specified in the **inIndyPeriods** - input setting.
* **Break\_Even\_Settings** - Padding must be lower than Trigger. A separator for Break even settings. The way it works is when points in profits go above the trigger amount the stop loss is moved to break even. If you have a padding setting then the stop loss is moved to break even + padding to lock in the padding amount of profit.
* **bUseBreakEven = true** - Use Break Even (BE). Turn the use of break even on or off.
* **inTrigger = 200** - If BE = [true] set Points in profit to trigger. If the trade gets to these many points in profit the stop loss will be moved to break even.
* **inPadding = 100** - Padding points to add to BE must be lower than trigger. This is a number of points of profit you want to lock in when moving to break even, this amount must be less than the trigger.

How does this robot self-optimize? Here is the secret, the robot tests each variable in the index indicator twice, so if an indicator has one hundred possible values it takes each value and tries to perform a trade at that value going back a certain number of bars (**optomizingPeriods)**. Then it grades that value by how much money it would have won or lost by trading at that value. It is a bit more complex than that, but you are reading this to get more details so here it is as follows.

The givens are that when an indicator crosses the overbought value from the top, a sell order is issued, a buy order is issued when an indicator crosses from below an oversold value to above an oversold value. For example, if overbought was set to 80 and the value of your indicator was 85 on the bar before last and the value of the indicator on the last bar was 79 then a sell order would be issued. 85 → 79 crosses 80 downwards, sell order issued. If oversold = 23 then 19 → 27 upwards would create a buy order.

So, this robot takes every value for the indicator from the **IndicatorTopValue** - and **IndicatorBottomValue** - and runs a test, two tests more specifically. It runs a buy and sell test on each value. For example, if the top value is 100 it takes the top value and backtests it on the **optomizingPeriods**, let's say that is 144 periods. So it would see if buying at 100 and selling at 100 would have been profitable in the last 144 periods. If it is profitable, it retains that dollar amount.

Considering how many periods you are back testing it may have had the opportunity to buy multiple times during the backtest. If it hits the take profit before it hits the stop loss then it would have a profitable result if it hits the stop loss before the take profit it has a negative result. After testing all the periods in the **optomizingPeriods** - it adds all the profitable results with all the losses to retain a monetary value. Then the indicator moves on to the next lower indicator value and tests it for profitability.

When it has tested all the values it selects the value with the highest monetary amount and chooses it as the optimal buy-value. Next, it performs similar checks for the sell-value. When this is complete it compares the best buy-value with the best sell-value and looks for a trade that is the best of the best. So for example after running this optimization it determines that the best buy would be at 65 because a buy at 65 generated the most profit for buys, lets say $329 in backtesting it would check the value it has for best sell, and if best sell was 32 with a profit of $530 the robot would look for sell trade with the indicator crossing the 32 level because to sell is better than to buy according to profits generated in the backtest.

### The Future Expansion Ideas

* Trade multiple currency pairs at the same time, possibly filtered by spread size.
* Self-learning, whereby it learns from its own trades what is best.
* Backtesting could also include a forward testing component.
* More indicators to choose from.

Please leave your suggestions and comments, and don't forget to rate!

Now available in the MetaTrader marketplace: [https://www.mql5.com/en/market/product/26332](/en/market/product/26332)

Updated with missing brackets in lines 137-142 to resolve error identified in comments.

**Last comments |
[Go to discussion](/en/forum/219871)**
(29)

![h.heathan](https://c.mql5.com/avatar/avatar_na2.png "h.heathan")

**[h.heathan](/en/users/h.heathan)**
|
13 Feb 2020 at 20:14

im fairly new to using EAs ive been doing forex manually for a bit now. do i need to have rsi open on a chart for this to work properly?

![h.heathan](https://c.mql5.com/avatar/avatar_na2.png "h.heathan")

**[h.heathan](/en/users/h.heathan)**
|
18 Feb 2020 at 06:28

hi still new to using EAs are these parameters listed below what you changed about the EA? also wondering where can i find these if
so.

**Ahto Kiik:**  

Hi, looking good!

i tried settings on eur/usd 5 min chart and got only winning results. from 100 eur to 5000+ with 1 year [backtest](/en/articles/2612 "Article \"Testing trading strategies on real ticks\"").
Next ill test it on demo trading next week to see real results.

magic=4376

magic,F=1

magic,1=4376

magic,2=0

magic,3=0

optomizingPeriods=360

optomizingPeriods,F=1

optomizingPeriods,1=360

optomizingPeriods,2=1

optomizingPeriods,3=1490

inAggressive=1

inAggressive,F=0

inAggressive,1=1

inAggressive,2=-1

inAggressive,3=0

inTradeReverse=0

inTradeReverse,F=0

inTradeReverse,1=1

inTradeReverse,2=-1

inTradeReverse,3=0

inOneOrderAtATime=0

inOneOrderAtATime,F=0

inOneOrderAtATime,1=0

inOneOrderAtATime,2=1

inOneOrderAtATime,3=1

Lot\_sizing\_dynamic\_invalidates\_static=

Lots=0.01000000

Lots,F=0

Lots,1=0.01000000

Lots,2=0.00000000

Lots,3=0.00000000

inUseDynamicLotSize=1

inUseDynamicLotSize,F=0

inUseDynamicLotSize,1=1

inUseDynamicLotSize,2=-1

inUseDynamicLotSize,3=0

inPercentageOfRisk=2.00000000

inPercentageOfRisk,F=0

inPercentageOfRisk,1=2.00000000

inPercentageOfRisk,2=0.00000000

inPercentageOfRisk,3=0.00000000

Index\_Indicator\_Values=

index=1

index,F=0

index,1=0

index,2=0

index,3=0

IndicatorTopValue=100

IndicatorTopValue,F=0

IndicatorTopValue,1=100

IndicatorTopValue,2=0

IndicatorTopValue,3=0

IndicatorBottomValue=0

IndicatorBottomValue,F=0

IndicatorBottomValue,1=0

IndicatorBottomValue,2=0

IndicatorBottomValue,3=0

IndyTimeframe=1440

IndyTimeframe,F=0

IndyTimeframe,1=0

IndyTimeframe,2=0

IndyTimeframe,3=0

inIndyPeriods=14

inIndyPeriods,F=0

inIndyPeriods,1=36

inIndyPeriods,2=1

inIndyPeriods,3=149

IndyAppPrice=0

IndyAppPrice,F=0

IndyAppPrice,1=0

IndyAppPrice,2=0

IndyAppPrice,3=0

SL\_TP\_Dynamic\_invalidates\_static\_values=

iStoploss=1000

iStoploss,F=0

iStoploss,1=1000

iStoploss,2=0

iStoploss,3=0

iTakeprofit=2000

iTakeprofit,F=0

iTakeprofit,1=2000

iTakeprofit,2=0

iTakeprofit,3=0

inDynamic=1

inDynamic,F=0

inDynamic,1=0

inDynamic,2=1

inDynamic,3=1

inStoplossMultiple=2.00000000

inStoplossMultiple,F=0

inStoplossMultiple,1=2.00000000

inStoplossMultiple,2=0.00000000

inStoplossMultiple,3=0.00000000

inTakeProfitMultiple=7.00000000

inTakeProfitMultiple,F=0

inTakeProfitMultiple,1=7.00000000

inTakeProfitMultiple,2=0.00000000

inTakeProfitMultiple,3=0.00000000

Break\_Even\_Settings=

bUseBreakEven=0

bUseBreakEven,F=0

bUseBreakEven,1=0

bUseBreakEven,2=1

bUseBreakEven,3=1

inTrigger=200

inTrigger,F=0

inTrigger,1=200

inTrigger,2=0

inTrigger,3=0

inPadding=100

inPadding,F=0

inPadding,1=100

inPadding,2=0

inPadding,3=0

![Nguyen Quoc Vinh Huynh](https://c.mql5.com/avatar/2020/10/5F95CB44-29FC.JPG "Nguyen Quoc Vinh Huynh")

**[Nguyen Quoc Vinh Huynh](/en/users/alizee08)**
|
7 Aug 2020 at 05:56

hi may i know what set to use?

![rr1827](https://c.mql5.com/avatar/avatar_na2.png "rr1827")

**[rr1827](/en/users/rr1827)**
|
8 Aug 2020 at 21:51

Thanks. Can you please code for trailing stop?

![Ahmed Alaaeldin Abdulrahman Ahmed Elherzawi](https://c.mql5.com/avatar/2022/4/6262CCCB-C059.jpg "Ahmed Alaaeldin Abdulrahman Ahmed Elherzawi")

**[Ahmed Alaaeldin Abdulrahman Ahmed Elherzawi](/en/users/ahmedalaaeldin)**
|
4 Dec 2022 at 09:50

5 stars for your positive spirit, great idea and for sharing the code.

![Multi Timeframe Triple Moving Averages](https://c.mql5.com/i/code/indicator.png)
[Multi Timeframe Triple Moving Averages](/en/code/19315)

This indicator allows you to see the Moving Averages from different timeframes on the same chart. It helps you to spot the dynamic levels of support and resistance. It uses a custom window with check boxes to show/hide the different Moving Averages without need to access the indicator settings window.

![Robot_ADX+2MA](https://c.mql5.com/i/code/expert.png)
[Robot\_ADX+2MA](/en/code/9825)

Uses the analysis of 4 indicators.

![CEquityHstBar](https://c.mql5.com/i/code/library.png)
[CEquityHstBar](/en/code/19439)

CEquityHstBar - library for showing the equity of EA back-testing by the offline chart.

![SL&TP Values](https://c.mql5.com/i/code/indicator.png)
[SL&TP Values](/en/code/19479)

Indicator displays the value of defined stop loss and or take profit in the deposit currency.