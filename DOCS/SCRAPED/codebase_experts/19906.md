# Diff_TF_MA_EA - expert for MetaTrader 5

Source: https://www.mql5.com/en/code/19906

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/19906) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Diff\_TF\_MA\_EA - expert for MetaTrader 5

[Scriptor](/en/users/scriptor)  |
[English](javascript:void(false);)

[Русский](/ru/code/19906) [中文](/zh/code/19906) [Español](/es/code/19906) [Deutsch](/de/code/19906) [日本語](/ja/code/19906) [Português](/pt/code/19906)

Views:
:   4412

Rating:
:   (15)

Published:
:   1 March 2018, 11:53
:   [Diff\_TF\_MA\_EA.mq5](/en/code/download/19906/diff_tf_ma_ea.mq5 "Diff_TF_MA_EA.mq5")
    (39.78 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/19906.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

Expert Advisor signals are based on the common intersection of two MA lines. These are signals of the [Diff\_TF\_MA](/en/code/19835 "Diff_TF_MA - Moving Averages for two timeframes - indicator for MetaTrader 5") indicator:

* If the MA of the current timeframe crosses the MA line of the higher timeframe upwards, it is a signal to open a long position;
* If the MA of the current timeframe crosses the MA line of the higher timeframe downwards, it is a signal to open a short position.

An appropriate position is opened on one signal. The opposite position is closed.

The Expert Advisor is designed for working on hedging accounts. If you launch the EA on a netting account, a warning message will pop up and the EA will be unloaded.

The [indicator](/en/code/19835 "Diff_TF_MA - Moving Averages for two timeframes - indicator for MetaTrader 5") is not required for the EA operation, because calculations of required moving averages are implemented directly in the EA code.

The Expert Advisor can reverse indicator signals to open Sell instead of Buy and vice versa. You can also set stop loss and take profit in points. If invalid Stop Loss and Take Profit values are specified, the EA will adjust the values to the minimum **StopLevel** allowed for the symbol.

The Expert Advisor will also adjust the lot in case an incorrect value is specified. If the lot is too large, the EA will adjust it in order to be able to open a position. If there is no money for opening even the minimum lot, the signal will be skipped.

Please note that the Expert Advisor is designed for training purposes.

The EA has nine input parameters:

* **Experts magic number** - a unique identifier for the EA's positions;
* **Period of MA** - calculation period for the moving average of a higher timeframe (the calculation period of the current timeframe MA is selected automatically);
* **Timeframe of MA** - the timeframe for the Moving Average of a higher TF;
* **Reverse trade** - choosing the reverse mode (Yes, No): if Yes, a short position will open upon a long signal and vice versa;
* **Lots** - the volume of positions to open;
* **Stop loss in points** - the Stop Loss of a position in points;
* **Take profit in points** - the Take Profit of a position in points;
* **Slippage of price** - maximum allowable slippage when opening a position;
* **Multiplier spread for stops** - spread multiplier for calculating a correct distance for stop orders.

For Stop Loss and Take Profit orders (as well as pending orders), there is a minimum allowed distance for placing such orders - **StopLevel**. I.e. Stop Loss and Take Profit (as well as pending orders) cannot be placed closer than this distance to the price. If **StopLevel** is zero, it does not mean its absence, it only means that **StopLevel** is floating. In this case, the minimum distance is usually equal to spread\*, but sometimes even the double spread is not enough. So, this parameter allows specifying a custom multiplier for the spread used to calculate the minimum distance for placing stop orders.

To check the strategy, testing with default settings was performed using data in the interval from 2017.01.02 to 2018.01.19. Unfortunately, the EA did not show good results with default settings. Therefore, it was tested in the reverse mode. The results were better. Additionally, the **Period of MA** was optimized in the range from 1 to 20 with step 1. The best value when optimizing for the maximum balance was the period 8.

![](https://c.mql5.com/18/64/Diff_TF_MA_EA_res.png)

Fig.1 Testing result 2017.01.02 - 2018.01.19, period 8, reverse of trades is enabled

![](https://c.mql5.com/18/64/Diff_TF_MA_EA_graph.png)

Fig.2 Testing chart on 2017.01.02 - 2018.01.19, period 8, reverse of trades is enabled

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/19906](/ru/code/19906)

**Last comments |
[Go to discussion](/en/forum/229123)**
(49)

![Artyom Trishkin](https://c.mql5.com/avatar/2022/7/62C4775C-ABD6.jpg "Artyom Trishkin")

**[Artyom Trishkin](/en/users/artmedia70)**
|
2 Feb 2018 at 10:44

**fxsaber:**  

I replaced that.

[Serious mistake.](/ru/forum/226353#comment_6458737)

What's in the link:

This is the wrong logic. After a failed and successful OrderSend, the current trading environment should be completely read again. This rule should always apply.

It was discussed yesterday - there is no such error there. The environment is updated when a position is opened. And when an unsuccessful opening, the list does not change - why should it be raced?

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/en/users/fxsaber)**
|
2 Feb 2018 at 11:03

**Artyom Trishkin:**  

What's on the link:

This is the wrong logic. After a failed and successful OrderSend, the current trading environment should be completely read again. This rule should always apply.

It was discussed yesterday - there is no such error. The environment is updated when a position is opened. And when opening a position is unsuccessful, the list does not change - why should it race?

I've already realised that I can't change your mind.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/en/users/fxsaber)**
|
2 Feb 2018 at 11:22

**Rashid Umarov:**  
 The codes have been updated.

There's still

```mql5
double ll=trade.CheckVolume(symb,lot,symbol_info.Ask(),ORDER_TYPE_BUY);
```

![Rashid Umarov](https://c.mql5.com/avatar/2012/5/4FC60566-2EEC.jpg "Rashid Umarov")

**[Rashid Umarov](/en/users/rosh)**
|
2 Feb 2018 at 11:50

**fxsaber:**  

There's still

Won't re-read everything - meaning the cached value?

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/en/users/fxsaber)**
|
2 Feb 2018 at 11:52

**Rashid Umarov:**  

They won't reread everything - you mean the cached value?

Yes.

![ZeroLagMACD](https://c.mql5.com/i/code/indicator.png)
[ZeroLagMACD](/en/code/19897)

ZeroLagMACD is an MACD version, which has a much smaller lag compared to the classic MACD.

![ZeroLag](https://c.mql5.com/i/code/indicator.png)
[ZeroLag](/en/code/19896)

Zero Lag is a modified EMA.

![Percentage_Crossover_Channel_EA](https://c.mql5.com/i/code/expert.png)
[Percentage\_Crossover\_Channel\_EA](/en/code/19913)

An Expert Advisor, which trades in a channel based on the Percentage\_Crossover\_Channel indicator.

![NTK 07](https://c.mql5.com/i/code/expert.png)
[NTK 07](/en/code/19914)

Implementation of multiple trailing types. Pending Buy Stop and Sell Stop orders. Limitation of the maximum total lot and the total number of positions. Several types of position volume calculation.