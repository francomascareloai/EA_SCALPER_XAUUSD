# Dealing with time (2) functions - library for MetaTrader 5

Source: https://www.mql5.com/en/code/45287

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Telegram](https://t.me/mql5dev)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/45287) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Libraries](https://c.mql5.com/i/code/library.png)

# Dealing with time (2) functions - library for MetaTrader 5

[Carl Schreiber](/en/users/gooly)

Views:
:   6603

Rating:
:   (13)

Published:
:   5 July 2023, 12:50

Updated:
:   28 April 2024, 14:11
:   [Test\_DST 2.mq5](/en/code/download/45287/test_dst_2.mq5 "Test_DST 2.mq5")
    (3.04 KB)
    [view](# "view")

    [DST 1975 - 2030.zip](/en/code/download/45287/dst_1975_-_2030.zip "DST 1975 - 2030.zip")
    (20.15 KB)

    [DealingWithTime\_TestIndi.mq5](/en/code/download/45287/dealingwithtime_testindi.mq5 "DealingWithTime_TestIndi.mq5")
    (3.93 KB)
    [view](# "view")

    [DealingWithTime.mqh](/en/code/download/45287/dealingwithtime.mqh "DealingWithTime.mqh")
    (63.38 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/45287.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

The version of *DealingWithTime.mqh* v. 1.01 of the article "Dealing with Time (Part 2): The Functions" ([https://www.mql5.com/en/articles/9929](/en/articles/9929)) did not work any more because MQ changed the behavior of the *CopyTime()* function some time after this article was published. Now this function no longer returns future time values if they are greater than *TimeCurrent()* specified for the start\_time and/or stop\_time parameters. Instead, the opening time of the last, current bar is returned as the largest possible value.   
   
 Since the end of the FX session was determined in this way, among other things, in order to determine the offset of the broker time, this now results in incorrect values!

[![](https://c.mql5.com/18/147/3335251937667__1.png)](https://c.mql5.com/18/147/3335251937667.png "https://c.mql5.com/18/147/3335251937667.png")

On 01/01/1982 it is wintertime in the USA (DST==0) and the next changeover is on 04/25/1982, which is the last (25th of the month) Sunday of April (4). The table is already sorted by the geographic time zone (column A), then by the time zone of the year (column L, spr=spring, aut=autumn,), and finally by the query date (column C). The table can be created automatically by the included EA (a script cannot run in debug mode) *Test\_DST 2.mq5* if you run it in debug mode and copy the rows of the journal log in the debugger and paste them into a table program; the cell separator would be the space character.

Also, there is now a new, simple function *SecTillClose()* that gives you the remaining time in seconds (the time currency of MQ) until the forex market will close - without *CopyTime()*. This is interesting for those who want to close their positions before the weekend or do not want to enter a new position in a defined period of time before the weekend.  
   
 The included indicator *DealingWithTime\_TestIndi.mq5* shows as a comment on the chart not only the summer/winter time of Europe, USA and Australia (Sydney), but also current time and time shift of different cities. Here you can find a table of different local times of big cities for your comparison: [https://www.timeanddate.com/worldclock/](/go?link=https://www.timeanddate.com/worldclock/ "https://www.timeanddate.com/worldclock/"). You can thus check the values at any time. This indicator also demonstrates how these values are determined and used (what is subtracted or added from what), So it is easier to use it yourself - copy & paste, the fastest form of programming.  
   
 The last two lines also show the last second of the current FX session and the remaining time in hours (is easier to judge) and in seconds. If in NY on Fridays at 17:00 local time the FX session is closed, then there is no valid bar with an opening time 17:00 NY time. Therefore, 1 second is subtracted in this function to be able to get the last valid opening time of the last bar in the broker's time. However, some brokers end their FX session a few minutes earlier by not providing any more prices and not accepting any more trade orders.

![](https://c.mql5.com/18/147/5455172968299.png)

**Last comments |
[Go to discussion](/en/forum/450197)**
(55)

![Carl Schreiber](https://c.mql5.com/avatar/2018/2/5A745EEE-EB76.PNG "Carl Schreiber")

**[Carl Schreiber](/en/users/gooly)**
|
10 May 2024 at 13:49

**Anil Varma [#](/en/forum/450197/page5#comment_53329313):**  

Hi [@Carl Schreiber](/en/users/gooly)

There used to be methods to find First Bar and Last Bar of the day, do they still exist somewhere in your lib(s)? If true please share the link.

I remembered one of your post stating that they no longer works with updated Mql5 version, but not sure about it.

I am preparing a solution but I am packed with a range of jobs with deadlines...

![Anil Varma](https://c.mql5.com/avatar/2023/11/6561abd1-95bd.jpg "Anil Varma")

**[Anil Varma](/en/users/anilvarma)**
|
10 May 2024 at 15:10

**Carl Schreiber [#](/en/forum/450197/page6#comment_53329553):**  

I am preparing a solution but I am packed with a range of jobs with deadlines...

Thanks for reply and your consideration [@Carl Schreiber](/en/users/gooly)

![Matt C](https://c.mql5.com/avatar/avatar_na2.png "Matt C")

**[Matt C](/en/users/mkcorcoran2015)**
|
18 Jul 2024 at 11:14

Hi [@Carl Schreiber](/en/users/gooly)

I found your code useful!

I needed to write a function to convert between two time zones and used your code. I thought I would share my function here in case you or others can make use of it:

```mql5
#include <DealingWithTime.mqh>
```

```mql5
datetime timezone_conversions(string time_zone_known, string time_given, string time_zone_required)export{
   // https://www.mql5.com/en/code/45287
   // https://www.mql5.com/en/articles/9926
   // https://www.mql5.com/en/articles/9929

   datetime tGIVEN = StringToTime(time_given);  
   checkTimeOffset(tGIVEN); // check changes of DST

   // Get GMT:
   datetime tGMT = NULL;
   if(time_zone_known=="GMT"     ){tGMT = tGIVEN;}
   if(time_zone_known=="Broker"  ){tGMT = tGIVEN + OffsetBroker.actOffset;}
   if(time_zone_known=="NY"      ){tGMT = tGIVEN + (NYShift+DST_USD);}
   if(time_zone_known=="Lon"     ){tGMT = tGIVEN + (LondonShift+DST_EUR);}
   if(time_zone_known=="Ffm"     ){tGMT = tGIVEN + (FfmShift+DST_EUR);}
   if(time_zone_known=="Syd"     ){tGMT = tGIVEN + (SidneyShift+DST_AUD);}   
   if(time_zone_known=="Mosc"    ){tGMT = tGIVEN + (MoskwaShift+DST_RUS);}  
   if(time_zone_known=="Tok"     ){tGMT = tGIVEN + (TokyoShift);}  

   // define the required time:
   datetime tREQ = NULL;
   if(time_zone_required=="GMT"     ){tREQ = tGMT;}
   if(time_zone_required=="Broker"  ){tREQ = tGMT - OffsetBroker.actOffset;}
   if(time_zone_required=="NY"      ){tREQ = tGMT - (NYShift+DST_USD);}
   if(time_zone_required=="Lon"     ){tREQ = tGMT - (LondonShift+DST_EUR);}
   if(time_zone_required=="Ffm"     ){tREQ = tGMT - (FfmShift+DST_EUR);}
   if(time_zone_required=="Syd"     ){tREQ = tGMT - (SidneyShift+DST_AUD) ;}
   if(time_zone_required=="Mosc"    ){tREQ = tGMT - (MoskwaShift+DST_RUS);}
   if(time_zone_required=="Tok"     ){tREQ = tGMT - (TokyoShift);}      

   return tREQ;
}
```

Cheers

![Joseph George Trotter](https://c.mql5.com/avatar/2025/2/67a8ce69-aaa1.jpg "Joseph George Trotter")

**[Joseph George Trotter](/en/users/mentorjj)**
|
11 Mar 2025 at 23:30

if anyone gets the error " DealingWithTime\_TestIndi (BTCUSD,M15) [array out of range](https://www.mql5.com/en/articles/2555 "Article: The checks a trading robot must pass before publication in the Market ") in 'DealingWithTime.mqh' (275,59) " this may be due to the symbol you applied the indicator too. You need to use EURUSD instead or change the  DealingWithTime.mqh code

![Carl Schreiber](https://c.mql5.com/avatar/2018/2/5A745EEE-EB76.PNG "Carl Schreiber")

**[Carl Schreiber](/en/users/gooly)**
|
12 Mar 2025 at 06:59

Bitcoin and other cryptocurrencies do not follow the Forex session times, so you cannot use it.  
Also, some brokers have an incorrect method of switching from summer to winter time and vice versa, so this indicator won't work as well.  
  
You can check your broker with this script: [https://www.mql5.com/en/code/55056](https://www.mql5.com/en/code/55056 "https://www.mql5.com/en/code/55056")   
Again, it is based on Forex and not cryptocurrencies.

![Strength Index Signal](https://c.mql5.com/i/code/indicator.png)
[Strength Index Signal](/en/code/45033)

provides clear arrows which clearly show the direction of the currency pair.

![Indicator PriceScale.mq5 - price scale for the visually impaired.](https://c.mql5.com/i/code/indicator.png)
[Indicator PriceScale.mq5 - price scale for the visually impaired.](/en/code/44943)

Tortured small print in the terminal? This indicator makes price numbers visible!

![New Concept: Trailing Take Profit](https://c.mql5.com/i/code/expert.png)
[New Concept: Trailing Take Profit](/en/code/45379)

On contrast with Trailing Stop which a stop loss trails price until the price hits the stop loss and the position gets closed in profit, introducing Trailing Take Profit which take profit trails price when a position is in loss and ultimately the position gets closed with loss.

![Dynamic Support and Resistance](https://c.mql5.com/i/code/indicator.png)
[Dynamic Support and Resistance](/en/code/45435)

The "Dynamic Support and Resistance" Indicator is a versatile tool that combines support and resistance levels with real-time market dynamics. By incorporating previous daily highs and lows, it provides valuable insights into market psychology and identifies potential areas of price reversals or breakouts.
With its ability to adapt to changing market conditions and customizable options, traders can stay ahead of trends and make informed decisions. This indicator is suitable for various trading styles and timeframes, empowering both experienced and novice traders with a competitive edge.
## Check out new Liquidity Hunter EA that uses SMC : https://www.mql5.com/en/market/product/121106