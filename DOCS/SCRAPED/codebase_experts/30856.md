# ATR adaptive SMA - indicator for MetaTrader 4

Source: https://www.mql5.com/en/code/30856

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/30856) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Indicators](https://c.mql5.com/i/code/indicator.png)

# ATR adaptive SMA - indicator for MetaTrader 4

[Mladen Rakic](/en/users/mladen)

Views:
:   26451

Rating:
:   (24)

Published:
:   31 August 2020, 10:11

Updated:
:   31 August 2020, 10:24
:   [ATR adaptive SMA.mq4](/en/code/download/30856/atr_adaptive_sma.mq4 "ATR adaptive SMA.mq4")
    (14.24 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/30856.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

**sics**:

> One of the moving averages that is not often made adaptive is SMA (Simple Moving Average). The reason for that is that it is bound to bars values (unlike, for example EMA - that is used in numerous adaptive averages - that can use fractional periods too) and that makes the calculations a bit complicated and, in some cases the results are going to be "nervous" - they tend to changes slope in some periods very quickly.
>
> That makes it a bit difficult to use it too : using the slope of such an average as a criteria for a trading decision would lead to "change of mind" on almost every bar - and that is not what anybody would like to do. This version makes a possible solution for that : since adaptive SMA is "faster" than the "regular" SMA, you can use the crosses of adaptive to regular SMA as a criteria for trend. Results seem to be acceptable
>
> MT5 version of this indicator was published here :  [https://www.mql5.com/en/code/30844](/en/code/30844)

**Recommendations:**

* The indicator allows you to use :

+ classical slope change for color change
+ cross of tho SMAs (the adaptive and the "regular") as a criteria for color change - as described above

* You can use color change of the adaptive SMA as a signal for trend change

![](https://c.mql5.com/18/93/Capture_cb__2.png)

[![](https://c.mql5.com/18/93/Capture__5.png)](https://c.mql5.com/18/93/Capture__4.png "https://c.mql5.com/18/93/Capture__4.png")

**Last comments |
[Go to discussion](/en/forum/350119)**
(10)

![Michael Charles Schefe](https://c.mql5.com/avatar/2021/5/60ADC6A5-6810.gif "Michael Charles Schefe")

**[Michael Charles Schefe](/en/users/ausimike)**
|
16 Jul 2021 at 03:02

**Revo Trades:**  

but wont that mean that the function will only update 1 time per bar?

1) FYI for those trying to create include files: I found out I can import an indicator without creating an include file or a new function. Instead I used a mql command "resource". And I was able to import my external indicator into the ea, just as I would with an include or library file.

But, question for [@Mladen Rakic](/en/users/mladen) : I have used "resource" in add in 2 indicators, both have OnCalculate; my question: Is there any issue with having these 2 files with same Oncalculate? or do i need to only use 1 function Oncalculate?

![Rafael Campagnoni Prado Rocchi](https://c.mql5.com/avatar/2019/8/5D643B69-63F2.jpg "Rafael Campagnoni Prado Rocchi")

**[Rafael Campagnoni Prado Rocchi](/en/users/rrocchi)**
|
16 Jul 2021 at 14:51

**Revo Trades:**  
 [@Mladen Rakic](/en/users/mladen) I am having troubles converting this to an include file, specificly what do i do with rates\_total and prev? I would rather you suggest readings, than do the job for me. Thanks.

Rates\_total and prev cannot be put on the include file. They are part of the OnCalculate() function.

Get the content inside the OnCalculate, create a new function, put the contents inside it.

Erase the contents from the OnCalculate function.

Call your newly created function inside the OnCalculate.

Move your new function to the include .mqh file.

#include <the\_mqlfile.mqh> on your main app

It is done.

SImple.

PS: Create the respective parameters to pass to your new function. It depends on each indicator you will want to do this, as each one has its particular variables.

Pass them as function parameters.

![Michael Charles Schefe](https://c.mql5.com/avatar/2021/5/60ADC6A5-6810.gif "Michael Charles Schefe")

**[Michael Charles Schefe](/en/users/ausimike)**
|
16 Jul 2021 at 17:50

it is nt as easy as that for this indicator.

![Rafael Campagnoni Prado Rocchi](https://c.mql5.com/avatar/2019/8/5D643B69-63F2.jpg "Rafael Campagnoni Prado Rocchi")

**[Rafael Campagnoni Prado Rocchi](/en/users/rrocchi)**
|
21 Jul 2021 at 09:26

**Revo Trades:**  
 it is nt as easy as that for this indicator.

Yes it is as simple as that, I just give a look at the [source code](/go?link=https://forge.mql5.io/help/en/guide "MQL5 Algo Forge: Cloud Workspace for Algorithmic Trading Development") of it. It can be done under 15 minutes.

What is being your main problem right now? Still the rates\_total and Prev\_rates ?

![Michael Charles Schefe](https://c.mql5.com/avatar/2021/5/60ADC6A5-6810.gif "Michael Charles Schefe")

**[Michael Charles Schefe](/en/users/ausimike)**
|
27 Sep 2021 at 04:17

[@Mladen Rakic](/en/users/mladen) [@rrocchi](/en/users/rrocchi)

I am trying to add std deviation bands to this. See my attempt below and how it appears on the chart. I appreciate any advice on finding what i have done or have not done, and I prefer to find the solution myself if possible; but thanks to Mladen for creating the top 1 of 5 of my most used indicators.

```mql5
//------------------------------------------------------------------
#property copyright   "© mladen, 2020"
#property link        "mladenfx@gmail.com"
#property version     "1.00"
#property description "ATR adaptive"
//------------------------------------------------------------------
#property indicator_chart_window
#property indicator_buffers 6
#property indicator_label1  "SMA"
#property indicator_type1   DRAW_LINE
#property indicator_color1  clrWhite
#property indicator_label2  "ATR adaptive"
#property indicator_type2   DRAW_LINE
#property indicator_color2  clrBlue
#property indicator_width2  2
#property indicator_label3  "ATR adaptive"
#property indicator_type3   DRAW_LINE
#property indicator_color3  clrRed
#property indicator_width3  2
#property indicator_label4  "ATR adaptive"
#property indicator_type4   DRAW_LINE
#property indicator_color4  clrYellow
#property indicator_width4  2
#property indicator_label5  "ATR Upper Band"
#property indicator_type5   DRAW_LINE
#property indicator_color5  clrOrange
#property indicator_label6  "ATR Lower Band"
#property indicator_type6   DRAW_LINE
#property indicator_color6  clrOrange
#property strict

//
//
//

input int                inpMaPeriod = 25;          // SMA period
input ENUM_APPLIED_PRICE inpPrice    = PRICE_CLOSE; // Price
enum enColorMode
  {
   col_onSlope, // Change color on slope change
   col_onCross, // Change color on two sma cross
  };
input enColorMode        inpColorMode = col_onCross; // Color change mode
input double InpBandsDeviations = 1.0;
double val[],valda[],valdb[],valc[],sma[],atr[],ExtStdDevBuffer[],ExtUpperBuffer[],ExtLowerBuffer[];

//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
int OnInit()
  {
   IndicatorBuffers(9);
   IndicatorDigits(Digits+1);
   SetIndexBuffer(0,sma,INDICATOR_DATA);
   SetIndexBuffer(1,val,INDICATOR_DATA);
   SetIndexBuffer(2,valda,INDICATOR_DATA);
   SetIndexBuffer(3,valdb,INDICATOR_DATA);
   SetIndexBuffer(4,ExtUpperBuffer,INDICATOR_DATA);
   SetIndexBuffer(5,ExtLowerBuffer,INDICATOR_DATA);
   SetIndexBuffer(6,valc,INDICATOR_COLOR_INDEX);
   SetIndexBuffer(7,atr,INDICATOR_CALCULATIONS);
   SetIndexBuffer(8,ExtStdDevBuffer,INDICATOR_CALCULATIONS);

   IndicatorSetString(INDICATOR_SHORTNAME,"ATR adaptive SMA ("+(string)inpMaPeriod+")");
   return (INIT_SUCCEEDED);
  }
void OnDeinit(const int reason) { }

//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
int OnCalculate(const int rates_total,const int prev_calculated,const datetime &time[],
                const double &open[],
                const double &high[],
                const double &low[],
                const double &close[],
                const long &tick_volume[],
                const long &volume[],
                const int &spread[])
  {
   int pos,r,i,limit = rates_total-prev_calculated;
   if(limit>=rates_total-1)
      limit = rates_total-1;

   if(prev_calculated>1)
      pos=prev_calculated-1;
   else
      pos=0;

   if(prev_calculated<1)
     {
      for(int j=0; j<inpMaPeriod; j++)
        {
         //         ExtMovingBuffer[i]=EMPTY_VALUE;
         //         ExtStdDevBuffer[j]=EMPTY_VALUE;
         ExtUpperBuffer[j]=EMPTY_VALUE;
         ExtLowerBuffer[j]=EMPTY_VALUE;
        }
     }

   struct sWorkStruct
     {
      double         price;
      double         tr;
      double         sumtr;
      double         min;
      double         max;
      double         sum;
      double         sumSma;
      int            period;
      int            prevBar;
                     sWorkStruct() : prevBar(-1), period(INT_MIN) {};
     };
   static sWorkStruct m_work[];
   static int         m_workSize = -1;
   if(m_workSize<=rates_total)
      m_workSize = ArrayResize(m_work,rates_total+100,400);

   if(valc[limit]==1)
      CleanPoint(limit,valda,valdb);
   for(i=limit, r=rates_total-i-1; i>=0 && !_StopFlag; i--,r++)
     {
      m_work[r].price = iMA(_Symbol,_Period,1,0,MODE_SMA,inpPrice,i);;
      m_work[r].tr    = (r>0) ? (high[i]>close[i+1] ? high[i] : close[i+1]) -(low[i]<close[i+1] ? low[i] : close[i+1]) : high[i]-low[i];
      if(r>inpMaPeriod)
        {
         m_work[r].sumSma = m_work[r-1].sumSma + m_work[r].price - m_work[r-inpMaPeriod].price;
         m_work[r].sumtr  = m_work[r-1].sumtr  + m_work[r].tr    - m_work[r-inpMaPeriod].tr;
        }
      else
        {
         m_work[r].sumSma = m_work[r].price;
         for(int k=1; k<inpMaPeriod && r>=k; k++)
            m_work[r].sumSma += m_work[r-k].price;
         m_work[r].sumtr  = m_work[r].tr;
         for(int k=1; k<inpMaPeriod && r>=k; k++)
            m_work[r].sumtr  += m_work[r-k].tr;
        }
      atr[i] = m_work[r].sumtr/(double)inpMaPeriod;
      sma[i] = NormalizeDouble(m_work[r].sumSma/(double)inpMaPeriod,_Digits);

      if(m_work[r  ].prevBar !=r ||
         m_work[r+1].prevBar > r)
        {
         if(inpMaPeriod>1)
           {
            m_work[r].max = atr[ArrayMaximum(atr,inpMaPeriod-1,i)];
            m_work[r].min = atr[ArrayMinimum(atr,inpMaPeriod-1,i)];
           }
         else
           {
            m_work[r].max = -DBL_MAX;
            m_work[r].min = DBL_MAX;
           }
        }

      double _max   = m_work[r].max > atr[i] ? m_work[r].max : atr[i];
      double _min   = m_work[r].min < atr[i] ? m_work[r].min : atr[i];
      double _coeff = (_min!=_max) ? 1-(atr[i]-_min)/(_max-_min) : 0.5;

      int _period = int(inpMaPeriod*(_coeff+1.0)/2.0);
      if(m_work[r  ].prevBar !=r ||
         m_work[r+1].prevBar > r ||
         m_work[r+1].period != _period)
        {
         m_work[r  ].prevBar = r;
         m_work[r+1].prevBar = -1;
         m_work[r+1].period  = _period;
         m_work[r].sum       = 0;
         for(int k=1; k<_period && r>=k; k++)
            m_work[r].sum += m_work[r-k].price;
        }

      val[i]  = (_period>0) ? NormalizeDouble((m_work[r].sum+m_work[r].price)/(double)_period,Digits+1) : m_work[r].price;

      if(inpColorMode==col_onSlope)
         valc[i] = (r>0) ? (val[i]>val[i+1]) ? 2 : (val[i]<val[i+1]) ? 1 : valc[i+1]: 0;
      else
         valc[i] = (val[i]>sma[i]) ? 2 :(val[i]<sma[i]) ? 1 : (r>0) ? valc[i+1]: 0;
      if(valc[i]==1)
         PlotPoint(i,valda,valdb,val);
      else
         valda[i] = valdb[i] = EMPTY_VALUE;

     }

   for(int j=pos; j<rates_total && !IsStopped(); j++)
     {
      //--- calculate and write down StdDev
      ExtStdDevBuffer[j]=StdDev_Func(j,close,val,inpMaPeriod);
      //--- upper line
      ExtUpperBuffer[j]=val[j]+InpBandsDeviations*ExtStdDevBuffer[j];
      //--- lower line
      ExtLowerBuffer[j]=val[j]-InpBandsDeviations*ExtStdDevBuffer[j];
     }
     
   return(rates_total);
  }

//-------------------------------------------------------------------
//
//-------------------------------------------------------------------
void CleanPoint(int i,double& first[],double& second[])
  {
   if(i>=Bars-3)
      return;
   if((second[i]  != EMPTY_VALUE) && (second[i+1] != EMPTY_VALUE))
      second[i+1] = EMPTY_VALUE;
   else
      if((first[i] != EMPTY_VALUE) && (first[i+1] != EMPTY_VALUE) && (first[i+2] == EMPTY_VALUE))
         first[i+1] = EMPTY_VALUE;
  }

//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
void PlotPoint(int i,double& first[],double& second[],double& from[])
  {
   if(i>=Bars-2)
      return;
   if(first[i+1] == EMPTY_VALUE)
      if(first[i+2] == EMPTY_VALUE)
        { first[i]  = from[i]; first[i+1]  = from[i+1]; second[i] = EMPTY_VALUE; }
      else
        {
         second[i] = from[i];
         second[i+1] = from[i+1];
         first[i]  = EMPTY_VALUE;
        }
   else
     {
      first[i]  = from[i];
      second[i] = EMPTY_VALUE;
     }
  }

//+------------------------------------------------------------------+
//|                                                                  |
//+------------------------------------------------------------------+
double StdDev_Func(int position,const double &price[],const double &MAprice[],int period)
  {
//--- variables
   double StdDev_dTmp=0.0;
//--- check for position
   if(position>=period)
     {
      //--- calcualte StdDev
      for(int i=0; i<period; i++)
         StdDev_dTmp+=MathPow(price[position-i]-MAprice[position],2);
      StdDev_dTmp=MathSqrt(StdDev_dTmp/period);
     }
//--- return calculated value
   return(StdDev_dTmp);
  }
//+------------------------------------------------------------------+
```

![AtrSmaBands_strike1](https://c.mql5.com/3/367/atrsmabands.PNG "AtrSmaBands_strike1")

![CCI H MTF Colored](https://c.mql5.com/i/code/indicator.png)
[CCI H MTF Colored](/en/code/30850)

Fully customizable: Period, TimeFrame, Color, and Price.
Above 0: Chartreuse
Below 0: Red
Above 100: Marron
Below -100: Dark Green

![Theil_Sen Indicator Free](https://c.mql5.com/i/code/indicator.png)
[Theil\_Sen Indicator Free](/en/code/30810)

This indicator draws a trend-line directly on a chart. It uses the Theil Sen Estimation method to calculate the slope of the trend-line. Theil–Sen estimation is a method for robustly fitting a line to sample points in the plane (simple linear regression) by choosing the median of the slopes of all lines through pairs of points.

![max profit of 1st order](https://c.mql5.com/i/code/expert.png)
[max profit of 1st order](/en/code/30912)

This expert shows the maximum profit level that touched by price line for your first position on chart window. the expert don't need any variable or specified timeframe. Please vote this program to help know this program how much helpful. Thanks for your vote stars.

![Hull moving average (ema based)](https://c.mql5.com/i/code/indicator.png)
[Hull moving average (ema based)](/en/code/30918)

Hull moving average (ema based)