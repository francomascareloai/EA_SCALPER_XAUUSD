# Moving Average - expert for MetaTrader 4

Source: https://www.mql5.com/en/code/7927

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/7927) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# Moving Average - expert for MetaTrader 4

[MetaQuotes](/en/users/metaquotes)  |
[English](javascript:void(false);)

[Русский](/ru/code/7927) [中文](/zh/code/7927) [Español](/es/code/7927) [Deutsch](/de/code/7927) [日本語](/ja/code/7927) [Português](/pt/code/7927) [한국어](/ko/code/7927) [Français](/fr/code/7927) [Italiano](/it/code/7927) [Türkçe](/tr/code/7927)

Views:
:   81857

Rating:
:   (31)

Published:
:   29 November 2005, 12:04

Updated:
:   21 April 2014, 14:52
:   [Moving\_Average\_TesterGraph2.gif](/en/code/download/7927/Moving_Average_TesterGraph2.gif "Moving_Average_TesterGraph2.gif")
    (3.68 KB)

    [Moving\_Average.mq4](/en/code/download/7927/Moving_Average.mq4 "Moving_Average.mq4")
    (4.63 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/7927.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

The Moving Average expert for forming trade signals uses one moving
average. Opening and closing of positions are performed when the moving
average meets the price at the recently formed bar (bar index equals to
1). The lot size will be optimized according to a special algorithm.

    The expert advisor analyzes concurrence of the moving average and
the market price chart. The checking is performed by the CheckForOpen()
function. If the moving average meets the bar in such a way that the
former is higher than Open price but lower than Close price, the BUY
position will be opened. If the moving average meets the bar in such a
way that the former is lower than Open price but higher than Close
price, the SELL position will be opened.

    Money Management used in the expert is very simple, but effective:
the control over each position volume is performed depending on the
previous transactions results. This algorithm is implemented by the
LotsOptimized() function. The basic lot size is calculated on basis of
the maximum allowable risk:

    lot=NormalizeDouble(AccountFreeMargin()\*MaximumRisk/1000.0,1);

    The MaximumRisk parameter displays the basic risk percentage for
each transaction. It usually possesses a value between 0.01 (1%) and 1
(100%). For example, if free margin (AccountFreeMargin) equals to
$20,500 and rules of capital management prescribe to use risk of 2%,
the basic lot size will make 20500 \* 0.02 / 1000 = 0.41. It is very
important to control over the lot size accuracy and to normalize the
result with the allowable values. Normally, fractional lots with step
of 0.1 are allowed. A transaction having volume of 0.41 will not be
performed. To normalize, the NormalizeDouble() function is used with
accuracy up to 1 character after the point. This results in the basic
lot of 0.4. The basic lot calculation on basis of free margin allows to
increase in volumes of operation depending on trading successfulness,
i.e., to trade with reinvesting. This is the basic mechanism with
obligatory capital management for increasing of trading effeсtiveness.  
  

    DecreaseFactor is the extent to which the lot size will be reduced
after unprofitable trading. Normal values are 2,3,4,5. If the preceding
transactions were unprofitable, the subsequent volumes will decrease by
a factor of DecreaseFactor in order to wait through the unprofitable
period. This is the main factor in the capital management algorithm.
The idea is very simple: if trading is successfully increasing, the
expert works with the basic lot making maximum profit. After the very
first unprofitable transaction, the expert will "reduce the speed"
until a new positive transaction is made. The algorithm allows to
disable "speed reducing", for doing it, one has to specify
DecreaseFactor = 0. The amount of the last successive unprofitable
transactions is calculated in the trade history. The basic lot will be
recalculated on this basis:

    if(losses>1) lot=NormalizeDouble(lot-lot\*losses/DecreaseFactor,1);

   
Thus, the algorithm allows to effectively reduce the risk occurring as
a result of a series of unprofitable transactions.The lot size is
obligatorily checked for the minimum allowable lot
size at the end of the function because the previously made
calculations can result in lot = 0:  
  

    if(lot<0.1) lot=0.1;

    The expert is mainly intended for working with daily period, and in
the testing mode - for doing at close prices. It will trade only at
opening of a new bar, that is why the modes of every-tick modeling are
not needed.   
  
    Testing results are represented in the report.  
  

```mql5
Strategy Tester Report  
  
Moving Average  
  
  

|  |  |
| --- | --- |
| Symbol | EURUSD (Euro vs US Dollar) |
| Period | 1 Hour (H1)  2003.01.08 00:00 - 2003.11.25 00:00 |
| Model | Every tick (based on all available least timeframes with fractal interpolation of every tick) |
| Parameters | Lots=0.1; MaximumRisk=0.01; DecreaseFactor=1; MovingPeriod=16; MovingShift=11; |
|  |
| Bars in test | 19371 | Ticks modelled | 656918 | Modelling quality | 25.00% |
|  |
| Initial deposit | 10000.00 |  |  |  |  |
| Total net profit | 1695.20 | Gross profit | 4293.20 | Gross loss | -2598.00 |
| Profit factor | 1.65 | Expected payoff | 10.80 |  |  |
| Absolute drawdown | 40.35 | Maximal drawdown (%) | 318.50 (3.0%) |  |  |
|  |
| Total trades | 157 | Short positions (won %) | 73 (26.03%) | Long positions (won %) | 84 (32.14%) |
|  | Profit trades (% of total) | 46 (29.30%) | Loss trades (% of total) | 111 (70.70%) |
| Largest | profit trade | 262.55 | loss trade | -91.00 |
| Average | profit trade | 93.33 | loss trade | -23.41 |
| Maximum | consecutive wins (profit in money) | 2 (387.15) | consecutive losses (loss in money) | 7 (-287.25) |
| Maximal | consecutive profit (count of wins) | 387.15 (2) | consecutive loss (count of losses) | -287.25 (7) |
| Average | consecutive wins | 1 | consecutive losses | 3 |
```

Translated from Russian by MetaQuotes Ltd.   
Original code: [https://www.mql5.com/ru/code/7927](/ru/code/7927)

**Last comments |
[Go to discussion](/en/forum/24865)**
(12)

![ghost_jc](https://c.mql5.com/avatar/avatar_na2.png "ghost_jc")

**[ghost\_jc](/en/users/ghost_jc)**
|
4 Apr 2011 at 05:45

hi there,

is it possible to [remove](https://www.mql5.com/en/docs/integration/python_metatrader5/mt5copyratesfrom_py "MQL5 Documentation: copy_rates_from function") the auto-close features?

**-**
|
1 Oct 2011 at 14:17

### see this [scalping EA](https://www.mql5.com/go?link=http://e-bizbox.ru/)

![](https://c.mql5.com/avatar/avatar_na2.png)

**[Deleted]**
|
22 Oct 2011 at 11:41

[![](https://c.mql5.com/3/34/TesterGraph23_small.gif "H1 99% modelling Quality")](https://c.mql5.com/3/34/TesterGraph23.gif)

|  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| Symbol | | EURUSDFXF (Euro vs US Dollar) | | | |
| Period | | 1 Hour (H1) 2007.03.30 17:01 - 2011.09.30 00:59 (2007.03.01 - 2011.06.20) | | | |
| Model | | Every tick (the most precise method based on all available least timeframes) | | | |
| Parameters | | Lots=0.1; MaximumRisk=0.02; DecreaseFactor=3; MovingPeriod=12; MovingShift=6; | | | |
| |  |  |  |  |  |  | | --- | --- | --- | --- | --- | --- | | Bars in test | 28117 | Ticks modelled | 34632921 | Modelling quality | 99.00% | | Mismatched charts errors | 0 |  |  |  |  | |  | | | | | | | Initial deposit | 10000.00 |  |  |  |  | | Total net profit | 2786.20 | Gross profit | 71494.00 | Gross loss | -68707.80 | | Profit factor | 1.04 | Expected payoff | 1.26 |  |  | | Absolute drawdown | 600.60 | Maximal drawdown | 3375.60 (24.72%) | Relative drawdown | 24.72% (3375.60) | |  | | | | | | | Total trades | 2205 | Short positions (won %) | 1102 (25.50%) | Long positions (won %) | 1103 (28.92%) | |  | | Profit trades (% of total) | 600 (27.21%) | Loss trades (% of total) | 1605 (72.79%) | | Largest | | profit trade | 1155.60 | loss trade | -1006.80 | | Average | | profit trade | 119.16 | loss trade | -42.81 | | Maximum | | consecutive wins (profit in money) | 6 (353.40) | consecutive losses (loss in money) | 18 (-650.40) | | Maximal | | consecutive profit (count of wins) | 1170.00 (4) | consecutive loss (count of losses) | -1280.80 (9) | | Average | | consecutive wins | 1 | consecutive losses | 4 | | |

![](https://c.mql5.com/avatar/avatar_na2.png)

**[Deleted]**
|
22 Oct 2011 at 11:48

[![](https://c.mql5.com/3/34/TesterGraph99_small.gif)](https://c.mql5.com/3/34/TesterGraph99.gif)

DIFFERENT SETTINGS - LIKE THE ONES METAQUOTES USED

|  |  |  |  |  |  |
| --- | --- | --- | --- | --- | --- |
| Symbol | | EURUSDFXF (Euro vs US Dollar) | | | |
| Period | | 1 Hour (H1) 2007.03.30 17:01 - 2011.09.30 00:59 (2007.03.01 - 2011.06.20) | | | |
| Model | | Every tick (the most precise method based on all available least timeframes) | | | |
| Parameters | | Lots=0.1; MaximumRisk=0.01; DecreaseFactor=1; MovingPeriod=16; MovingShift=11; | | | |
| |  |  |  |  |  |  | | --- | --- | --- | --- | --- | --- | | Bars in test | 28117 | Ticks modelled | 34632921 | Modelling quality | 99.00% | | Mismatched charts errors | 0 |  |  |  |  | |  | | | | | | | Initial deposit | 1000000.00 |  |  |  |  | | Total net profit | -424287.00 | Gross profit | 1015708.80 | Gross loss | -1439995.80 | | Profit factor | 0.71 | Expected payoff | -272.50 |  |  | | Absolute drawdown | 426566.80 | Maximal drawdown | 445606.40 (43.73%) | Relative drawdown | 43.73% (445606.40) | |  | | | | | | | Total trades | 1557 | Short positions (won %) | 778 (21.34%) | Long positions (won %) | 779 (29.40%) | |  | | Profit trades (% of total) | 395 (25.37%) | Loss trades (% of total) | 1162 (74.63%) | | Largest | | profit trade | 101270.40 | loss trade | -36944.00 | | Average | | profit trade | 2571.41 | loss trade | -1239.24 | | Maximum | | consecutive wins (profit in money) | 4 (17427.00) | consecutive losses (loss in money) | 23 (-2310.40) | | Maximal | | consecutive profit (count of wins) | 129294.80 (3) | consecutive loss (count of losses) | -44613.40 (4) | | Average | | consecutive wins | 1 | consecutive losses | 4 | | |

![broketrader](https://c.mql5.com/avatar/avatar_na2.png "broketrader")

**[broketrader](/en/users/broketrader)**
|
26 Feb 2014 at 10:31

No comment.

[![](https://c.mql5.com/3/34/avg_small.png)](https://c.mql5.com/3/34/avg.png)

![Send Pending Order](https://c.mql5.com/i/code/script.png)
[Send Pending Order](/en/code/7920)

The script sends SELL STOP pending order with expiration data and printing number of ticket.

![Modify Pending Order](https://c.mql5.com/i/code/script.png)
[Modify Pending Order](/en/code/7918)

Modify pending order - script choosing first in list pending order, printing selected pending order data, modifying pending order and printing pending order data after modification.

![Period Converter](https://c.mql5.com/i/code/script.png)
[Period Converter](/en/code/7936)

Use this script to make own nonstandard timeframes.

![Period Converter Optimized](https://c.mql5.com/i/code/indicator.png)
[Period Converter Optimized](/en/code/7673)

Improved period converter support real-time refreshing, low CPU cost and other features.