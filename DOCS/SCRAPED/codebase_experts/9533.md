# EnvelopeMA version 0.0.1.beta - expert for MetaTrader 4

Source: https://www.mql5.com/en/code/9533

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/en/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/en/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Experts](/en/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Indicators](/en/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Scripts](/en/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Libraries](/en/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Storage](/en/code/storage)

Watch [how to download](https://youtu.be/rloNyFVtHuA?list=PLltlMLQ7OLeKwyQwC8FhiKwjl9syKhOCK) trading robots for free

Find us on [Facebook](https://www.facebook.com/mql5.community/)!  
 Join our fan page

Interesting script?  
So post a [link](/en/code/9533) to it -  
let others appraise it

You liked the script? Try it in the [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/mt5setup.exe?utm_source=www.mql5.com&utm_campaign=download) terminal

[to pocket](#pocket "Pocket allows you to insert a complete content description to the appropriate comment")

![Experts](https://c.mql5.com/i/code/expert.png)

# EnvelopeMA version 0.0.1.beta - expert for MetaTrader 4

[Cassio Jandir Pagnoncelli](/en/users/kimble9t)

Views:
:   16237

Rating:
:   (2)

Published:
:   8 March 2010, 09:03

Updated:
:   21 April 2014, 14:54
:   [EnvelopeMA.mq4](/en/code/download/9533/EnvelopeMA.mq4 "EnvelopeMA.mq4")
    (8.74 KB)
    [view](# "view")

    [Download as ZIP](/en/code/download/9533.zip "Download all attachments in the single ZIP archive") [How to download code from MetaEditor](https://www.metatrader5.com/en/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Language of trade strategies built-in the MetaTrader 5 client terminal](https://c.mql5.com/i/registerlandings/logo-2.png)

    You are missing trading opportunities:

    * Free trading apps
    * Over 8,000 signals for copying
    * Economic news for exploring financial markets

    Registration
    Log in

    latin characters without spaces

    a password will be sent to this email

    An error occurred

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    You agree to [website policy](/en/about/privacy) and [terms of use](/en/about/terms)

    If you do not have an account, please [register](https://www.mql5.com/en/auth_register)

    Allow the use of cookies to log in to the MQL5.com website.

    Please enable the necessary setting in your browser, otherwise you will not be able to log in.

     

    [Forgot your login/password?](https://www.mql5.com/en/auth_forgotten?return=popup)

    * [Log in With Google](https://www.mql5.com/en/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Freelance](https://c.mql5.com/i/code/icon_freelance.svg)
    Need a robot or indicator based on this code? Order it on Freelance
    [Go to Freelance](/en/job/new "Go to Freelance")

Hi folks,

I've been learning and making EAs from 2 months, this one is my first reasonable and "almost-free of errors" robot. It only shorts (no long positions till now), when short positions are clearly good a long position version will be cloned and attached to the EA.
It was made for 15-minute chart (M15) because there are no many sell stop positions executed to place it on higher periods (M30, H1+) and no lower periods because the spread becomes more significantly.
Entry is made by sell stop pending orders placed whenever the Ask price and two moving averages are comprised by the low period envelope bands, this order stands for 1h15min.
Exits when three different Parabolic SAR points are under the Ask price and there is a crossover of moving averages (signal moving average crosses fast moving average from down to up).

S/L and T/P are configurable and optional.
Obviously there are ways to turn this system a great winner using Martingale strategy but the main idea now is to improve only the sell signals. After this, we will attach risk management modules, better exit ways, etc.
I hope you don't mind code is in Portuguese. Some explanations of input parameters are below:

* AguardaCompletarCandle: Wait for 15-minute chart bar is completed to take a decision (is equivalent to use "Open bar prices only" in tester)
* TP: Take Profit (in pips)
* SL: Stop Loss (in pips)
* PerEnv: Period of envelope
* sdEnv: Deviation of envelope
* PerMM: Period of signal exponential moving average
* PerMMl: Period of fast (slower than signal) exponential moving average

other input parameters are explained in "input parameter" box in the tester and it's part of risk management, not about order placing.

I hope you enjoy and whenever someone leave good idea(s) they will be implemented and be made available here.

**Last comments |
[Go to discussion](/en/forum/27276)**
(3)

![William Roeder](https://c.mql5.com/avatar/2016/12/584F20BE-8336.png "William Roeder")

**[William Roeder](/en/users/whroeder1)**
|
8 Mar 2010 at 23:50

```mql5
   for ( i=0; i<OrdersTotal(); i++ )
      if ( OrderSelect(0, SELECT_BY_POS, MODE_TRADES) && OrderCloseTime() == 0 && Op == OrderType() )
         OrderClose(OrderTicket(),
```

With MODE\_TRADES you only get open orders so OrderCloseTime will always be zero (unnecessary test)

When you close an order higher numbered orders are renumbered, so the above code will close every other open order, not all orders. Always count DOWN when closing and modifying lot sizes (partial close.)

```mql5
MargemLivre/100000  
tam_lote >= 0.01  
Preco + Pips*Point
```

Hard coded numbers means the EA fails on a mini account (get values from MarketInfo)

Pips\*Point fails on 5 digit brokers Pips\*pips2dbl won't:

```mql5
//++++ These are adjusted for 5 digit brokers.
double  pips2points,    // slippage  3 pips    3=points    30=points
        pips2dbl;       // Stoploss 15 pips    0.0015      0.00150
int     Digits.pips;    // DoubleToStr(dbl/pips2dbl, Digits.pips)
int init() {
    if (Digits == 5 || Digits == 3) {   // Adjust for five (5) digit brokers.
                pips2dbl    = Point*10; pips2points = 10;   Digits.pips = 1;
    } else {    pips2dbl    = Point;    pips2points =  1;   Digits.pips = 0; }
```

![](https://c.mql5.com/avatar/avatar_na2.png)

**[Deleted]**
|
10 Mar 2010 at 16:52

**WHRoeder:**  

```mql5
   for ( i=0; i<OrdersTotal(); i++ )
      if ( OrderSelect(0, SELECT_BY_POS, MODE_TRADES) && OrderCloseTime() == 0 && Op == OrderType() )
         OrderClose(OrderTicket(),
```

With MODE\_TRADES you only get open orders so OrderCloseTime will always be zero (unnecessary test)

When you close an order higher numbered orders are renumbered, so the above code will close every other open order, not all orders. Always count DOWN when closing and modifying lot sizes (partial close.)

```mql5
MargemLivre/100000
tam_lote >= 0.01
Preco + Pips*Point
```

Hard coded numbers means the EA fails on a mini account (get values from MarketInfo)

Pips\*Point fails on 5 digit brokers Pips\*pips2dbl won't:

```mql5
//++++ These are adjusted for 5 digit brokers.
double  pips2points,    // slippage  3 pips    3=points    30=points
        pips2dbl;       // Stoploss 15 pips    0.0015      0.00150
int     Digits.pips;    // DoubleToStr(dbl/pips2dbl, Digits.pips)
int init() {
    if (Digits == 5 || Digits == 3) {   // Adjust for five (5) digit brokers.
                pips2dbl    = Point*10; pips2points = 10;   Digits.pips = 1;
    } else {    pips2dbl    = Point;    pips2points =  1;   Digits.pips = 0; }
```

Dear sir

No orders are executed in my platform, but only shows the [pending orders](https://www.mql5.com/en/docs/constants/tradingconstants/orderproperties#enum_order_type "MQL5 documentation:"), don't know the reason why .

  
  

In which place the above correction to be replaced in the EA ? thank you

![Cassio Jandir Pagnoncelli](https://c.mql5.com/avatar/avatar_na2.png "Cassio Jandir Pagnoncelli")

**[Cassio Jandir Pagnoncelli](/en/users/kimble9t)**
|
31 Mar 2010 at 07:35

I'm very thankful for your comments, I'll be adjusting the EA as soon as I have free time and translate to english version.   
  
Also, lot size module is not good, some reasons:   
1) extreme lot sizes are not well calculated, no minimum margin level relevance;   
2) lot size is intended to work only on ABCXYZ pairs, where ABC is [account currency](https://www.mql5.com/en/docs/constants/environment_state/accountinformation#enum_account_info_string "MQL5 documentation: Account Properties") and XYZ is another currency;  
3) only 1:100 leverage accounts;  
4) no metals for trading while lot sizes calculated are very wrong;  
  
I'm working hard on risk management modules, soon I'll send you a enhanced version of the robot.  
  
  
Have a nice week,

![Multi Moving Average v2](https://c.mql5.com/i/code/indicator.png)
[Multi Moving Average v2](/en/code/9508)

Multi Moving Average v2 - is a new version of the indicator Multi Moving Average.

![Accu Dist for a single currency](https://c.mql5.com/i/code/indicator.png)
[Accu Dist for a single currency](/en/code/9529)

In this field give a brief description of your script (1-2 sentences).

![Universal trailing stop ](https://c.mql5.com/i/code/expert.png)
[Universal trailing stop](/en/code/9530) 

Trailing can be carried out using the fractals, the extremal bars in the past or using the specified number of points. Can run as a single Expert Advisor or a script, together with any Expert Advisor.

![Instrument ](https://c.mql5.com/i/code/indicator.png)
[Instrument](/en/code/9545) 

Displaying of candles of any instrument of any period.