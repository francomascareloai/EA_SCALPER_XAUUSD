# HistoryTicks - библиотека для MetaTrader 4

Source: https://www.mql5.com/en/code/20298

* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 5](/ru/code/mt5)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Советники](/ru/code/mt5/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Индикаторы](/ru/code/mt5/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Скрипты](/ru/code/mt5/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Библиотеки](/ru/code/mt5/libraries)
* [![](https://c.mql5.com/i/sidebar/mt.svg)MetaTrader 4](/ru/code/mt4)
  + [![](https://c.mql5.com/i/sidebar/expert.svg)Советники](/ru/code/mt4/experts)
  + [![](https://c.mql5.com/i/sidebar/indicator.svg)Индикаторы](/ru/code/mt4/indicators)
  + [![](https://c.mql5.com/i/sidebar/scripts.svg)Скрипты](/ru/code/mt4/scripts)
  + [![](https://c.mql5.com/i/sidebar/library.svg)Библиотеки](/ru/code/mt4/libraries)

* [![](https://c.mql5.com/i/sidebar/storage.svg)Хранилище](/ru/code/storage)

Смотри, [как бесплатно скачать](https://youtu.be/vlobaVbugzQ?list=PLltlMLQ7OLeJtk0k1TFjU6eHAwqfQpcFs) роботов

Ищи нас в [Facebook](https://www.facebook.com/mql5.community/)!  
 Ставь лайки и следи за новостями

Интересный скрипт?  
Поставь на него [ссылку](/ru/code/20298) - пусть другие тоже оценят

Понравился скрипт?  
Оцени его работу в терминале [MetaTrader 5](https://download.mql5.com/cdn/web/metaquotes.ltd/mt5/MetaTrader5.pkg.zip?utm_source=www.mql5.com&utm_campaign=download)

[в карман](#pocket "Через Карман вы можете вставить полное описание этого содержимого в редактор сообщений")

![Библиотеки](https://c.mql5.com/i/code/library.png)

# HistoryTicks - библиотека для MetaTrader 4

[fxsaber](/ru/users/fxsaber)

Просмотров:
:   5654

Рейтинг:
:   (17)

Опубликован:
:   29 марта 2018, 11:09

Обновлен:
:   10 апреля 2021, 13:31
:   \MQL4\Include\

    [TypeToBytes.mqh](/ru/code/download/20298/typetobytes.mqh "TypeToBytes.mqh")
    (20.54 KB)
    [просмотр](# "просмотр")

    \MQL4\Include\fxsaber\HistoryTicks\

    [Array.mqh](/ru/code/download/20298/array.mqh "Array.mqh")
    (1.04 KB)
    [просмотр](# "просмотр")

    [Data\_String.mqh](/ru/code/download/20298/data_string.mqh "Data_String.mqh")
    (1.2 KB)
    [просмотр](# "просмотр")

    [Resource.mqh](/ru/code/download/20298/resource.mqh "Resource.mqh")
    (0.64 KB)
    [просмотр](# "просмотр")

    [ResourceData.mqh](/ru/code/download/20298/resourcedata.mqh "ResourceData.mqh")
    (1.88 KB)
    [просмотр](# "просмотр")

    [Convert.mqh](/ru/code/download/20298/convert.mqh "Convert.mqh")
    (3.63 KB)
    [просмотр](# "просмотр")

    [ArrayResize.mqh](/ru/code/download/20298/arrayresize.mqh "ArrayResize.mqh")
    (7.56 KB)
    [просмотр](# "просмотр")

    [HistoryTicks.mqh](/ru/code/download/20298/historyticks.mqh "HistoryTicks.mqh")
    (8.6 KB)
    [просмотр](# "просмотр")

    \MQL4\Indicators\

    [HistoryTicks.mq4](/ru/code/download/20298/historyticks.mq4 "HistoryTicks.mq4")
    (14.85 KB)
    [просмотр](# "просмотр")

    [Развернуть (9)](javascript:void(false))
    [Свернуть (9)](javascript:void(false))

    [Загрузить ZIP](/ru/code/download/20298.zip "Загрузить все вложения в одном ZIP-архиве") [Как загрузить код из редактора MetaEditor](https://www.metatrader5.com/ru/metaeditor/help/workspace/toolbox#codebase)

    ![MQL5 - Язык торговых стратегий для клиентского терминала MetaTrader 5](https://c.mql5.com/i/registerlandings/logo-2.png)

    Вы упускаете торговые возможности:

    * Бесплатные приложения для трейдинга
    * 8 000+ сигналов для копирования
    * Экономические новости для анализа финансовых рынков

    Регистрация
    Вход

    латиницей и без пробелов

    пароль придет на email

    Произошла ошибка

    * [Войти через Google](https://www.mql5.com/ru/auth_oauth2?provider=Google&amp;return=popup&amp;reg=1)

    Вы принимаете [политику сайта](/ru/about/privacy) и [условия использования](/ru/about/terms)

    Если у вас нет учетной записи, [зарегистрируйтесь](https://www.mql5.com/ru/auth_register)

    Для авторизации и пользования сайтом MQL5.com необходимо разрешить использование файлов Сookie.

    Пожалуйста, включите в вашем браузере данную настройку, иначе вы не сможете авторизоваться.

     

    [Забыли логин/пароль?](https://www.mql5.com/ru/auth_forgotten?return=popup)

    * [Войти через Google](https://www.mql5.com/ru/auth_oauth2?provider=Google&amp;return=popup)
:   ![MQL5 Фриланс](https://c.mql5.com/i/code/icon_freelance.svg)
    Нужен робот или индикатор на основе этого кода? Закажите его на бирже фрилансеров
    [Перейти на биржу](/ru/job/new "Перейти на биржу")

Советники в MetaTrader 4 пропускают тики, пришедшие в во время любых пауз: выполнение торговых приказов, вычисления, ожидание и т.д. Такая потеря информации может привести к серьезному искажению заложенной логики в ТС. Особенно для ТС, где используется анализ Ask-цен, спред и т.д.

Например, стандартное написание MetaTrader 4 советника не позволяет гарантированно выяснить OHLC-Ask для текущего бара, даже если советник был запущен до начала его формирования.

Данная библиотека/инструментарий позволяет наделить любой советник информацией о прошедших тиках между соседними [NewTick-событиями](/ru/docs/runtime/event_fire#newtick "Справочник MQL5 → Программы MQL5 → События клиентского терминала: NewTick") - вызовы [OnTick()](/ru/docs/basis/function/events#ontick "Справочник MQL5 → Основы языка → Функции → Функции обработки событий: OnTick"). Для этого нужно в начале исходника прописать следующую строку:

```mql5
#include <fxsaber\HistoryTicks\HistoryTicks.mqh> // Библиотека доступа советников к прошедшим тикам
```

### Пример

В качестве демонстрации описанной возможности приложен советник, из кода которого хорошо видна логика происходящего.

```mql5
#property strict

#include <fxsaber\HistoryTicks\HistoryTicks.mqh> // Библиотека доступа советников к прошедшим тикам

#define TOSTRING(A) #A + " = " + (string)(A) + " "

void OnTick()
{
  static int Num = 0;
  
  // Распечатываем все тики, что пришли во время выполнения предыдущей OnTick
  for (int i = 0; i < ArraySize(LastTicks); i++)  
    Print(TOSTRING(Num++) + TOSTRING(LastTicks[i].time) + TOSTRING(LastTicks[i].bid) + TOSTRING(LastTicks[i].ask));
    
  Print(TOSTRING(ArraySize(HistoryTicks))); // Количество всего сохраненных тиков за время работы советника
    
  Sleep(10000); // Несмотря на длительную паузу, накопление тиков для следующей OnTick будет происходить
}
```

В коде видно, что стали доступны два тиковых массива:

* **HistoryTicks** - все тики с момента запуска советника;
* **LastTicks** - все тики с момента последнего события NewTick.

### Индикатор

Работа таких советников возможна только при условии, что будет запущен индикатор **HistoryTicks**. Иначе на каждом тике любой такой советник будет выдавать следующее предупреждение:

```mql5
2018.03.26 00:05:14.924 HistoryTicks_Example EURGBP,M1: Run the HistoryTicks_EURGBP-indicator!!!
```

Этот приложенный индикатор и транслирует получаемые им тики во все советники своего символа. Индикатор следит за тем, чтобы не было запущено несколько его копий на одном и том же символе. Также при его удалении с графика сохраняет все накопленные тики в соответствующий файл песочницы терминала.

### Использование

В итоге алгоритм работы **с модифицированными строкой** советниками следующий (на примере EURUSD):

* Запустить индикатор HistoryTicks на любом графике EURUSD;
* Запустить советники на любых графиках EURUSD.

Теперь на каждом вызове OnTick можно прогонять в цикле логику ТС через все тики (массив LastTicks), будучи уверенным в отсутствии пропусков, а так же в OnTick достучаться до любого тика (с момента запуска советника) через массив HistoryTicks.

### Особенности

* Используется библиотека [TypeToBytes](/ru/code/16280 "TypeToBytes - библиотека для MetaTrader 5");
* Модифицированные таким образом (одна строка) советники будут работать только на Реал/Демо-счетах;
* Чтобы советник работал в Тестере Стратегий, упомянутую строку нужно закомментировать;
* В исходниках есть кроссплатформенные функции (файл **Data\_String.mqh**), которые позволяют помещать/извлекать любые данные в/из строки. Например, это дает возможность производить удобный обмен произвольными данным между любыми MQL-программами за счет string-параметра (sparam) [пользовательских событий](/ru/docs/eventfunctions/eventchartcustom "Справочник MQL5 → Работа с событиями → EventChartCustom");
* Данная библиотека может служить ядром для написания MQL4-варианта функции [CopyTicks](/ru/docs/series/copyticks "Справочник MQL5 → Доступ к таймсериям и индикаторам → CopyTicks"), что вместе с другими решениями двигает код к еще большей кроссплатформенности;
* В MetaTrader 5 из-за штатного MQL-доступа к тиковой истории смысл в таком дополнительном функционале отсутствует (хоть предложенное **LastTicks**-решение и видится более удобным). Однако, представленный подход к обмену различными данными может быть актуален и для MetaTrader 5;
* Замер скорости показал, что подобные решения вызывают задержку в несколько микросекунд, редко давая всплески до нескольких единиц миллисекунд. Поэтому вопрос производительности предложенного инструментария остро не встает;
* Передача данных идет через нулевое пользовательское событие ([id == CHARTEVENT\_CUSTOM](/ru/docs/basis/function/events#onchartevent "Справочник MQL5 → Основы языка → Функции → Функции обработки событий: OnChartEvent")). При необходимости изменить номер события потребуется править исходник;
* Тики в соответствующих массивах расположены от более ранних/старых к более поздним/свежим. Последний тик - конец массива.

**Последние комментарии |
[Перейти к обсуждению на форуме трейдеров](/ru/forum/233647)**
(30)

![traveller00](https://c.mql5.com/avatar/avatar_na2.png "traveller00")

**[traveller00](/ru/users/traveller00)**
|
29 мар. 2020 в 23:28

**fxsaber:**  

Эта часть не использовалась, т.к. в индикаторах запрещена [WebRequest](/ru/docs/network/webrequest "MQL5 документация: Функция WebRequest").

А вообще эта часть юзабельная для тиковых данных? Ибо по линку, который он использует, можно слить данные таймфреймов только. А для
тиковых похоже только архив, с которым ThirdPartyTicks работает. Или через эту веб-морду и тиковые можно?

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
30 мар. 2020 в 01:50

**traveller00:**  

А вообще эта часть юзабельная для тиковых данных?

Да. Но проще в MT5.

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
10 апр. 2021 в 13:37

Обновлен в целом инструментарий. Результат ускорений на VPS, неочевидные названия символов и т.д.

И, в частности, обновлена кроссплатформенная [библиотека ArrayResize](/ru/forum/233647/page2#comment_9831230) из-за [недавних изменений в MT5](/ru/forum/363680).

![EvPaul](https://c.mql5.com/avatar/avatar_na2.png "EvPaul")

**[EvPaul](/ru/users/evpaul)**
|
19 авг. 2021 в 13:04

В МТ4 индикатор моментально выгружается с сообщением global inizialization failed.

Что не так?

![fxsaber](https://c.mql5.com/avatar/2019/8/5D67260D-44C9.png "fxsaber")

**[fxsaber](/ru/users/fxsaber)**
|
19 авг. 2021 в 13:15

**EvPaul:**  

В МТ4 индикатор моментально выгружается с сообщением global inizialization failed.

Что не так?

Видимо, [в этом причина](/ru/forum/373986/page2#comment_23712631).

![VR Smart Grid Lite](https://c.mql5.com/i/code/expert.png)
[VR Smart Grid Lite](/ru/code/20223)

Стратегия частичного усреднения и закрытия сети ордеров против тренда.

![NYBOT Index](https://c.mql5.com/i/code/indicator.png)
[NYBOT Index](/ru/code/20167)

Формула расчета индикатора соответствует индексу NYBOT (New York Board of Trade). Это индекс доллара по корзине из шести тех валют, чьи страны образуют наибольший внешнеторговый оборот США.

![RenkoOneBuffer](https://c.mql5.com/i/code/indicator.png)
[RenkoOneBuffer](/ru/code/20471)

Индикатор RenkoOneBuffer позволяет отображать графики Ренко в подокне индикатора. Тип графиков Ренко показывает лишь движения цены, большие заданного (box size). Он помогает устранить шум и сосредоточиться на основных трендах.

![DeleteTradeArrows](https://c.mql5.com/i/code/indicator.png)
[DeleteTradeArrows](/ru/code/20557)

Удаляет с графика объекты-стрелки, которыми отмечаются сделки на графике. Утилита реализована в виде индикатора, который сам ничего не рисует.