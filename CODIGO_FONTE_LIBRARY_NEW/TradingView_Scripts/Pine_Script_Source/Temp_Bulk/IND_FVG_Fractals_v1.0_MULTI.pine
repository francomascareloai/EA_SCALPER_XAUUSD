//@version=5
indicator("[FVG+Fractals]", shorttitle = "*FVG+Fractals*", overlay = true, max_lines_count = 500, max_boxes_count = 500)
import TradingView/ta/7
// ========================================================================================================================================================================//
groupFVG = "Настройки FVG"

//Настройка ширины боксов FVG и порога чувствительности
box_width           = input.int(defval = 5, minval = 1, title = "Ширина боксов FVG", group = groupFVG, tooltip = "Ширина боксов FVG")
threshold           = input.int(defval = 0, minval = 0, step = 5, title = "Порог в тиках", tooltip = "Скрыть разрывы fair value gaps (FVG), меньшие чем это количество тиков", group = groupFVG)

isBearishFVG        = low[2]  > high + threshold * syminfo.mintick
isBullishFVG        = high[2] < low  - threshold * syminfo.mintick

bullishColor        = input.color(defval = #2195f34d, title = "Цвет бычьих FVG", group = groupFVG)
bearishColor        = input.color(defval = #ff99004d,  title = "Цвет медвежьих FVG", group = groupFVG)

if barstate.isconfirmed and isBearishFVG
    box.new(bar_index - 2, low[2], bar_index + box_width, high, border_color = color.new(bearishColor, 0), bgcolor = bearishColor)

if barstate.isconfirmed and isBullishFVG
    box.new(bar_index - 2, high[2], bar_index + box_width, low, border_color = color.new(bullishColor, 0), bgcolor = bullishColor)

// ========================================================================================================================================================================//
groupFractals = "Настройки Фракталов"

// Настройки для фракталов
fractalPeriod       = input.int(defval = 1, minval = 1, step = 1, title = "Бары влево/вправо", tooltip = "Количество баров влево/вправо для идентификации вершин и впадин фракталов", group = groupFractals)

bullishFractalColor = input.color(defval = #2195f34d, title = "Цвет фрактала High", group = groupFractals)
bearishFractalColor = input.color(defval = #ff99004d,  title = "Цвет фрактала Low", group = groupFractals)

fractalHigh         = ta.pivothigh(high, fractalPeriod, fractalPeriod)
fractalLow          = ta.pivotlow(low, fractalPeriod, fractalPeriod)

plotshape(fractalHigh, "Фрактал High", style = shape.triangleup, color = bullishFractalColor, offset = -fractalPeriod, location = location.abovebar)
plotshape(fractalLow, "Фрактал Low", style = shape.triangledown, color = bearishFractalColor, offset = -fractalPeriod, location = location.belowbar)
